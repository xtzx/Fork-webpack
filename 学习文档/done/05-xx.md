å¥½çš„ï¼è®©æˆ‘è¯¦ç»†è§£ç­”è¿™ä¸¤ä¸ªå…³é”®é—®é¢˜ï¼š

---

## ğŸ¯ é—®é¢˜1ï¼šç¼–è¯‘å‡†å¤‡ â†’ Make é˜¶æ®µçš„è§¦å‘æœºåˆ¶

### è§¦å‘æ—¶æœºå’Œæ–¹å¼ â­â­â­

```
ç¼–è¯‘å‡†å¤‡é˜¶æ®µå®Œæˆå:
  â†“
lib/Compiler.js: compile() æ–¹æ³•ä¸­
  â†“
const compilation = this.newCompilation(params);
  â†“ Compilation å®ä¾‹å·²åˆ›å»ºå¹¶å°±ç»ª
  â†“
â­â­â­ å…³é”®ï¼šè§¦å‘ make é’©å­
  â†“
this.hooks.make.callAsync(compilation, err => {
  // Make é˜¶æ®µåœ¨è¿™é‡Œæ‰§è¡Œ
  // é’©å­çš„ç›‘å¬å™¨ä¼šè¢«ä¾æ¬¡è°ƒç”¨
});
```

### è¯¦ç»†è§¦å‘æµç¨‹å›¾

```mermaid
graph TD
    Prep[ç¼–è¯‘å‡†å¤‡é˜¶æ®µå®Œæˆ<br/>Compilation å®ä¾‹å·²å°±ç»ª] --> CompileMethod[lib/Compiler.js<br/>compile æ–¹æ³•æ‰§è¡Œä¸­]

    CompileMethod --> Line["ä»£ç è¡Œ:<br/>this.hooks.make.callAsync<br/>  compilation, err"]

    Line --> Trigger[â­ è§¦å‘ make é’©å­<br/>AsyncParallelHook]

    Trigger --> Find[æŸ¥æ‰¾æ‰€æœ‰ç›‘å¬å™¨<br/>è°ç›‘å¬äº† make?]

    Find --> Listener1[ç›‘å¬å™¨1: EntryPlugin<br/>â­â­â­ æœ€é‡è¦]
    Find --> Listener2[ç›‘å¬å™¨2: DllPlugin<br/>DLL æ¨¡å¼]
    Find --> Listener3[ç›‘å¬å™¨3: è‡ªå®šä¹‰æ’ä»¶<br/>ç”¨æˆ·æ’ä»¶]

    Listener1 --> Entry["EntryPlugin æ‰§è¡Œ:<br/>compilation.addEntry<br/>  context<br/>  entryDependency<br/>  options<br/>  callback"]

    Entry --> AddModule["å¼€å§‹æ·»åŠ å…¥å£æ¨¡å—:<br/>â­ Make é˜¶æ®µæ­£å¼å¼€å§‹"]

    AddModule --> MakePhase["Make é˜¶æ®µæ‰§è¡Œ:<br/>â”œâ”€ åˆ›å»ºå…¥å£æ¨¡å—<br/>â”œâ”€ æ„å»ºå…¥å£æ¨¡å—<br/>â”œâ”€ è§£æä¾èµ–<br/>â”œâ”€ é€’å½’æ„å»ºæ‰€æœ‰ä¾èµ–<br/>â””â”€ å»ºç«‹ ModuleGraph"]

    MakePhase --> MakeDone[æ‰€æœ‰æ¨¡å—æ„å»ºå®Œæˆ]

    MakeDone --> Callback[make é’©å­çš„ callback æ‰§è¡Œ]

    Callback --> FinishMake[è§¦å‘ finishMake é’©å­]

    FinishMake --> Next([ä¸‹ä¸€é˜¶æ®µ:<br/>compilation.seal])

    style Trigger fill:#ff9999
    style Listener1 fill:#99ff99
    style MakePhase fill:#ffcc99
```

### å…³é”®ä»£ç ä½ç½®

```javascript
/**
 * lib/Compiler.js: compile() æ–¹æ³•
 */
compile(callback) {
  // 1. åˆ›å»ºå‚æ•°
  const params = this.newCompilationParams();

  // 2. beforeCompile é’©å­
  this.hooks.beforeCompile.callAsync(params, err => {

    // 3. compile é’©å­
    this.hooks.compile.call(params);

    // 4. åˆ›å»º Compilation
    const compilation = this.newCompilation(params);

    const logger = compilation.getLogger("webpack.Compiler");

    // â­â­â­ 5. è§¦å‘ make é’©å­ï¼ˆMake é˜¶æ®µå¼€å§‹ï¼‰
    logger.time("make hook");
    this.hooks.make.callAsync(compilation, err => {
      logger.timeEnd("make hook");
      // Make é˜¶æ®µå®Œæˆ

      // 6. finishMake é’©å­
      this.hooks.finishMake.callAsync(compilation, err => {
        // 7. è¿›å…¥ Seal é˜¶æ®µ
        compilation.seal(callback);
      });
    });
  });
}

/**
 * lib/EntryPlugin.js: apply() æ–¹æ³•
 */
class EntryPlugin {
  apply(compiler) {
    // â­ ç›‘å¬ make é’©å­
    compiler.hooks.make.tapAsync(
      'EntryPlugin',
      (compilation, callback) => {
        // Make é˜¶æ®µçš„æ‰§è¡Œå…¥å£
        const { entry, options, context } = this;
        const dep = EntryPlugin.createDependency(entry, options);

        // â­â­â­ æ·»åŠ å…¥å£æ¨¡å—ï¼ˆMake é˜¶æ®µçœŸæ­£å¼€å§‹ï¼‰
        compilation.addEntry(context, dep, options, err => {
          callback(err);
        });
      }
    );
  }
}
```

---

## ğŸ¯ é—®é¢˜2ï¼šMake é˜¶æ®µçš„å®Œæ•´å·¥ä½œå†…å®¹

### Make é˜¶æ®µæ€»è§ˆ

```
Make é˜¶æ®µçš„æ ¸å¿ƒä»»åŠ¡ï¼š
ä»å…¥å£ä¾èµ–å¼€å§‹ï¼Œé€’å½’æ„å»ºæ‰€æœ‰æ¨¡å—ï¼Œå»ºç«‹å®Œæ•´çš„ ModuleGraph

è¾“å…¥: Compilationï¼ˆç©ºçš„å®¹å™¨å’Œå›¾ï¼‰
è¾“å‡º: ModuleGraphï¼ˆå®Œæ•´çš„ä¾èµ–å›¾ï¼‰

å·¥ä½œå†…å®¹ï¼ˆ7 å¤§ä»»åŠ¡ï¼‰ï¼š
1. âœ… æ·»åŠ å…¥å£æ¨¡å—
2. âœ… åˆ›å»ºæ¨¡å—å®ä¾‹ï¼ˆfactorizeï¼‰
3. âœ… æ·»åŠ æ¨¡å—åˆ°ç¼–è¯‘ï¼ˆå»é‡ï¼‰
4. âœ… æ„å»ºæ¨¡å—ï¼ˆæ‰§è¡Œ loader + è§£æ ASTï¼‰
5. âœ… å»ºç«‹ ModuleGraph è¿æ¥
6. âœ… å¤„ç†æ¨¡å—ä¾èµ–ï¼ˆé€’å½’ï¼‰
7. âœ… å®Œæˆä¾èµ–å›¾æ„å»º
```

### æ–‡å­—ç‰ˆè¯¦ç»†æµç¨‹ â­â­â­

```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Make é˜¶æ®µå¯åŠ¨
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

è§¦å‘: compiler.hooks.make.callAsync(compilation, callback)
  â†“
ç›‘å¬å™¨: EntryPlugin
  â†“
è°ƒç”¨: compilation.addEntry(context, entryDep, options, callback)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ä»»åŠ¡1: æ·»åŠ å…¥å£æ¨¡å— â­â­
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

lib/Compilation.js: addEntry()
  â†“
æ­¥éª¤1: è§„èŒƒåŒ–å…¥å£é€‰é¡¹
  const options = {
    name: 'main',           // å…¥å£åç§°
    runtime: undefined,     // è¿è¡Œæ—¶åç§°
    dependOn: undefined,    // ä¾èµ–çš„å…¶ä»–å…¥å£
    layer: undefined,       // å›¾å±‚
    ...
  }
  â†“
æ­¥éª¤2: è·å–æˆ–åˆ›å»ºå…¥å£æ•°æ®
  let entryData = this.entries.get('main');

  if (!entryData) {
    // é¦–æ¬¡æ·»åŠ 
    entryData = {
      dependencies: [],         // å…¥å£ä¾èµ–åˆ—è¡¨
      includeDependencies: [],  // å¼ºåˆ¶åŒ…å«çš„ä¾èµ–
      options: { name: 'main', ... }
    };
    this.entries.set('main', entryData);
  }

  entryData.dependencies.push(entryDep);  // æ·»åŠ ä¾èµ–
  â†“
æ­¥éª¤3: è§¦å‘ addEntry é’©å­
  this.hooks.addEntry.call(entry, options);
  â†“
æ­¥éª¤4: è°ƒç”¨ addModuleTreeï¼ˆå¼€å§‹æ„å»ºï¼‰â­â­â­
  this.addModuleTree({
    context: '/project',
    dependency: entryDep,  // EntryDependency('./src/index.js')
    contextInfo: { ... }
  }, callback)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ä»»åŠ¡2: æŸ¥æ‰¾ä¾èµ–å·¥å‚ â­â­
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

lib/Compilation.js: addModuleTree()
  â†“
æ­¥éª¤1: éªŒè¯ä¾èµ–å¯¹è±¡
  if (!dependency || !dependency.constructor) {
    throw new Error('Invalid dependency');
  }
  â†“
æ­¥éª¤2: æ ¹æ®ä¾èµ–ç±»å‹æŸ¥æ‰¾å·¥å‚ â­â­â­
  const Dep = dependency.constructor;  // EntryDependency
  const factory = this.dependencyFactories.get(Dep);

  æŸ¥æ‰¾è¿‡ç¨‹:
    dependencyFactories = Map {
      EntryDependency => normalModuleFactory,  // â­ æ‰¾åˆ°äº†
      HarmonyImportDependency => normalModuleFactory,
      CommonJsRequireDependency => normalModuleFactory,
      // ... 100+ æ˜ å°„
    }
  â†“
æ­¥éª¤3: è°ƒç”¨ handleModuleCreation â­â­â­
  this.handleModuleCreation({
    factory: normalModuleFactory,
    dependencies: [entryDep],
    originModule: null,  // å…¥å£æ— æºæ¨¡å—
    context: '/project'
  }, callback)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ä»»åŠ¡3: åˆ›å»ºæ¨¡å—å®ä¾‹ï¼ˆFactorizeï¼‰â­â­â­
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

lib/Compilation.js: handleModuleCreation()
  â†“
è°ƒç”¨é˜Ÿåˆ—:
  this.factorizeModule({
    factory: normalModuleFactory,
    dependencies: [entryDep],
    ...
  }, callback)
    â†“
  factorizeQueue.add(options, callback)
    â†“ é˜Ÿåˆ—å¤„ç†ï¼ˆå¹¶è¡Œåº¦ 100ï¼‰
  _factorizeModule(options, callback)
    â†“
è°ƒç”¨å·¥å‚:
  factory.create({
    contextInfo: { issuer: '', ... },
    resolveOptions: { ... },
    context: '/project',
    dependencies: [entryDep]
  }, (err, result) => {
    // result = {
    //   module: NormalModule å®ä¾‹,
    //   fileDependencies: Set([...]),
    //   contextDependencies: Set([...]),
    //   cacheable: true
    // }
  })
  â†“
å·¥å‚å†…éƒ¨æµç¨‹ï¼ˆlib/NormalModuleFactory.jsï¼‰:

  æ­¥éª¤1: resolve é’©å­ - è§£æè·¯å¾„ â­â­â­
    './src/index.js'
      â†“ enhanced-resolve
    '/project/src/index.js' (ç»å¯¹è·¯å¾„)

  æ­¥éª¤2: åŒ¹é… loader è§„åˆ™ â­â­
    æ£€æŸ¥ module.rules:
      test: /\.js$/ â†’ åŒ¹é… âœ…
      use: ['babel-loader']

    ç»“æœ:
      loaders = [
        { loader: 'babel-loader', options: {...} }
      ]

  æ­¥éª¤3: afterResolve é’©å­ - è§£æå®Œæˆ

  æ­¥éª¤4: åˆ›å»ºæ¨¡å— â­â­â­
    const module = new NormalModule({
      type: 'javascript/auto',
      resource: '/project/src/index.js',
      loaders: [{ loader: 'babel-loader', ... }],
      parser: JavascriptParser,
      generator: JavascriptGenerator,
      resolveOptions: { ... }
    })

  æ­¥éª¤5: module é’©å­ - æ¨¡å—åˆ›å»ºå®Œæˆ

  æ­¥éª¤6: è¿”å›ç»“æœ
    return {
      module: module,
      fileDependencies: Set(['/project/src/index.js']),
      cacheable: true
    }

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ä»»åŠ¡4: æ·»åŠ æ¨¡å—åˆ°ç¼–è¯‘ï¼ˆå»é‡ï¼‰â­â­â­
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

handleModuleCreation ç»§ç»­:
  â†“
è°ƒç”¨é˜Ÿåˆ—:
  this.addModule(module, callback)
    â†“
  addModuleQueue.add(module, callback)
    â†“
  _addModule(module, callback)
    â†“
æ­¥éª¤1: ç”Ÿæˆå”¯ä¸€æ ‡è¯†
  const identifier = module.identifier();
  // 'javascript/auto|/project/src/index.js'
  â†“
æ­¥éª¤2: æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ â­â­â­
  const existing = this._modules.get(identifier);

  if (existing) {
    // âœ… æ¨¡å—å·²å­˜åœ¨ï¼ˆå»é‡ï¼‰
    return callback(null, existing);
  }

  å»é‡åœºæ™¯:
    a.js: import './common.js'  â†’ åˆ›å»º common æ¨¡å—
    b.js: import './common.js'  â†’ æ‰¾åˆ°å·²å­˜åœ¨çš„ common

    ç»“æœ: common.js åªåˆ›å»ºä¸€æ¬¡ â­
  â†“
æ­¥éª¤3: å°è¯•ä»æŒä¹…åŒ–ç¼“å­˜æ¢å¤ â­â­
  this._modulesCache.get(identifier, null, (err, cached) => {
    if (cached) {
      // ä»ç¼“å­˜æ¢å¤
      cached.updateCacheModule(module);
      module = cached;  // ä½¿ç”¨ç¼“å­˜çš„æ¨¡å—

      æ¢å¤çš„å†…å®¹:
        âœ… buildInfoï¼ˆæ„å»ºä¿¡æ¯ï¼‰
        âœ… buildMetaï¼ˆæ„å»ºå…ƒæ•°æ®ï¼‰
        âœ… dependenciesï¼ˆä¾èµ–åˆ—è¡¨ï¼‰
        âœ… hashï¼ˆæ¨¡å—å“ˆå¸Œï¼‰

      å¥½å¤„: è·³è¿‡ loader æ‰§è¡Œå’Œ AST è§£æï¼ˆå¿« 10-100 å€ï¼‰
    }
  })
  â†“
æ­¥éª¤4: æ·»åŠ åˆ°é›†åˆ
  this._modules.set(identifier, module);  // Map æ˜ å°„
  this.modules.add(module);               // Set é›†åˆ
  â†“
æ­¥éª¤5: è¿”å›æ¨¡å—
  callback(null, module);

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ä»»åŠ¡5: å»ºç«‹ ModuleGraph è¿æ¥ â­â­â­
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

handleModuleCreation ç»§ç»­:
  â†“
æ­¥éª¤: å»ºç«‹ä¾èµ–å›¾è¿æ¥
  moduleGraph.setResolvedModule(
    originModule,  // æºæ¨¡å—ï¼ˆè°ä¾èµ–ï¼‰
    dependency,    // ä¾èµ–å¯¹è±¡ï¼ˆä¾èµ–å…³ç³»ï¼‰
    module         // ç›®æ ‡æ¨¡å—ï¼ˆè¢«ä¾èµ–ï¼‰
  )
  â†“
å†…éƒ¨å®ç°ï¼ˆlib/ModuleGraph.jsï¼‰:

  æ­¥éª¤1: åˆ›å»ºè¿æ¥å¯¹è±¡
    const connection = new ModuleGraphConnection(
      originModule: originModule,
      resolvedOriginModule: originModule,
      dependency: dependency,
      module: module,
      resolvedModule: module,
      active: true
    )

  æ­¥éª¤2: å»ºç«‹åŒå‘è¿æ¥ â­â­â­
    // è·å–æˆ–åˆ›å»ºæºæ¨¡å—çš„å›¾èŠ‚ç‚¹
    const originModuleGraphModule =
      this._getOrCreateModuleGraphModule(originModule);

    // è·å–æˆ–åˆ›å»ºç›®æ ‡æ¨¡å—çš„å›¾èŠ‚ç‚¹
    const targetModuleGraphModule =
      this._getOrCreateModuleGraphModule(module);

    // æ·»åŠ å‡ºè¾¹ï¼ˆorigin â†’ targetï¼‰
    originModuleGraphModule.outgoingConnections.add(connection);

    // æ·»åŠ å…¥è¾¹ï¼ˆtarget â† originï¼‰
    targetModuleGraphModule.incomingConnections.add(connection);

  æ­¥éª¤3: å»ºç«‹ä¾èµ–æ˜ å°„
    this._dependencyMap.set(dependency, connection);

    ä½œç”¨: é€šè¿‡ä¾èµ–å¯¹è±¡å¿«é€Ÿæ‰¾åˆ°è¿æ¥

  æ­¥éª¤4: è®¾ç½®å¼•å…¥è€…ï¼ˆissuerï¼‰
    moduleGraph.setIssuerIfUnset(
      module,
      originModule  // è°ç¬¬ä¸€æ¬¡å¼•å…¥äº†è¿™ä¸ªæ¨¡å—
    )

    ç”¨é€”: é”™è¯¯æŠ¥å‘Šæ—¶æ˜¾ç¤ºå¼•ç”¨é“¾

ç»“æœ:
  ModuleGraph ä¸­å»ºç«‹äº†è¿æ¥:
    index.js --[HarmonyImportDep]--> app.js

  æ•°æ®ç»“æ„:
    _moduleMap = WeakMap {
      index.js => {
        outgoingConnections: Set([conn1]),  // index â†’ app
        incomingConnections: Set([]),       // æ— ï¼ˆå…¥å£ï¼‰
      },
      app.js => {
        outgoingConnections: Set([]),
        incomingConnections: Set([conn1]),  // index â†’ app
      }
    }

    _dependencyMap = WeakMap {
      HarmonyImportDep('./app.js') => conn1
    }

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ä»»åŠ¡6: æ„å»ºæ¨¡å—ï¼ˆæœ€è€—æ—¶ï¼ï¼‰â­â­â­
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

handleModuleCreation ç»§ç»­:
  â†“
è°ƒç”¨: _handleModuleBuildAndDependencies()
  â†“
è°ƒç”¨é˜Ÿåˆ—:
  this.buildModule(module, callback)
    â†“
  buildQueue.add(module, callback)
    â†“ é˜Ÿåˆ—å¤„ç†ï¼ˆå¹¶è¡Œåº¦ 100ï¼‰
  _buildModule(module, callback)
    â†“
æ­¥éª¤1: æ£€æŸ¥æ˜¯å¦éœ€è¦æ„å»º â­â­
  module.needBuild({
    compilation: this,
    fileSystemInfo: this.fileSystemInfo
  }, (err, needBuild) => {

    needBuild çš„åˆ¤æ–­é€»è¾‘:
      æ£€æŸ¥1: æ–‡ä»¶æ—¶é—´æˆ³æ˜¯å¦å˜åŒ–
        buildInfo.timestamp vs å½“å‰æ–‡ä»¶æ—¶é—´

      æ£€æŸ¥2: ä¾èµ–æ–‡ä»¶æ˜¯å¦å˜åŒ–
        buildInfo.fileDependencies ä¸­çš„æ–‡ä»¶æ—¶é—´

      æ£€æŸ¥3: é…ç½®æ˜¯å¦å˜åŒ–
        buildInfo.hash vs å½“å‰é…ç½® hash

      ç»“æœ:
        - éƒ½æœªå˜åŒ– â†’ needBuild = falseï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰â­
        - æœ‰å˜åŒ– â†’ needBuild = trueï¼ˆé‡æ–°æ„å»ºï¼‰

    å¢é‡ç¼–è¯‘çš„å…³é”® â­â­:
      watch æ¨¡å¼ä¸‹ï¼Œå¤§éƒ¨åˆ†æ¨¡å— needBuild = false
      åªé‡å»ºå˜åŒ–çš„æ¨¡å—ï¼Œé€Ÿåº¦å¿« 10-100 å€
  })
  â†“
æ­¥éª¤2: å¦‚æœä¸éœ€è¦æ„å»º
  this.hooks.stillValidModule.call(module);
  return callback();  // è·³è¿‡æ„å»ºï¼Œä½¿ç”¨ç¼“å­˜ âœ…
  â†“
æ­¥éª¤3: å¦‚æœéœ€è¦æ„å»º â­â­â­
  this.hooks.buildModule.call(module);  // è§¦å‘é’©å­
  this.builtModules.add(module);        // æ ‡è®°å·²æ„å»º

  è°ƒç”¨æ¨¡å—æ„å»º:
    module.build(
      this.options,           // webpack é…ç½®
      this,                   // compilation
      resolver,               // è§£æå™¨
      this.inputFileSystem,   // æ–‡ä»¶ç³»ç»Ÿ
      callback
    )
    â†“
  æ¨¡å—æ„å»ºæµç¨‹ï¼ˆlib/NormalModule.jsï¼‰:

    3.1: è°ƒç”¨ _doBuild â­â­â­

      A. åˆ›å»º loaderContext
        loaderContext = {
          resource: '/project/src/index.js',
          context: '/project/src',
          loaders: [{ loader: 'babel-loader', ... }],

          // loader API:
          async: () => callback,
          callback: (err, content, sourceMap) => {},
          addDependency: (file) => {},
          emitFile: (name, content) => {},
          // ... 40+ API
        }

      B. æ‰§è¡Œ loader é“¾ â­â­â­
        runLoaders({
          resource: '/project/src/index.js',
          loaders: [{ loader: 'babel-loader', ... }],
          context: loaderContext
        }, (err, result) => {

          loader æ‰§è¡Œæµç¨‹:
            æ­¥éª¤1: Pitching é˜¶æ®µï¼ˆä»å·¦åˆ°å³ï¼‰
              loader.pitch()
              â†’ å¦‚æœè¿”å›å€¼ï¼Œè·³è¿‡åç»­

            æ­¥éª¤2: è¯»å–æºæ–‡ä»¶
              fs.readFile('/project/src/index.js')
              â†’ è¯»å–åŸå§‹ä»£ç 

            æ­¥éª¤3: Normal é˜¶æ®µï¼ˆä»å³åˆ°å·¦ï¼‰â­â­â­
              æºç 
                â†“ babel-loader
              è½¬æ¢åçš„ä»£ç ï¼ˆES5ï¼‰

              ç»“æœ: JavaScript ä»£ç ï¼ˆå¿…é¡»æ˜¯ JSï¼‰

          result = {
            result: [code, sourceMap, meta],
            fileDependencies: Set([...]),  // loader è®¿é—®çš„æ–‡ä»¶
            cacheable: true
          }
        })

      C. åˆ›å»º Source å¯¹è±¡
        this._source = this.createSource(
          context,
          code,
          sourceMap
        )

      D. æå– ASTï¼ˆå¦‚æœ loader æä¾›ï¼‰â­
        this._ast = meta?.webpackAST || null;

        ä¼˜åŒ–: å¦‚æœ babel-loader æä¾›äº† AST
             è·³è¿‡ acorn.parseï¼ˆèŠ‚çœ 20-30% æ—¶é—´ï¼‰

    3.2: è°ƒç”¨ parser.parse â­â­â­

      const parser = this.parser;  // JavascriptParser
      parser.parse(this._ast || this._source, {
        module: this,
        compilation: compilation
      })

      parser å†…éƒ¨æµç¨‹ï¼ˆlib/javascript/JavascriptParser.jsï¼‰:

        æ­¥éª¤1: è§£æ AST
          if (typeof source === 'object') {
            ast = source;  // ä½¿ç”¨ loader æä¾›çš„ AST
          } else {
            ast = acorn.parse(source);  // è§£ææºç 
          }

        æ­¥éª¤2: åˆå§‹åŒ–ä½œç”¨åŸŸ
          this.scope = {
            topLevelScope: true,
            definitions: new StackedMap(),
            isStrict: false
          }

        æ­¥éª¤3: å››è½®éå† AST â­â­â­

          ç¬¬1è½®: detectMode()
            æ£€æµ‹ä¸¥æ ¼æ¨¡å¼

          ç¬¬2è½®: preWalkStatements()
            æ”¶é›†å£°æ˜ï¼ˆè§£å†³å˜é‡æå‡ï¼‰
            - import å£°æ˜
            - export å£°æ˜
            - å‡½æ•°å£°æ˜
            - å˜é‡å£°æ˜

          ç¬¬3è½®: blockPreWalkStatements()
            å¤„ç†å—çº§ä½œç”¨åŸŸ

          ç¬¬4è½®: walkStatements() â­â­â­ æ ¸å¿ƒ
            éå† AST è¯†åˆ«ä¾èµ–:

            é‡åˆ° import è¯­å¥:
              import { foo } from './app.js'
                â†“
              è§¦å‘ hooks.import
                â†“
              HarmonyModulesPlugin çš„ç›‘å¬å™¨:
                åˆ›å»º HarmonyImportDependency
                module.dependencies.push(dep)

            é‡åˆ° require è¯­å¥:
              const bar = require('./utils.js')
                â†“
              è§¦å‘ hooks.call.for('require')
                â†“
              CommonJsPlugin çš„ç›‘å¬å™¨:
                åˆ›å»º CommonJsRequireDependency
                module.dependencies.push(dep)

            é‡åˆ° import() è¯­å¥:
              import('./lazy.js').then(...)
                â†“
              è§¦å‘ hooks.importCall
                â†“
              ImportPlugin çš„ç›‘å¬å™¨:
                åˆ›å»º ImportDependency
                åˆ›å»º AsyncDependenciesBlock
                module.blocks.push(block)

        æ­¥éª¤4: å®Œæˆè§£æ
          module.dependencies = [
            HarmonyImportDep('./app.js'),
            CommonJsRequireDep('./utils.js')
          ]

          module.blocks = [
            AsyncDependenciesBlock {
              dependencies: [ImportDep('./lazy.js')]
            }
          ]

  æ­¥éª¤3: ç¼“å­˜æ¨¡å— â­
    this._modulesCache.store(
      module.identifier(),
      null,
      module,
      callback
    )

    ç¼“å­˜å†…å®¹:
      - buildInfo
      - buildMeta
      - dependencies
      - blocks

    ä¸‹æ¬¡æ„å»ºæ—¶ç›´æ¥æ¢å¤ï¼Œè·³è¿‡ä¸Šè¿°æ‰€æœ‰æ­¥éª¤

  æ­¥éª¤4: è§¦å‘ succeedModule é’©å­
    this.hooks.succeedModule.call(module);

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ä»»åŠ¡7: å¤„ç†æ¨¡å—ä¾èµ–ï¼ˆé€’å½’ï¼ï¼‰â­â­â­
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

_handleModuleBuildAndDependencies ç»§ç»­:
  â†“
è°ƒç”¨: processModuleDependencies(module, callback)
  â†“
è°ƒç”¨é˜Ÿåˆ—:
  processDependenciesQueue.add(module, callback)
    â†“
  _processModuleDependencies(module, callback)
    â†“
æ­¥éª¤1: éå†æ‰€æœ‰ä¾èµ–å— â­â­

  ä½¿ç”¨ BFSï¼ˆå¹¿åº¦ä¼˜å…ˆï¼‰éå†:
    const queue = [module];

    while (queue.length > 0) {
      const block = queue.pop();

      // å¤„ç†å—çš„ç›´æ¥ä¾èµ–
      for (const dep of block.dependencies) {
        processDependency(dep);
      }

      // æ·»åŠ åµŒå¥—å—åˆ°é˜Ÿåˆ—
      for (const nestedBlock of block.blocks) {
        queue.push(nestedBlock);  // å¼‚æ­¥å—
      }
    }

  æ”¶é›†ç»“æœ:
    module.dependencies = [dep1, dep2, ...]
    module.blocks[0].dependencies = [dep3, ...]
  â†“
æ­¥éª¤2: ä¾èµ–åˆ†ç»„ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰â­â­â­

  å°†ä¾èµ–æŒ‰å·¥å‚å’Œèµ„æºåˆ†ç»„:

  åŸå§‹ä¾èµ–:
    [
      HarmonyImportDep('./app.js'),
      HarmonyImportDep('./utils.js'),
      CommonJsRequireDep('./config.js'),
      ImportDep('./lazy.js')
    ]

  åˆ†ç»„åï¼ˆsortedDependenciesï¼‰:
    [
      {
        factory: normalModuleFactory,
        dependencies: [
          HarmonyImportDep('./app.js'),
          HarmonyImportDep('./utils.js'),
        ],
        context: '/project/src',
        originModule: module
      },
      {
        factory: normalModuleFactory,
        dependencies: [
          CommonJsRequireDep('./config.js'),
          ImportDep('./lazy.js')
        ],
        context: '/project/src',
        originModule: module
      }
    ]

  ä¼˜åŒ–:
    - å‡å°‘å·¥å‚æŸ¥æ‰¾æ¬¡æ•°
    - ç›¸åŒå·¥å‚çš„ä¾èµ–ä¸€èµ·å¤„ç†
    - ä¸‰çº§ç¼“å­˜ä¼˜åŒ–æŸ¥æ‰¾é€Ÿåº¦:
      1. æ„é€ å‡½æ•°ç¼“å­˜ï¼ˆè¶…å¿«ï¼‰
      2. å·¥å‚å®ä¾‹ç¼“å­˜ï¼ˆå¿«ï¼‰
      3. Map æŸ¥æ‰¾ï¼ˆæ…¢ï¼‰
  â†“
æ­¥éª¤3: å¢åŠ é˜Ÿåˆ—å¹¶è¡Œåº¦
  this.processDependenciesQueue.increaseParallelism();

  åŸå› : å³å°†é€’å½’è°ƒç”¨ï¼Œéœ€è¦æ›´å¤šå¹¶è¡Œå®¹é‡
  â†“
æ­¥éª¤4: å¯¹æ¯ç»„ä¾èµ–é€’å½’è°ƒç”¨ handleModuleCreation â­â­â­

  for (const item of sortedDependencies) {
    // ğŸ”„ é€’å½’è°ƒç”¨ï¼ˆå…³é”®ï¼ï¼‰
    this.handleModuleCreation(item, callback);
      â†“
    handleModuleCreation åˆä¼šæ‰§è¡Œ:
      â”œâ”€ factorizeModuleï¼ˆåˆ›å»ºä¾èµ–çš„æ¨¡å—ï¼‰
      â”œâ”€ addModuleï¼ˆæ·»åŠ ä¾èµ–çš„æ¨¡å—ï¼‰
      â”œâ”€ setResolvedModuleï¼ˆå»ºç«‹è¿æ¥ï¼‰
      â”œâ”€ buildModuleï¼ˆæ„å»ºä¾èµ–çš„æ¨¡å—ï¼‰
      â””â”€ processModuleDependenciesï¼ˆå¤„ç†ä¾èµ–çš„ä¾èµ–ï¼‰ğŸ”„
  }

  é€’å½’ç»“æ„:
    index.js
      â”œâ”€ handleModuleCreation(appDep) ğŸ”„
      â”‚   â”œâ”€ åˆ›å»º app.js æ¨¡å—
      â”‚   â”œâ”€ æ„å»º app.js
      â”‚   â””â”€ processModuleDependencies(app.js) ğŸ”„
      â”‚       â””â”€ handleModuleCreation(componentDep) ğŸ”„
      â”‚           â””â”€ ...
      â”‚
      â””â”€ handleModuleCreation(utilsDep) ğŸ”„
          â””â”€ ...

  åœæ­¢æ¡ä»¶:
    1. æ¨¡å—æ— ä¾èµ–ï¼ˆå¶å­æ¨¡å—ï¼‰
    2. æ¨¡å—å·²å­˜åœ¨ï¼ˆå»é‡ï¼‰
    3. æ‰€æœ‰ä¾èµ–éƒ½å·²å¤„ç†
  â†“
æ­¥éª¤5: ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
  ä½¿ç”¨è®¡æ•°å™¨è·Ÿè¸ª:
    inProgressTransitive = 1ï¼ˆåˆå§‹ï¼‰

    æ¯ä¸ª handleModuleCreation:
      å¼€å§‹: inProgressTransitive++
      å®Œæˆ: inProgressTransitive--

    å½“ inProgressTransitive === 0:
      â†’ æ‰€æœ‰ä¾èµ–éƒ½å·²å¤„ç†
      â†’ è°ƒç”¨ callback
  â†“
æ­¥éª¤6: æ¢å¤é˜Ÿåˆ—å¹¶è¡Œåº¦
  this.processDependenciesQueue.decreaseParallelism();
  â†“
æ­¥éª¤7: è¿”å›
  callback();  // æ¨¡å—åŠå…¶æ‰€æœ‰ä¾èµ–éƒ½å·²å®Œæˆ

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Make é˜¶æ®µå®Œæˆ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ç»“æœ:
  âœ… compilation.modulesï¼ˆæ‰€æœ‰æ¨¡å—ï¼‰
     Set([index.js, app.js, utils.js, component.js, ...])

  âœ… compilation.moduleGraphï¼ˆå®Œæ•´çš„ä¾èµ–å›¾ï¼‰
     ModuleGraph {
       _moduleMap: WeakMap {
         index.js => {
           outgoing: [conn1, conn2],  // index â†’ app, utils
           incoming: []                // å…¥å£æ¨¡å—
         },
         app.js => {
           outgoing: [conn3],          // app â†’ component
           incoming: [conn1]           // index â†’ app
         },
         utils.js => {
           outgoing: [],
           incoming: [conn2]           // index â†’ utils
         },
         component.js => {
           outgoing: [],
           incoming: [conn3]           // app â†’ component
         }
       },

       _dependencyMap: WeakMap {
         HarmonyImportDep('./app.js') => conn1,
         HarmonyImportDep('./utils.js') => conn2,
         ImportDep('./component.js') => conn3
       }
     }

  âœ… ä¾èµ–å›¾å¯è§†åŒ–:
     index.js (å…¥å£)
       â”œâ”€â†’ app.js
       â”‚    â””â”€â†’ component.js (å¼‚æ­¥)
       â””â”€â†’ utils.js

  â­ï¸ å‡†å¤‡è¿›å…¥ Seal é˜¶æ®µ
     - å°†æ¨¡å—åˆ†é…åˆ° Chunk
     - å»ºç«‹ ChunkGraph
```

---

## ğŸ¯ å®Œæ•´æµç¨‹å›¾

```mermaid
graph TD
    Start[make é’©å­è§¦å‘] --> Entry[EntryPlugin<br/>ç›‘å¬å™¨æ‰§è¡Œ]

    Entry --> AddEntry["addEntry<br/>æ·»åŠ å…¥å£ä¾èµ–"]

    AddEntry --> Tree["addModuleTree<br/>å¼€å§‹æ„å»ºæ¨¡å—æ ‘"]

    Tree --> Find["æŸ¥æ‰¾ä¾èµ–å·¥å‚<br/>EntryDep â†’ NMF"]

    Find --> Handle["â­â­â­ handleModuleCreation<br/>é€’å½’æ„å»ºæ ¸å¿ƒ"]

    Handle --> Task1["ä»»åŠ¡1: factorizeModule<br/>åˆ›å»ºæ¨¡å—å®ä¾‹"]

    Task1 --> Factory["NormalModuleFactory.create:<br/>â”œâ”€ è§£æè·¯å¾„<br/>â”œâ”€ åŒ¹é… loader<br/>â””â”€ new NormalModule"]

    Factory --> Task2["ä»»åŠ¡2: addModule<br/>æ·»åŠ æ¨¡å—å»é‡"]

    Task2 --> Check{æ¨¡å—å·²å­˜åœ¨?}
    Check -->|æ˜¯| UseExist[ä½¿ç”¨ç°æœ‰æ¨¡å—<br/>â­ å»é‡]
    Check -->|å¦| AddNew[æ·»åŠ åˆ° modules]

    UseExist --> Task3
    AddNew --> CacheCheck{æœ‰ç¼“å­˜?}
    CacheCheck -->|æ˜¯| Restore[æ¢å¤ buildInfo<br/>â­ è·³è¿‡æ„å»º]
    CacheCheck -->|å¦| Task3

    Restore --> Task3

    Task3["ä»»åŠ¡3: setResolvedModule<br/>â­â­â­ å»ºç«‹å›¾è¿æ¥"]

    Task3 --> Connect["åˆ›å»º Connection:<br/>â”œâ”€ origin â†’ connection<br/>â”œâ”€ target â† connection<br/>â””â”€ dep â†’ connection"]

    Connect --> Task4["ä»»åŠ¡4: buildModule<br/>â­â­â­ æ„å»ºæ¨¡å—"]

    Task4 --> NeedBuild{needBuild?<br/>éœ€è¦æ„å»º?}

    NeedBuild -->|å¦| UseCache[ä½¿ç”¨ç¼“å­˜<br/>â­ å¢é‡ç¼–è¯‘]
    NeedBuild -->|æ˜¯| DoBuild["_doBuild:<br/>æ‰§è¡Œæ„å»º"]

    DoBuild --> Loader["runLoaders:<br/>â”œâ”€ è¯»å–æ–‡ä»¶<br/>â”œâ”€ æ‰§è¡Œ loader é“¾<br/>â””â”€ è½¬æ¢ä»£ç "]

    Loader --> Parse["parser.parse:<br/>â”œâ”€ acorn.parse AST<br/>â”œâ”€ å››è½®éå†<br/>â””â”€ è¯†åˆ«ä¾èµ–"]

    Parse --> Deps["æ”¶é›†ä¾èµ–:<br/>module.dependencies<br/>module.blocks"]

    Deps --> Cache2[ç¼“å­˜æ¨¡å—<br/>buildInfo ç­‰]

    UseCache --> Task5
    Cache2 --> Task5

    Task5["ä»»åŠ¡5: processModuleDependencies<br/>â­â­â­ å¤„ç†ä¾èµ–"]

    Task5 --> Traverse["éå†ä¾èµ–:<br/>BFS éå†æ‰€æœ‰å—"]

    Traverse --> Group["ä¾èµ–åˆ†ç»„:<br/>æŒ‰å·¥å‚+èµ„æºåˆ†ç»„<br/>â­ ä¸‰çº§ç¼“å­˜ä¼˜åŒ–"]

    Group --> Recurse{éå†æ¯ä¸ªä¾èµ–ç»„}

    Recurse -->|æ¯ä¸ª| Handle2["ğŸ”„ é€’å½’ handleModuleCreation<br/>å¤„ç†ä¾èµ–çš„æ¨¡å—"]

    Handle2 --> Handle

    Recurse -->|å…¨éƒ¨å®Œæˆ| Done["Make é˜¶æ®µå®Œæˆ<br/><br/>ç»“æœ:<br/>âœ… modules é›†åˆå·²å¡«å……<br/>âœ… ModuleGraph å·²å»ºç«‹<br/>âœ… æ‰€æœ‰ä¾èµ–å·²è§£æ"]

    Done --> Callback[make é’©å­ callback]

    Callback --> FinishMake[finishMake é’©å­]

    FinishMake --> Next([ä¸‹ä¸€é˜¶æ®µ:<br/>Seal å°è£…])

    style Handle fill:#ff9999
    style Task3 fill:#ff9999
    style Task4 fill:#ff9999
    style Parse fill:#ffcc99
    style Task5 fill:#ffcc99
    style Handle2 fill:#ff9999
```

---

## ğŸ’¡ æºç ä¸­çš„ç²¾å¦™è®¾è®¡å’Œéšè—çŸ¥è¯†ç‚¹

### çŸ¥è¯†ç‚¹1: é˜Ÿåˆ—ç³»ç»Ÿçš„å¹¶è¡Œæ§åˆ¶ â­â­â­

```
ä¸ºä»€ä¹ˆéœ€è¦é˜Ÿåˆ—ï¼Ÿ

é—®é¢˜åœºæ™¯ï¼ˆå¦‚æœæ²¡æœ‰é˜Ÿåˆ—ï¼‰:
  index.js æœ‰ 1000 ä¸ª import
    â†“
  åŒæ—¶åˆ›å»º 1000 ä¸ªæ¨¡å—
    â†“
  æ¯ä¸ªæ¨¡å—åˆæœ‰ä¾èµ–
    â†“
  å¹¶å‘æ•°çˆ†ç‚¸ â†’ å†…å­˜çˆ†ç‚¸ âŒ

è§£å†³æ–¹æ¡ˆï¼ˆä½¿ç”¨é˜Ÿåˆ—ï¼‰:
  factorizeQueue(parallelism: 100)
    â†“
  æœ€å¤šåŒæ—¶å¤„ç† 100 ä¸ªæ¨¡å—
    â†“
  é˜Ÿåˆ—è‡ªåŠ¨è°ƒåº¦:
    å®Œæˆ 1 ä¸ª â†’ ä»é˜Ÿåˆ—å–å‡ºä¸‹ä¸€ä¸ª
    â†“
  å†…å­˜å¯æ§ âœ…

æ€§èƒ½å¯¹æ¯”:
  æ— é™åˆ¶å¹¶å‘: 10GB å†…å­˜ï¼Œå¯èƒ½å´©æºƒ
  parallelism=100: 500MB å†…å­˜ï¼Œç¨³å®šè¿è¡Œ
```

### çŸ¥è¯†ç‚¹2: ä¸‰çº§ç¼“å­˜ä¼˜åŒ– â­â­â­

```
processDependencyForResolving çš„ä¸‰çº§ç¼“å­˜:

åœºæ™¯: å¤„ç† 1000 ä¸ªä¾èµ–

çº§åˆ«1: æ„é€ å‡½æ•°ç¼“å­˜ï¼ˆå‘½ä¸­ç‡ 90%ï¼‰
  if (factoryCacheKey === dep.constructor) {
    // è¶…å¿«è·¯å¾„ï¼šæ„é€ å‡½æ•°ç›¸åŒ
    // è€—æ—¶: ~0.001ms
    // 90% çš„ä¾èµ–èµ°è¿™ä¸ªè·¯å¾„
  }

çº§åˆ«2: å·¥å‚å®ä¾‹ç¼“å­˜ï¼ˆå‘½ä¸­ç‡ 8%ï¼‰
  if (factoryCacheKey2 === factory) {
    // å¿«è·¯å¾„ï¼šå·¥å‚ç›¸åŒ
    // è€—æ—¶: ~0.01ms
    // 8% çš„ä¾èµ–èµ°è¿™ä¸ªè·¯å¾„
  }

çº§åˆ«3: Map æŸ¥æ‰¾ï¼ˆå‘½ä¸­ç‡ 2%ï¼‰
  const factory = dependencyFactories.get(constructor);
  // æ…¢è·¯å¾„ï¼šéœ€è¦ Map æŸ¥æ‰¾
  // è€—æ—¶: ~0.1ms
  // 2% çš„ä¾èµ–èµ°è¿™ä¸ªè·¯å¾„

æ€§èƒ½æå‡:
  æ— ä¼˜åŒ–: 1000 * 0.1ms = 100ms
  ä¸‰çº§ç¼“å­˜: 900*0.001ms + 80*0.01ms + 20*0.1ms = 3.7ms
  å¿« 27 å€ï¼â­
```

### çŸ¥è¯†ç‚¹3: ä¸å®‰å…¨ç¼“å­˜æœºåˆ¶ â­â­

```
ä¸¤ç§ç¼“å­˜ç­–ç•¥:

å®‰å…¨ç¼“å­˜ï¼ˆé»˜è®¤ï¼‰:
  1. æ£€æŸ¥æ–‡ä»¶æ—¶é—´æˆ³
  2. æ£€æŸ¥æ–‡ä»¶å†…å®¹ hash
  3. æ—¶é—´æˆ³æˆ– hash å˜åŒ– â†’ é‡æ–°æ„å»º

  ç‰¹ç‚¹: å‡†ç¡®ä½†è¾ƒæ…¢

ä¸å®‰å…¨ç¼“å­˜ï¼ˆå¯é€‰ï¼‰:
  1. å‡è®¾æ¨¡å—ä¸å˜
  2. ç›´æ¥å¤ç”¨ä¸Šæ¬¡çš„æ¨¡å—å®ä¾‹
  3. ä¸æ£€æŸ¥æ–‡ä»¶å˜åŒ–

  ç‰¹ç‚¹: å¿«ä½†å¯èƒ½ä¸å‡†ç¡®

é…ç½®:
  module.exports = {
    module: {
      unsafeCache: true,  // å¯ç”¨ä¸å®‰å…¨ç¼“å­˜
      // æˆ–å‡½æ•°å½¢å¼ï¼ˆç²¾ç»†æ§åˆ¶ï¼‰
      unsafeCache: (module) => {
        // åªå¯¹ node_modules å¯ç”¨
        return /node_modules/.test(module.resource);
      }
    }
  }

æ€§èƒ½å¯¹æ¯”:
  å®‰å…¨ç¼“å­˜: æ£€æŸ¥ 1000 ä¸ªæ–‡ä»¶ = 100ms
  ä¸å®‰å…¨ç¼“å­˜: ç›´æ¥å¤ç”¨ = 1ms
  å¿« 100 å€ï¼â­

é£é™©:
  æ–‡ä»¶å¤–éƒ¨ä¿®æ”¹ä½† webpack ä¸çŸ¥é“
  â†’ ä½¿ç”¨æ—§çš„æ¨¡å—ä»£ç 
  â†’ ç»“æœä¸æ­£ç¡®
```

### çŸ¥è¯†ç‚¹4: å¢é‡æ„å»ºçš„å®ç° â­â­â­

```
watch æ¨¡å¼çš„å¢é‡ç¼–è¯‘:

é¦–æ¬¡ç¼–è¯‘:
  index.js
    â”œâ”€ needBuild() â†’ trueï¼ˆæ— ç¼“å­˜ï¼‰
    â”œâ”€ æ‰§è¡Œ loader
    â”œâ”€ è§£æ AST
    â””â”€ ç¼“å­˜ buildInfo

  app.js
    â”œâ”€ needBuild() â†’ true
    â”œâ”€ æ‰§è¡Œ loader
    â”œâ”€ è§£æ AST
    â””â”€ ç¼“å­˜ buildInfo

  utils.js
    â”œâ”€ needBuild() â†’ true
    â”œâ”€ æ‰§è¡Œ loader
    â”œâ”€ è§£æ AST
    â””â”€ ç¼“å­˜ buildInfo

  è€—æ—¶: 2000ms

æ–‡ä»¶å˜åŒ–ï¼ˆä¿®æ”¹ app.jsï¼‰:
  index.js
    â”œâ”€ needBuild() â†’ false â­
    â”œâ”€ æ—¶é—´æˆ³æœªå˜
    â”œâ”€ hash æœªå˜
    â””â”€ ä½¿ç”¨ç¼“å­˜ âœ…ï¼ˆè·³è¿‡æ„å»ºï¼‰

  app.js
    â”œâ”€ needBuild() â†’ true â­
    â”œâ”€ æ—¶é—´æˆ³å˜åŒ–äº†
    â”œâ”€ éœ€è¦é‡æ–°æ„å»º
    â”œâ”€ æ‰§è¡Œ loader
    â”œâ”€ è§£æ AST
    â””â”€ æ›´æ–°ç¼“å­˜

  utils.js
    â”œâ”€ needBuild() â†’ false â­
    â””â”€ ä½¿ç”¨ç¼“å­˜ âœ…

  è€—æ—¶: 200msï¼ˆå¿« 10 å€ï¼‰â­

å…³é”®æœºåˆ¶:
  buildInfo.hash = hash(æ–‡ä»¶å†…å®¹ + é…ç½® + ä¾èµ–)

  æ¯æ¬¡æ„å»ºå‰:
    oldHash = module.buildInfo.hash
    newHash = computeHash(module)

    if (oldHash === newHash) {
      return false;  // ä¸éœ€è¦æ„å»º
    }

    return true;  // éœ€è¦æ„å»º
```

### çŸ¥è¯†ç‚¹5: parser çš„å››è½®éå† â­â­

```
ä¸ºä»€ä¹ˆéœ€è¦å››è½®éå† ASTï¼Ÿ

é—®é¢˜: JavaScript çš„å˜é‡æå‡

æºç :
  console.log(foo);  // ç¬¬1è¡Œ
  var foo = 1;       // ç¬¬2è¡Œ

å¦‚æœåªéå†ä¸€æ¬¡:
  éå†ç¬¬1è¡Œ: é‡åˆ° fooï¼Œä½œç”¨åŸŸä¸­æ²¡æœ‰ â†’ è®¤ä¸ºæ˜¯è‡ªç”±å˜é‡ âŒ
  éå†ç¬¬2è¡Œ: é‡åˆ°å£°æ˜ï¼Œä½†å¤ªæ™šäº†

è§£å†³: å››è½®éå†

ç¬¬1è½®: detectMode()
  æ£€æµ‹ 'use strict'
  ä¸å¤„ç†å˜é‡

ç¬¬2è½®: preWalkStatements() â­
  æ”¶é›†æ‰€æœ‰å£°æ˜:
    - import å£°æ˜
    - export å£°æ˜
    - var/let/const å£°æ˜
    - function å£°æ˜

  å»ºç«‹ä½œç”¨åŸŸè¡¨:
    scope.definitions.set('foo', ...)
    scope.definitions.set('bar', ...)

ç¬¬3è½®: blockPreWalkStatements()
  å¤„ç†å—çº§ä½œç”¨åŸŸ
  { let x = 1; }

ç¬¬4è½®: walkStatements() â­â­â­
  è¯†åˆ«ä¾èµ–:
    é‡åˆ° foo â†’ æŸ¥ä½œç”¨åŸŸè¡¨ â†’ æ‰¾åˆ°äº†ï¼Œæ˜¯å±€éƒ¨å˜é‡
    é‡åˆ° import './app' â†’ åˆ›å»ºä¾èµ–

ç»“æœ: å‡†ç¡®è¯†åˆ«ä¾èµ–å’Œè‡ªç”±å˜é‡
```

### çŸ¥è¯†ç‚¹6: ModuleGraph çš„ WeakMap è®¾è®¡ â­â­

```
ä¸ºä»€ä¹ˆç”¨ WeakMapï¼Ÿ

_dependencyMap: WeakMap<Dependency, Connection>

åŸå› 1: é˜²æ­¢å†…å­˜æ³„æ¼
  Dependency å¯¹è±¡å¯èƒ½è¢«å¤–éƒ¨é‡Šæ”¾
  å¦‚æœç”¨ Mapï¼Œä¼šé˜»æ­¢ GC
  WeakMap å…è®¸ Dependency è¢«å›æ”¶

åŸå› 2: è‡ªåŠ¨æ¸…ç†
  Module è¢«åˆ é™¤ â†’ Dependency è¢«åˆ é™¤
  â†’ WeakMap è‡ªåŠ¨åˆ é™¤å¯¹åº”æ¡ç›®
  â†’ ä¸éœ€è¦æ‰‹åŠ¨æ¸…ç†

æ€§èƒ½:
  Map: O(1) æŸ¥æ‰¾ + éœ€è¦æ‰‹åŠ¨æ¸…ç†
  WeakMap: O(1) æŸ¥æ‰¾ + è‡ªåŠ¨æ¸…ç† âœ…
```

### çŸ¥è¯†ç‚¹7: é”™è¯¯çš„ stack é‡èµ‹å€¼æŠ€å·§ â­

```
ä¸ºä»€ä¹ˆè¦ err.stack = err.stackï¼Ÿ

é—®é¢˜: V8 çš„ Error å¯¹è±¡å†…å­˜æ³„æ¼

Error å¯¹è±¡çš„å†…éƒ¨ç»“æ„:
  err.stackï¼ˆå­—ç¬¦ä¸²ï¼‰
    â†“ V8 å†…éƒ¨ä¿æŒé—­åŒ…å¼•ç”¨
  è°ƒç”¨æ ˆä¸Šçš„æ‰€æœ‰å‡½æ•°
    â†“ è¿™äº›å‡½æ•°å¼•ç”¨äº†
  Compilation å¯¹è±¡
    â†“ å¯¼è‡´
  Compilation æ— æ³•è¢« GC âŒ

è§£å†³: é‡æ–°èµ‹å€¼ stack
  err.stack = err.stack;

  æ•ˆæœ:
    - ç”Ÿæˆæ–°çš„ stack å­—ç¬¦ä¸²
    - åˆ‡æ–­é—­åŒ…å¼•ç”¨é“¾
    - Compilation å¯ä»¥è¢« GC âœ…

ä»£ç ä½ç½®:
  if (err && this.bail) {
    err.stack = err.stack;  // â­ å…³é”®è¡Œ
    callback(err);
  }

å†…å­˜èŠ‚çœ:
  ä¸å¤„ç†: æ¯ä¸ªé”™è¯¯ä¿æŒ ~10MB Compilation
  å¤„ç†å: æ¯ä¸ªé”™è¯¯åªä¿æŒ stack å­—ç¬¦ä¸² ~1KB
```

---

## ğŸ“Š Make é˜¶æ®µçš„æ€§èƒ½æ•°æ®

```
Make é˜¶æ®µçš„è€—æ—¶åˆ†å¸ƒ:

æ€»è€—æ—¶: 2000ms (60-70% çš„ç¼–è¯‘æ—¶é—´)

â”œâ”€ factorizeï¼ˆåˆ›å»ºæ¨¡å—ï¼‰: 5%
â”‚   â””â”€ è§£æè·¯å¾„ã€åŒ¹é… loader
â”‚
â”œâ”€ buildï¼ˆæ„å»ºæ¨¡å—ï¼‰: 70% â­â­â­
â”‚   â”œâ”€ loader æ‰§è¡Œ: 40%
â”‚   â”œâ”€ AST è§£æ: 20%
â”‚   â””â”€ ä¾èµ–è¯†åˆ«: 10%
â”‚
â”œâ”€ processDepe ndencies: 20%
â”‚   â””â”€ ä¾èµ–åˆ†ç»„ã€é€’å½’è°ƒç”¨
â”‚
â””â”€ å…¶ä»–: 5%

ä¼˜åŒ–å»ºè®®:
  1. é™åˆ¶ loader èŒƒå›´ï¼ˆinclude/excludeï¼‰
  2. å¯ç”¨ç¼“å­˜ï¼ˆcache: filesystemï¼‰
  3. ä½¿ç”¨ thread-loader å¹¶è¡Œ
  4. å‡å°‘ä¾èµ–æ·±åº¦
```

---

## ğŸ“‹ Make é˜¶æ®µä¸º Seal é˜¶æ®µçš„é“ºå«

```
Make é˜¶æ®µå‡†å¤‡çš„æ•°æ®ï¼ˆSeal é˜¶æ®µä½¿ç”¨ï¼‰:

1. compilation.modules â­â­â­
   æ‰€æœ‰æ¨¡å—çš„é›†åˆ

   Seal ä½¿ç”¨:
     - éå†æ‰€æœ‰æ¨¡å—
     - ä¼˜åŒ–æ¨¡å—ï¼ˆTree Shakingï¼‰
     - åˆ†é…æ¨¡å—åˆ° Chunk

2. compilation.moduleGraph â­â­â­
   æ¨¡å—ä¾èµ–å…³ç³»

   Seal ä½¿ç”¨:
     - buildChunkGraph éå†ä¾èµ–å›¾
     - ç¡®å®šæ¨¡å—åŒ…å«å…³ç³»
     - Tree Shaking åˆ†æä½¿ç”¨æƒ…å†µ

3. compilation.entrypoints
   å…¥å£ç‚¹ä¿¡æ¯

   Seal ä½¿ç”¨:
     - ä¸ºæ¯ä¸ªå…¥å£åˆ›å»º Chunk
     - ä½œä¸º buildChunkGraph çš„èµ·ç‚¹

4. module.dependencies
   æ¯ä¸ªæ¨¡å—çš„ä¾èµ–

   Seal ä½¿ç”¨:
     - éå†ä¾èµ–å›¾
     - åˆ†é…æ¨¡å—åˆ° Chunk
     - å»ºç«‹ Chunk é—´çš„å…³ç³»

5. module.blocksï¼ˆå¼‚æ­¥å—ï¼‰â­â­
   åŠ¨æ€ import() çš„ä¿¡æ¯

   Seal ä½¿ç”¨:
     - åˆ›å»ºå¼‚æ­¥ Chunk
     - ä»£ç åˆ†å‰²çš„ä¾æ®

6. module.buildInfo
   æ„å»ºä¿¡æ¯å’Œå…ƒæ•°æ®

   Seal ä½¿ç”¨:
     - Tree Shakingï¼ˆexportsã€sideEffectsï¼‰
     - å“ˆå¸Œè®¡ç®—
     - ç¼“å­˜åˆ¤æ–­

æ²¡æœ‰ Make é˜¶æ®µçš„å‡†å¤‡ï¼ŒSeal é˜¶æ®µæ— æ³•å·¥ä½œï¼
```

---

**Make é˜¶æ®µ = å»ºç«‹åœ°åŸºï¼ŒSeal é˜¶æ®µ = å»ºé€ æˆ¿å­ï¼** ğŸ—ï¸

æ ¸å¿ƒè¦ç‚¹ï¼š
1. âœ… make é’©å­è§¦å‘ â†’ EntryPlugin æ‰§è¡Œ
2. âœ… é€’å½’æ„å»ºæ‰€æœ‰æ¨¡å—ï¼ˆæ ¸å¿ƒï¼‰
3. âœ… å»ºç«‹å®Œæ•´çš„ ModuleGraph
4. âœ… ä¸º Seal é˜¶æ®µå‡†å¤‡æ‰€æœ‰æ•°æ®




éå¸¸å¥½çš„æ€»ç»“ï¼è®©æˆ‘å¸®ä½ ä¿®æ­£å’Œè¡¥å……ä¸€äº›å…³é”®ç»†èŠ‚å’Œæºç ä¸­çš„éšè—çŸ¥è¯†ç‚¹ â­

---

## ğŸ”§ ä¿®æ­£å’Œè¡¥å……çš„å®Œæ•´æµç¨‹

### ğŸ“Œ æ­¥éª¤1è¡¥å……ï¼šæ·»åŠ å…¥å£æ¨¡å—çš„å®Œæ•´ç»†èŠ‚

ä½ çš„æ€»ç»“ç¼ºå°‘äº† `_addEntryItem` çš„å…³é”®é€»è¾‘ï¼š

```
lib/Compilation.js: addEntry()
  â†“
_addEntryItem(context, entry, "dependencies", options, callback)
  â†“
æ­¥éª¤1.1: è·å–æˆ–åˆ›å»ºå…¥å£æ•°æ® â­
  let entryData = this.entries.get('main');

  if (!entryData) {
    // é¦–æ¬¡åˆ›å»º
    entryData = {
      dependencies: [],
      includeDependencies: [],
      options: { name: 'main', ... }
    };
    this.entries.set('main', entryData);
  }

  // â­ é‡è¦ï¼šæ”¯æŒå¤šæ¬¡è°ƒç”¨ addEntry æ·»åŠ å¤šä¸ªä¾èµ–
  entryData.dependencies.push(entry);
  â†“
æ­¥éª¤1.2: åˆå¹¶é€‰é¡¹ï¼ˆå†²çªæ£€æµ‹ï¼‰â­â­
  for (const key of Object.keys(options)) {
    if (entryData.options[key] !== options[key]) {
      // æ£€æŸ¥å†²çª
      if (entryData.options[key] === undefined) {
        entryData.options[key] = options[key];  // é¦–æ¬¡è®¾ç½®
      } else {
        throw new Error('Conflicting entry option');  // å†²çªï¼
      }
    }
  }

  éšè—çŸ¥è¯†ç‚¹ â­:
    åŒä¸€ä¸ªå…¥å£å¯ä»¥å¤šæ¬¡è°ƒç”¨ addEntry
    ä¾‹å¦‚:
      compilation.addEntry(ctx, depA, {name: 'main'})
      compilation.addEntry(ctx, depB, {name: 'main'})

    ç»“æœ: main å…¥å£åŒ…å«ä¸¤ä¸ªä¾èµ– [depA, depB]
  â†“
æ­¥éª¤1.3: è§¦å‘ addEntry é’©å­
  this.hooks.addEntry.call(entry, options);
  â†“
æ­¥éª¤1.4: è°ƒç”¨ addModuleTree â­â­â­
  this.addModuleTree({ context, dependency: entry }, callback)
```

---

### ğŸ“Œ æ­¥éª¤2è¡¥å……ï¼šä¾èµ–å·¥å‚æŸ¥æ‰¾æœºåˆ¶ â­â­â­

ä½ æ¼æ‰äº† `addModuleTree` ä¸­çš„å…³é”®æ­¥éª¤ï¼š

```
lib/Compilation.js: addModuleTree()
  â†“
æ­¥éª¤2.1: éªŒè¯ä¾èµ–å¯¹è±¡
  if (!dependency || !dependency.constructor) {
    throw new Error('Invalid dependency');
  }
  â†“
æ­¥éª¤2.2: æŸ¥æ‰¾ä¾èµ–å·¥å‚ â­â­â­
  const Dep = dependency.constructor;  // EntryDependency ç±»
  const factory = this.dependencyFactories.get(Dep);

  æŸ¥æ‰¾é€»è¾‘:
    dependencyFactories = Map<ä¾èµ–ç±», å·¥å‚>

    ä¾‹å¦‚:
      EntryDependency â†’ normalModuleFactory
      HarmonyImportSideEffectDependency â†’ normalModuleFactory
      CommonJsRequireDependency â†’ normalModuleFactory
      ImportDependency â†’ normalModuleFactory
      ContextDependency â†’ contextModuleFactory
      DllEntryDependency â†’ delegatedModuleFactory
      ExternalModuleDependency â†’ externalModuleFactory
      ... 100+ æ˜ å°„

  éšè—çŸ¥è¯†ç‚¹ â­â­:
    è¿™ä¸ªæ˜ å°„åœ¨å“ªé‡Œå»ºç«‹ï¼Ÿ
    â†’ lib/Compilation.js: æ„é€ å‡½æ•°ä¸­ï¼
    â†’ ç”±å„ä¸ªæ’ä»¶æ³¨å†Œï¼ˆHarmonyModulesPluginã€CommonJsPlugin ç­‰ï¼‰
    â†’ è§¦å‘æ—¶æœº: compiler.hooks.compilation.call(compilation)

  å¦‚æœæ‰¾ä¸åˆ°å·¥å‚:
    throw new Error(`No factory for ${Dep.name}`);
    â†’ è¯´æ˜ç¼ºå°‘ç›¸åº”çš„æ’ä»¶
  â†“
æ­¥éª¤2.3: è°ƒç”¨ handleModuleCreation â­â­â­
  this.handleModuleCreation({
    factory,
    dependencies: [dependency],
    originModule: null,  // å…¥å£æ— æºæ¨¡å—
    context
  }, callback)
```

---

### ğŸ“Œ æ­¥éª¤3è¡¥å……ï¼šhandleModuleCreation çš„é˜Ÿåˆ—ç³»ç»Ÿ â­â­â­

è¿™æ˜¯ä½ æ€»ç»“ä¸­æœ€å¤§çš„ç¼ºå¤±éƒ¨åˆ†ï¼

```
lib/Compilation.js: handleModuleCreation()
  â†“
ã€é‡è¦ã€‘è¿™ä¸ªæ–¹æ³•åè°ƒäº†å››ä¸ªé˜Ÿåˆ—çš„å·¥ä½œ â­â­â­
  â†“
é˜Ÿåˆ—è°ƒç”¨é“¾ï¼ˆçˆ¶å­å…³ç³»ï¼‰:
  processDependenciesQueue
    â†‘ parent
  addModuleQueue
    â†‘ parent
  factorizeQueue
    â†‘ parent
  buildQueue

çˆ¶å­å…³ç³»çš„ä½œç”¨ â­â­:
  - å­é˜Ÿåˆ—å¤„ç†æ—¶ï¼Œçˆ¶é˜Ÿåˆ—ä¼šç­‰å¾…
  - é¿å…æ­»é”
  - æ§åˆ¶å¹¶å‘æµ
  â†“
æ­¥éª¤3.1: factorizeQueue.add() â­â­â­
  this.factorizeModule({
    factory,
    dependencies,
    ...
  }, callback)
    â†“ é˜Ÿåˆ—è°ƒåº¦ï¼ˆå¹¶è¡Œåº¦: é»˜è®¤ 100ï¼‰
  _factorizeModule() æ‰§è¡Œ
    â†“
  factory.create({
    context,
    dependencies,
    ...
  }, (err, result) => {
    // result = {
    //   module: NormalModule,
    //   fileDependencies: Set([...]),  // â­ watch ä¾èµ–
    //   contextDependencies: Set([...]),
    //   cacheable: true
    // }
  })
    â†“
  å·¥å‚å†…éƒ¨ï¼ˆlib/NormalModuleFactory.jsï¼‰:

    A. beforeResolve é’©å­
       - å¯ä»¥ä¿®æ”¹è¯·æ±‚
       - å¯ä»¥è¿”å› false å¿½ç•¥

    B. factorize é’©å­ â†’ resolve é’©å­ â­â­â­

       B1. è§£æ inline loader
           'loader1!loader2!./file.js'
             â†“ åˆ†å‰²
           elements = [
             { loader: 'loader1', options: ... },
             { loader: 'loader2', options: ... }
           ]
           unresolvedResource = './file.js'

       B2. è§£æèµ„æºè·¯å¾„ â­â­
           ä½¿ç”¨ enhanced-resolve:
           './a.js'
             â†“ è§£æç›¸å¯¹è·¯å¾„
           '/project/src/a.js'

           'lodash'
             â†“ æŸ¥æ‰¾ node_modules
             â†“ æ£€æŸ¥ package.json
             â†“ åº”ç”¨ alias
           '/project/node_modules/lodash/lodash.js'

           æ”¶é›†ä¾èµ–:
             fileDependencies.add('/project/src/a.js')
             contextDependencies.add('/project/node_modules')

       B3. åŒ¹é… loader è§„åˆ™ â­â­â­
           ruleSet.exec({
             resource: '/project/src/a.js',
             dependency: 'esm',
             ...
           })
             â†“ éå† module.rules

           result = [
             { type: 'use', value: { loader: 'babel-loader' } },
             { type: 'type', value: 'javascript/auto' },
             { type: 'resolve', value: { ... } },
             { type: 'parser', value: { ... } },
             { type: 'generator', value: { ... } }
           ]

       B4. åˆå¹¶æ‰€æœ‰ loader â­â­
           æœ€ç»ˆ loader é“¾ = postLoaders + inlineLoaders + normalLoaders + preLoaders

           æ‰§è¡Œé¡ºåºï¼ˆä»å³åˆ°å·¦ï¼‰:
             preLoaders â†’ normalLoaders â†’ inlineLoaders â†’ postLoaders

       B5. ç¡®å®š parser å’Œ generator
           type = 'javascript/auto'
           parser = this.getParser(type)      â†’ JavascriptParser
           generator = this.getGenerator(type) â†’ JavascriptGenerator

    C. afterResolve é’©å­
       - å¯ä»¥ä¿®æ”¹ loader åˆ—è¡¨
       - å¯ä»¥ä¿®æ”¹è§£æç»“æœ

    D. createModule é’©å­ â†’ åˆ›å»ºæ¨¡å— â­â­

       å¦‚æœæ²¡æœ‰æ’ä»¶å¤„ç†:
         createdModule = new NormalModule({
           type: 'javascript/auto',
           resource: '/project/src/a.js',
           request: 'babel-loader!/project/src/a.js',
           userRequest: './a.js',
           rawRequest: './a.js',
           loaders: [...],
           parser,
           generator,
           resolveOptions,
           ...
         })

    E. module é’©å­
       - æ’ä»¶å¯ä»¥åŒ…è£…æ¨¡å—
       - è¿”å›æœ€ç»ˆçš„æ¨¡å—
  â†“
æ­¥éª¤3.2: addModuleQueue.add() â­â­â­
  this.addModule(module, callback)
    â†“ é˜Ÿåˆ—è°ƒåº¦
  _addModule(module, callback)
    â†“
  const identifier = module.identifier();
  // 'javascript/auto|/project/src/a.js'
  â†“
  æ£€æŸ¥å»é‡ â­â­â­:
    const existing = this._modules.get(identifier);
    if (existing) {
      return callback(null, existing);  // å¤ç”¨ï¼
    }

  éšè—çŸ¥è¯†ç‚¹ â­â­:
    å»é‡çš„æ—¶æœºéå¸¸é‡è¦ï¼

    åœºæ™¯1ï¼ˆåŒæ­¥ä¾èµ–ï¼‰:
      a.js: import common from './common'
      b.js: import common from './common'

      å¤„ç† a æ—¶: åˆ›å»º common æ¨¡å—
      å¤„ç† b æ—¶: å‘ç° common å·²å­˜åœ¨ï¼Œå¤ç”¨ âœ…

    åœºæ™¯2ï¼ˆå¹¶è¡Œå¤„ç†ï¼‰:
      å› ä¸ºé˜Ÿåˆ—çš„ getKey: module => module.identifier()
      ç›¸åŒ identifier çš„ä»»åŠ¡ä¼šè¢«åˆå¹¶å¤„ç†
      â†’ é¿å…å¹¶å‘åˆ›å»ºåŒä¸€ä¸ªæ¨¡å—
  â†“
  å°è¯•ä»æŒä¹…åŒ–ç¼“å­˜æ¢å¤ â­â­:
    this._modulesCache.get(identifier, null, (err, cached) => {
      if (cached) {
        // ä»ç£ç›˜æˆ–å†…å­˜ç¼“å­˜æ¢å¤
        cached.updateCacheModule(module);
        module = cached;

        æ¢å¤çš„å†…å®¹:
          âœ… buildInfo (æ„å»ºä¿¡æ¯)
          âœ… buildMeta (å…ƒæ•°æ®)
          âœ… dependencies (ä¾èµ–åˆ—è¡¨)
          âœ… hash (å†…å®¹å“ˆå¸Œ)
          âœ… _source (æºç )
          âœ… _ast (AST)  â† å…³é”®ï¼è·³è¿‡è§£æ

        æ€§èƒ½å¯¹æ¯”:
          æ— ç¼“å­˜: è¯»æ–‡ä»¶ + loader + è§£æ AST = 200ms
          æœ‰ç¼“å­˜: ååºåˆ—åŒ– = 2ms
          å¿« 100 å€ï¼â­
      }
    })
  â†“
  æ·»åŠ åˆ°é›†åˆ:
    this._modules.set(identifier, module);  // Map æ˜ å°„
    this.modules.add(module);               // Set é›†åˆ
  â†“
  è¿”å›æ¨¡å—:
    callback(null, module);
```

---

### ğŸ“Œ æ­¥éª¤4è¡¥å……ï¼šModuleGraph è¿æ¥å»ºç«‹çš„ç»†èŠ‚ â­â­â­

```
handleModuleCreation ç»§ç»­:
  â†“
æ­¥éª¤4.1: å»ºç«‹è¿æ¥ï¼ˆåœ¨ addModule å›è°ƒä¸­ï¼‰
  this.addModule(newModule, (err, module) => {
    // â­ module å¯èƒ½ä¸ç­‰äº newModuleï¼ˆå»é‡ï¼‰

    for (const dependency of dependencies) {
      moduleGraph.setResolvedModule(
        originModule,  // æºæ¨¡å—
        dependency,    // ä¾èµ–å¯¹è±¡
        module         // ç›®æ ‡æ¨¡å—ï¼ˆå¯èƒ½æ˜¯å¤ç”¨çš„ï¼‰
      )
    }
  })
  â†“
æ­¥éª¤4.2: setResolvedModule å†…éƒ¨ â­â­â­
  (lib/ModuleGraph.js)

  A. åˆ›å»ºè¿æ¥å¯¹è±¡
     const connection = new ModuleGraphConnection(
       originModule,
       dependency,
       module,
       undefined,  // resolvedOriginModule
       dependency.weak,  // å¼±ä¾èµ–æ ‡è®°
       dependency.getCondition(this)  // æ¿€æ´»æ¡ä»¶ â­
     )

     éšè—çŸ¥è¯†ç‚¹ - æ¿€æ´»æ¡ä»¶ â­â­:
       æŸäº›ä¾èµ–æœ‰æ¿€æ´»æ¡ä»¶ï¼

       ä¾‹å¦‚: HarmonyImportDependency
         dependency.getCondition() è¿”å›:
           - false: å§‹ç»ˆæ¿€æ´»
           - RuntimeCondition: ç‰¹å®šè¿è¡Œæ—¶æ‰æ¿€æ´»

       ç”¨é€”:
         - æ¡ä»¶å¯¼å…¥ï¼ˆä¸åŒç¯å¢ƒå¯¼å…¥ä¸åŒæ¨¡å—ï¼‰
         - æ‡’åŠ è½½ä¼˜åŒ–
         - Module Federation

  B. æ·»åŠ å…¥è¾¹ï¼ˆtarget â† originï¼‰
     const targetMgm = this._getModuleGraphModule(module);
     targetMgm.incomingConnections.add(connection);

     æ•°æ®ç»“æ„ â­:
       ä½¿ç”¨ SortableSet è€Œä¸æ˜¯ Set
       åŸå› :
         - éœ€è¦æ’åºï¼ˆæŒ‰ originModuleï¼‰
         - éœ€è¦ç¼“å­˜ï¼ˆgetFromUnorderedCacheï¼‰
         - æ€§èƒ½ä¼˜åŒ–

  C. æ·»åŠ å‡ºè¾¹ï¼ˆorigin â†’ targetï¼‰
     const originMgm = this._getModuleGraphModule(originModule);

     // â­ æ‡’åˆ›å»ºå‡ºè¾¹é›†åˆ
     if (originMgm.outgoingConnections === undefined) {
       originMgm.outgoingConnections = new SortableSet();
     }
     originMgm.outgoingConnections.add(connection);

     // â­â­ å…³é”®ï¼šæ·»åŠ åˆ°æœªåˆ†é…è¿æ¥åˆ—è¡¨
     if (originMgm._unassignedConnections === undefined) {
       originMgm._unassignedConnections = [];
     }
     originMgm._unassignedConnections.push(connection);

     éšè—çŸ¥è¯†ç‚¹ - _unassignedConnections â­â­:
       ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªåˆ—è¡¨ï¼Ÿ

       é—®é¢˜:
         ä¾èµ–æ˜ å°„ (_dependencyMap) ä½•æ—¶å»ºç«‹ï¼Ÿ

       ç­”æ¡ˆ:
         - ä¸æ˜¯ç«‹å³å»ºç«‹ï¼
         - é¦–æ¬¡è®¿é—®æ—¶æ‰å»ºç«‹ ï¼ˆå»¶è¿Ÿå»ºç«‹ï¼‰

       åŸå› :
         - å‡å°‘ Map æ“ä½œ
         - æ‰¹é‡å¤„ç†ä¾èµ–
         - æ€§èƒ½ä¼˜åŒ–

       æ—¶æœº:
         ç¬¬ä¸€æ¬¡è°ƒç”¨ getConnection(dependency) æ—¶
         éå† _unassignedConnections å»ºç«‹æ˜ å°„

  D. å»ºç«‹ä¾èµ–æ˜ å°„ï¼ˆå»¶è¿Ÿï¼‰
     // æ³¨æ„: è¿™é‡Œä¸ç«‹å³è®¾ç½®ï¼
     // this._dependencyMap.set(dependency, connection);

     // åœ¨é¦–æ¬¡ getConnection() æ—¶æ‰è®¾ç½®:
     getConnection(dependency) {
       let conn = this._dependencyMap.get(dependency);
       if (conn === undefined) {
         // å¤„ç†æœªåˆ†é…çš„è¿æ¥
         const mgm = this._getModuleGraphModule(originModule);
         for (const c of mgm._unassignedConnections) {
           this._dependencyMap.set(c.dependency, c);  // â­ æ‰¹é‡å»ºç«‹
         }
         mgm._unassignedConnections.length = 0;  // æ¸…ç©º
       }
       return conn;
     }
  â†“
æ­¥éª¤4.3: è®¾ç½®å¼•å…¥è€…ï¼ˆissuerï¼‰
  moduleGraph.setIssuerIfUnset(module, originModule);

  ä½œç”¨:
    è®°å½•è°ç¬¬ä¸€æ¬¡å¼•å…¥äº†è¿™ä¸ªæ¨¡å—
    ç”¨äºé”™è¯¯æŠ¥å‘Šæ—¶æ˜¾ç¤ºå¼•ç”¨é“¾
```

---

### ğŸ“Œ æ­¥éª¤5è¡¥å……ï¼šæ„å»ºæ¨¡å—çš„å®Œæ•´æµç¨‹ â­â­â­

```
_handleModuleBuildAndDependencies(originModule, module, recursive, callback)
  â†“
æ­¥éª¤5.1: å¾ªç¯æ£€æµ‹ï¼ˆéé€’å½’æ¨¡å¼ï¼‰â­
  if (!recursive && buildQueue.isProcessing(originModule)) {
    // åœ¨æ„å»º origin æ—¶åˆ›å»ºäº† module
    // éœ€è¦æ£€æµ‹æ˜¯å¦å­˜åœ¨æ„å»ºå¾ªç¯

    æ£€æµ‹é€»è¾‘:
      creatingModuleDuringBuild = WeakMap<Module, Set<Module>>

      originModule æ­£åœ¨æ„å»ºï¼Œè®°å½•å®ƒåˆ›å»ºäº† module:
        creatingModuleDuringBuild.get(origin).add(module)

      å¦‚æœ module ä¹Ÿåœ¨æ„å»ºï¼Œä¸”å®ƒä¹Ÿåˆ›å»ºäº† origin:
        creatingModuleDuringBuild.get(module).has(origin)
          â†“
        æ£€æµ‹åˆ°å¾ªç¯ï¼æŠ›å‡º BuildCycleError

    éšè—çŸ¥è¯†ç‚¹ â­:
      ä¸ºä»€ä¹ˆåªåœ¨éé€’å½’æ¨¡å¼æ£€æµ‹ï¼Ÿ

      ç­”æ¡ˆ:
        é€’å½’æ¨¡å¼ï¼ˆrecursive=trueï¼‰:
          A â†’ B â†’ C â†’ A
          æ­£å¸¸çš„å¾ªç¯ä¾èµ–ï¼ŒJavaScript å¯ä»¥å¤„ç†

        éé€’å½’æ¨¡å¼ï¼ˆrecursive=falseï¼‰:
          A æ„å»ºæ—¶åˆ›å»º Bï¼ŒB æ„å»ºæ—¶åˆ›å»º A
          æ„å»ºçº§åˆ«çš„å¾ªç¯ï¼Œä¼šå¯¼è‡´æ­»é”ï¼
  â†“
æ­¥éª¤5.2: buildQueue.add() â­â­â­
  this.buildModule(module, callback)
    â†“ é˜Ÿåˆ—è°ƒåº¦
  _buildModule(module, callback)
    â†“
  æ­¥éª¤5.2.1: needBuild æ£€æŸ¥ â­â­â­
    module.needBuild({
      compilation,
      fileSystemInfo
    }, (err, needBuild) => {

      æ£€æŸ¥é€»è¾‘ï¼ˆlib/NormalModule.jsï¼‰:

        1. æ²¡æœ‰ buildInfo â†’ éœ€è¦æ„å»º
           if (!this.buildInfo) return true;

        2. æ–‡ä»¶æ—¶é—´æˆ³å˜åŒ– â†’ éœ€è¦æ„å»º
           const timestamp = fileSystemInfo.getFileTimestamp(this.resource);
           if (timestamp > this.buildInfo.buildTimestamp) return true;

        3. ä¾èµ–æ–‡ä»¶å˜åŒ– â†’ éœ€è¦æ„å»º
           for (const file of this.buildInfo.fileDependencies) {
             if (fileSystemInfo.getFileTimestamp(file) > timestamp) {
               return true;
             }
           }

        4. æ„å»ºé…ç½®å˜åŒ– â†’ éœ€è¦æ„å»º
           const configHash = this._buildHash;
           if (configHash !== this.buildInfo.hash) return true;

        5. éƒ½æœªå˜åŒ– â†’ ä¸éœ€è¦æ„å»º âœ…
           return false;

      å¢é‡ç¼–è¯‘çš„å…³é”® â­â­â­:
        watch æ¨¡å¼ä¸‹ï¼Œå¤§éƒ¨åˆ†æ¨¡å— needBuild = false
        ç›´æ¥ä½¿ç”¨ç¼“å­˜çš„ buildInfo
        è·³è¿‡ loader å’Œ AST è§£æ
        é€Ÿåº¦æå‡ 10-100 å€ï¼
    })
  â†“
  æ­¥éª¤5.2.2: å¦‚æœä¸éœ€è¦æ„å»º
    this.hooks.stillValidModule.call(module);
    return callback();  // ç›´æ¥è¿”å› âœ…
  â†“
  æ­¥éª¤5.2.3: éœ€è¦æ„å»ºï¼Œæ‰§è¡Œ module.build() â­â­â­
    (lib/NormalModule.js)

    A. è§¦å‘ buildModule é’©å­
       this.hooks.buildModule.call(module);

    B. è°ƒç”¨ _doBuildï¼ˆæ‰§è¡Œ loaderï¼‰â­â­â­

       B1. åˆ›å»º loaderContext
           loaderContext = {
             // æ ¸å¿ƒå±æ€§
             resource: '/project/src/a.js',
             context: '/project/src',
             loaders: [...],
             loaderIndex: 0,

             // Loader APIï¼ˆ40+ æ–¹æ³•ï¼‰
             async: () => callback,
             callback: (err, content, sourceMap, meta) => {},
             cacheable: (flag) => {},
             addDependency: (file) => {},
             addContextDependency: (dir) => {},
             emitFile: (name, content) => {},
             emitWarning: (msg) => {},
             emitError: (msg) => {},
             resolve: (context, request, callback) => {},
             getResolve: (options) => {},

             // ç‰¹æ®Š API
             _compilation: compilation,
             _compiler: compiler,
             _module: module,

             // ... æ›´å¤š API
           }

       B2. æ‰§è¡Œ loader é“¾ â­â­â­
           ä½¿ç”¨ loader-runner åº“:

           runLoaders({
             resource: '/project/src/a.js',
             loaders: [
               { loader: 'babel-loader', options: {...} }
             ],
             context: loaderContext,
             readResource: fs.readFile.bind(fs)
           }, (err, result) => {

             æ‰§è¡Œæµç¨‹ï¼ˆä¸¤é˜¶æ®µï¼‰â­â­:

               é˜¶æ®µ1: Pitchingï¼ˆä»å·¦åˆ°å³ï¼‰
                 for (let i = 0; i < loaders.length; i++) {
                   const pitchResult = loaders[i].pitch();
                   if (pitchResult !== undefined) {
                     // â­ pitch è¿”å›å€¼ï¼Œè·³è¿‡åç»­ loader
                     return pitchResult;
                   }
                 }

               é˜¶æ®µ2: Normalï¼ˆä»å³åˆ°å·¦ï¼‰
                 è¯»å–æ–‡ä»¶:
                   source = fs.readFileSync('/project/src/a.js')

                 æ‰§è¡Œ loader:
                   for (let i = loaders.length - 1; i >= 0; i--) {
                     source = loaders[i].call(context, source);
                   }

                 ç»“æœ: JavaScript ä»£ç å­—ç¬¦ä¸²

             result = {
               result: [code, sourceMap, meta],
               fileDependencies: Set([...]),  // â­ loader è®¿é—®çš„æ–‡ä»¶
               contextDependencies: Set([...]),
               cacheable: true
             }

             éšè—çŸ¥è¯†ç‚¹ - meta.webpackAST â­â­:
               å¦‚æœ loader è¿”å›äº† AST:
                 meta = { webpackAST: ast }

               webpack ä¼šç›´æ¥ä½¿ç”¨è¿™ä¸ª AST
               è·³è¿‡ acorn.parseï¼ˆèŠ‚çœ 20-30% æ—¶é—´ï¼‰

               å“ªäº› loader æ”¯æŒï¼Ÿ
                 - babel-loaderï¼ˆoptions.cacheDirectoryï¼‰
                 - ts-loader
           })

       B3. åˆ›å»º Source å¯¹è±¡
           this._source = this.createSource(
             context,
             code,
             sourceMap
           )

       B4. ä¿å­˜ ASTï¼ˆå¦‚æœæœ‰ï¼‰â­
           this._ast = meta?.webpackAST || null;

    C. è°ƒç”¨ parser.parseï¼ˆè§£æ ASTï¼‰â­â­â­
       (lib/javascript/JavascriptParser.js)

       C1. è·å–æˆ–è§£æ AST
           if (this._ast) {
             ast = this._ast;  // ä½¿ç”¨ loader æä¾›çš„ AST â­
           } else {
             ast = acorn.parse(this._source);  // è§£ææºç 
           }

       C2. åˆå§‹åŒ–ä½œç”¨åŸŸ
           this.scope = {
             topLevelScope: true,
             definitions: new StackedMap(),
             isStrict: false,
             isAsmJs: false,
             inTry: false
           }

       C3. å››è½®éå† AST â­â­â­

           ç¬¬1è½®: detectMode()
             æ£€æµ‹:
               - 'use strict' â†’ scope.isStrict = true
               - 'use asm' â†’ scope.isAsmJs = true

           ç¬¬2è½®: preWalkStatements()
             æ”¶é›†æ‰€æœ‰å£°æ˜ï¼ˆè§£å†³å˜é‡æå‡ï¼‰:
               - import/export å£°æ˜
               - var/let/const å£°æ˜
               - function å£°æ˜
               - class å£°æ˜

             éšè—çŸ¥è¯†ç‚¹ â­â­:
               ä¸ºä»€ä¹ˆéœ€è¦é¢„éå†ï¼Ÿ

               é—®é¢˜ä»£ç :
                 console.log(foo);  // ä½¿ç”¨
                 var foo = 1;       // å£°æ˜ï¼ˆæå‡ï¼‰

               å¦‚æœåªéå†ä¸€æ¬¡:
                 éå†ç¬¬1è¡Œ: foo æœªå®šä¹‰ï¼Œè®¤ä¸ºæ˜¯è‡ªç”±å˜é‡ âŒ
                 éå†ç¬¬2è¡Œ: å‘ç°å£°æ˜ï¼Œä½†å¤ªæ™šäº†

               è§£å†³:
                 ç¬¬2è½®: æ”¶é›†æ‰€æœ‰å£°æ˜ â†’ å»ºç«‹ä½œç”¨åŸŸè¡¨
                 ç¬¬4è½®: ä½¿ç”¨æ—¶æŸ¥è¡¨ â†’ çŸ¥é“æ˜¯å±€éƒ¨å˜é‡ âœ…

           ç¬¬3è½®: blockPreWalkStatements()
             å¤„ç†å—çº§ä½œç”¨åŸŸ:
               { let x = 1; }  // x åªåœ¨å—å†…å¯è§

           ç¬¬4è½®: walkStatements() â­â­â­ æ ¸å¿ƒï¼

             å¯¹æ¯ä¸ªè¯­å¥è°ƒç”¨å¯¹åº”çš„ walk æ–¹æ³•:

               é‡åˆ° ImportDeclaration:
                 walkStatement()
                   â†’ blockPreWalkImportDeclaration()
                   â†’ this.hooks.import.call(statement, source)
                   â†’ HarmonyModulesPlugin ç›‘å¬å™¨:
                     const dep = new HarmonyImportSideEffectDependency(source);
                     module.addDependency(dep);

                   â†’ this.hooks.importSpecifier.call(...)
                   â†’ åˆ›å»ºå…·ä½“çš„å¯¼å…¥ä¾èµ–:
                     import { foo } from './a'
                       â†’ HarmonyImportSpecifierDependency

               é‡åˆ° CallExpressionï¼ˆå¯èƒ½æ˜¯ requireï¼‰:
                 walkCallExpression()
                   â†’ è¯†åˆ« callee.name === 'require'
                   â†’ this.hooks.call.for('require').call(expr)
                   â†’ CommonJsPlugin ç›‘å¬å™¨:
                     const param = this.evaluateExpression(expr.arguments[0]);
                     const dep = new CommonJsRequireDependency(param.string);
                     module.addDependency(dep);

               é‡åˆ° ImportExpressionï¼ˆåŠ¨æ€å¯¼å…¥ï¼‰:
                 walkImportExpression()
                   â†’ this.hooks.importCall.call(expr)
                   â†’ ImportPlugin ç›‘å¬å™¨:
                     // â­â­ åˆ›å»ºå¼‚æ­¥å—
                     const block = new AsyncDependenciesBlock({
                       name: chunkName
                     });
                     const dep = new ImportDependency(request);
                     block.addDependency(dep);
                     module.addBlock(block);  // â­ æ·»åŠ åˆ° blocksï¼Œä¸æ˜¯ dependencies

               é‡åˆ° ExportNamedDeclaration:
                 walkExportNamedDeclaration()
                   â†’ this.hooks.export.call(statement)
                   â†’ this.hooks.exportSpecifier.call(...)
                   â†’ è®°å½•å¯¼å‡ºä¿¡æ¯:
                     module.buildMeta.exportsType = 'namespace'
                     module.buildMeta.providedExports = ['foo', 'bar']

             æ”¶é›†ç»“æœ â­:
               module.dependencies = [
                 HarmonyImportDep('./a.js'),
                 CommonJsRequireDep('./b.js'),
                 ...
               ]

               module.blocks = [
                 AsyncDependenciesBlock {
                   dependencies: [ImportDep('./lazy.js')]
                 }
               ]

               module.buildMeta = {
                 exportsType: 'namespace',
                 providedExports: ['foo', 'bar'],
                 sideEffectFree: false,
                 ...
               }

    D. è§¦å‘ succeedModule é’©å­
       this.hooks.succeedModule.call(module);

    E. ç¼“å­˜æ¨¡å— â­
       this._modulesCache.store(
         module.identifier(),
         null,
         module,
         callback
       )

       ç¼“å­˜åºåˆ—åŒ–çš„å†…å®¹:
         - buildInfo
         - buildMeta
         - dependenciesï¼ˆåºåˆ—åŒ–ä¸ºä¾èµ–æè¿°ç¬¦ï¼‰
         - blocks
         - _source
         - _astï¼ˆå¯é€‰ï¼‰

       ä¸‹æ¬¡æ„å»ºæ—¶æ¢å¤ï¼Œè·³è¿‡ä¸Šè¿°æ‰€æœ‰æ­¥éª¤
```

---

### ğŸ“Œ æ­¥éª¤6è¡¥å……ï¼šå¤„ç†æ¨¡å—ä¾èµ–çš„è¯¦ç»†æµç¨‹ â­â­â­

è¿™æ˜¯ä½ æ€»ç»“ä¸­æœ€éœ€è¦è¡¥å……çš„éƒ¨åˆ†ï¼

```
_handleModuleBuildAndDependencies ç»§ç»­:
  â†“
æ­¥éª¤6: processModuleDependencies(module, callback)
  â†“
processDependenciesQueue.add(module, callback)
  â†“ é˜Ÿåˆ—è°ƒåº¦
_processModuleDependencies(module, callback)
  â†“
ã€æ ¸å¿ƒé€»è¾‘ã€‘ä¸‰ä¸ªé˜¶æ®µ â­â­â­
  â†“
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
é˜¶æ®µ1: éå†ä¾èµ–å—ï¼ˆBFSå¹¿åº¦ä¼˜å…ˆï¼‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

const queue = [module];  // åˆå§‹é˜Ÿåˆ—

while (queue.length > 0) {
  const block = queue.pop();

  // å¤„ç†å—çš„ç›´æ¥ä¾èµ–
  if (block.dependencies) {
    for (const dep of block.dependencies) {
      processDependency(dep, index++);  // å¤„ç†å•ä¸ªä¾èµ–
    }
  }

  // å¤„ç†åµŒå¥—çš„å¼‚æ­¥å—
  if (block.blocks) {
    for (const nestedBlock of block.blocks) {
      queue.push(nestedBlock);  // æ·»åŠ åˆ°é˜Ÿåˆ—
    }
  }
}

éšè—çŸ¥è¯†ç‚¹ â­â­:
  ä¸ºä»€ä¹ˆç”¨ BFS è€Œä¸æ˜¯ DFSï¼Ÿ

  ç­”æ¡ˆ:
    BFS ä¿è¯åŒçº§ä¾èµ–æŒ‰å£°æ˜é¡ºåºå¤„ç†
    DFS ä¼šæ·±å…¥åµŒå¥—å—ï¼Œæ‰“ä¹±é¡ºåº

  å½±å“:
    - æ¨¡å—åŠ è½½é¡ºåº
    - Chunk ç”Ÿæˆé¡ºåº
    - ç¡®å®šæ€§æ„å»º
  â†“
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
é˜¶æ®µ2: ä¾èµ–åˆ†ç»„ï¼ˆä¸‰çº§ç¼“å­˜ä¼˜åŒ–ï¼‰â­â­â­
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

processDependency(dep, index) {
  // è®¾ç½®çˆ¶çº§å¼•ç”¨
  moduleGraph.setParents(dep, block, module, index);

  // è·å–èµ„æºæ ‡è¯†
  const resourceIdent = dep.getResourceIdentifier();
  const category = dep.category;  // 'esm', 'commonjs', etc.
  const constructor = dep.constructor;

  // â­â­â­ ä¸‰çº§ç¼“å­˜ä¼˜åŒ–ï¼ˆæ€§èƒ½å…³é”®ï¼ï¼‰

  // ç¼“å­˜å˜é‡ï¼ˆé—­åŒ…ä½œç”¨åŸŸï¼‰:
  let factoryCacheKey;      // ä¸Šä¸€ä¸ªæ„é€ å‡½æ•°
  let factoryCacheKey2;     // ä¸Šä¸€ä¸ªå·¥å‚
  let factoryCacheValue;    // ä¸Šä¸€ä¸ªå·¥å‚çš„ Map
  let listCacheKey1;        // ä¸Šä¸€ä¸ªç±»åˆ«
  let listCacheKey2;        // ä¸Šä¸€ä¸ªèµ„æº
  let listCacheValue;       // ä¸Šä¸€ä¸ªä¾èµ–åˆ—è¡¨

  // çº§åˆ«1: è¶…å¿«è·¯å¾„ï¼ˆå‘½ä¸­ç‡ ~90%ï¼‰âš¡
  if (factoryCacheKey === constructor) {
    // æ„é€ å‡½æ•°ç›¸åŒï¼
    if (listCacheKey1 === category &&
        listCacheKey2 === resourceIdent) {
      // èµ„æºä¹Ÿç›¸åŒï¼
      listCacheValue.push(dep);  // ç›´æ¥æ·»åŠ 
      return;  // è€—æ—¶ ~0.001ms
    }
  }

  // çº§åˆ«2: å¿«è·¯å¾„ï¼ˆå‘½ä¸­ç‡ ~8%ï¼‰âš¡
  else {
    const factory = dependencyFactories.get(constructor);

    if (factoryCacheKey2 === factory) {
      // å·¥å‚ç›¸åŒï¼
      factoryCacheKey = constructor;

      if (listCacheKey1 === category &&
          listCacheKey2 === resourceIdent) {
        listCacheValue.push(dep);
        return;  // è€—æ—¶ ~0.01ms
      }
    }
  }

  // çº§åˆ«3: æ…¢è·¯å¾„ï¼ˆå‘½ä¸­ç‡ ~2%ï¼‰
  // éœ€è¦ Map æŸ¥æ‰¾å’Œåˆ›å»ºæ–°æ•°ç»„
  // è€—æ—¶ ~0.1ms

  // ç”Ÿæˆç¼“å­˜é”®
  const cacheKey = category === 'esm'
    ? resourceIdent
    : `${category}${resourceIdent}`;

  // è·å–æˆ–åˆ›å»ºä¾èµ–åˆ—è¡¨
  let list = factoryCacheValue.get(cacheKey);
  if (!list) {
    list = [];
    factoryCacheValue.set(cacheKey, list);

    // â­ æ·»åŠ åˆ°sortedDependencies
    sortedDependencies.push({
      factory,
      dependencies: list,
      context,
      originModule: module
    });
  }

  list.push(dep);

  // æ›´æ–°ç¼“å­˜
  listCacheKey1 = category;
  listCacheKey2 = resourceIdent;
  listCacheValue = list;
}

æ€§èƒ½å¯¹æ¯” â­:
  æ— ä¼˜åŒ–ï¼ˆ1000 ä¸ªä¾èµ–ï¼‰:
    1000 * 0.1ms = 100ms

  ä¸‰çº§ç¼“å­˜:
    900 * 0.001ms + 80 * 0.01ms + 20 * 0.1ms
    = 0.9ms + 0.8ms + 2ms
    = 3.7ms

  å¿« 27 å€ï¼â­â­â­
  â†“
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
é˜¶æ®µ3: é€’å½’è°ƒç”¨ handleModuleCreation â­â­â­
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

onDependenciesSorted(err) {
  // å¢åŠ å¹¶è¡Œåº¦ â­â­
  this.processDependenciesQueue.increaseParallelism();

  éšè—çŸ¥è¯†ç‚¹ â­â­:
    ä¸ºä»€ä¹ˆè¦å¢åŠ å¹¶è¡Œåº¦ï¼Ÿ

    é—®é¢˜:
      processDependenciesQueue é»˜è®¤å¹¶è¡Œåº¦ 100
      å³å°†é€’å½’è°ƒç”¨ handleModuleCreation
      è¿™äº›è°ƒç”¨ä¹Ÿä¼šä½¿ç”¨ processDependenciesQueue
      å¦‚æœä¸å¢åŠ å¹¶è¡Œåº¦ â†’ é˜Ÿåˆ—é¥±å’Œ â†’ æ­»é”ï¼

    è§£å†³:
      increaseParallelism() ä¸´æ—¶å¢åŠ å¹¶è¡Œåº¦
      å…è®¸åµŒå¥—çš„é˜Ÿåˆ—ä»»åŠ¡
      å®Œæˆå decreaseParallelism() æ¢å¤

  // å¤„ç†æ‰€æœ‰ä¾èµ–ç»„
  let inProgressTransitive = 1;  // è®¡æ•°å™¨ï¼ˆåˆå§‹å€¼1ï¼‰

  for (const item of sortedDependencies) {
    inProgressTransitive++;  // å¢åŠ è®¡æ•°

    // ğŸ”„ é€’å½’è°ƒç”¨ï¼ˆå…³é”®ï¼ï¼‰
    this.handleModuleCreation(item, err => {
      if (--inProgressTransitive === 0) {
        onTransitiveTasksFinished();  // æ‰€æœ‰å®Œæˆ
      }
    });
  }

  // ä¸»ä»»åŠ¡å®Œæˆ
  if (--inProgressTransitive === 0) {
    onTransitiveTasksFinished();
  }
}

é€’å½’ç»“æ„å¯è§†åŒ– â­â­â­:

entry.js (depth=0)
  â”œâ”€ handleModuleCreation(appDep) ğŸ”„
  â”‚   â”œâ”€ factorize â†’ åˆ›å»º app.js
  â”‚   â”œâ”€ addModule â†’ æ·»åŠ  app.js
  â”‚   â”œâ”€ setResolvedModule â†’ è¿æ¥ entryâ†’app
  â”‚   â”œâ”€ buildModule â†’ æ„å»º app.js
  â”‚   â”‚   â””â”€ parser.parse â†’ æ”¶é›†ä¾èµ– [compDep, utilsDep]
  â”‚   â””â”€ processModuleDependencies(app.js) ğŸ”„
  â”‚       â”œâ”€ handleModuleCreation(compDep) ğŸ”„
  â”‚       â”‚   â”œâ”€ factorize â†’ åˆ›å»º component.js
  â”‚       â”‚   â”œâ”€ addModule â†’ æ·»åŠ  component.js
  â”‚       â”‚   â”œâ”€ buildModule â†’ æ„å»º component.js
  â”‚       â”‚   â””â”€ processModuleDependencies(component.js) ğŸ”„
  â”‚       â”‚       â””â”€ ... (å¦‚æœæœ‰ä¾èµ–ç»§ç»­é€’å½’)
  â”‚       â””â”€ handleModuleCreation(utilsDep) ğŸ”„
  â”‚           â””â”€ ...
  â””â”€ handleModuleCreation(configDep) ğŸ”„
      â””â”€ ...

åœæ­¢æ¡ä»¶:
  1. æ¨¡å—æ— ä¾èµ–ï¼ˆå¶å­èŠ‚ç‚¹ï¼‰
  2. æ¨¡å—å·²å­˜åœ¨ï¼ˆå»é‡ï¼‰
  3. ä¾èµ–é˜Ÿåˆ—ä¸ºç©ºï¼ˆå®Œæˆï¼‰
```

---

### ğŸ“Œ æ­¥éª¤7è¡¥å……ï¼šMake é˜¶æ®µå®Œæˆï¼ˆä½ çš„æ€»ç»“ç¼ºå°‘è¿™ä¸ªï¼ï¼‰â­â­

```
æ‰€æœ‰å…¥å£çš„ addEntry å›è°ƒéƒ½å®Œæˆå:
  â†“
make é’©å­çš„ callback æ‰§è¡Œ
  â†“
lib/Compiler.js: compile() ç»§ç»­æ‰§è¡Œ
  â†“
logger.timeEnd("make hook");
  â†“
è§¦å‘ finishMake é’©å­ â­:
  this.hooks.finishMake.callAsync(compilation, err => {

    ä½œç”¨:
      æ’ä»¶å¯ä»¥åœ¨è¿™é‡Œåšæœ€åçš„æ¨¡å—æ·»åŠ 
      ä¾‹å¦‚: RuntimeChunkPlugin æ·»åŠ è¿è¡Œæ—¶æ¨¡å—
    â†“
    process.nextTick(() => {  // â­ å»¶è¿Ÿåˆ°ä¸‹ä¸€ä¸ª tick

      éšè—çŸ¥è¯†ç‚¹ â­â­:
        ä¸ºä»€ä¹ˆè¦ nextTickï¼Ÿ

        åŸå› :
          1. æ¸…ç©ºè°ƒç”¨æ ˆ
          2. é¿å…æ ˆæº¢å‡º
          3. è®©äº‹ä»¶å¾ªç¯å¤„ç†å…¶ä»–ä»»åŠ¡

        å½±å“:
          make é’©å­å’Œ finishMake é’©å­ä¹‹é—´
          æœ‰ä¸€ä¸ªå¾®å°çš„æ—¶é—´é—´éš”
          æŸäº›å¼‚æ­¥æ’ä»¶å¯ä»¥åˆ©ç”¨è¿™ä¸ªé—´éš”
      â†“
      logger.time("finish make hook");

      compilation.finish(err => {
        logger.timeEnd("finish make hook");

        finish() å†…éƒ¨ â­â­:

          A. æ¸…ç† factorizeQueue
             this.factorizeQueue.clear();
             // Make é˜¶æ®µä¸å†éœ€è¦åˆ›å»ºæ¨¡å—

          B. è®¡ç®—æ€§èƒ½æ•°æ®ï¼ˆå¦‚æœå¯ç”¨ --profileï¼‰
             ParallelismFactorCalculator
             â†“
             è®¡ç®—å„é˜¶æ®µçš„å¹¶è¡Œå› å­:
               - buildingParallelismFactor
               - factoryParallelismFactor
               - integrationParallelismFactor

             å¹¶è¡Œå› å­ = æŸæ—¶åˆ»åŒæ—¶å¤„ç†çš„æ¨¡å—æ•°
             ä¾‹å¦‚: 4.2 è¡¨ç¤ºå¹³å‡æœ‰ 4.2 ä¸ªæ¨¡å—å¹¶è¡Œæ„å»º

          C. è®¡ç®—å—å½±å“çš„æ¨¡å—ï¼ˆå¢é‡ç¼–è¯‘ä¼˜åŒ–ï¼‰â­â­
             _computeAffectedModules(this.modules)

             ä½œç”¨:
               æ¯”è¾ƒæ¨¡å—çš„ buildInfo
               åˆ¤æ–­å“ªäº›æ¨¡å—éœ€è¦é‡æ–°å¤„ç†

             æ£€æŸ¥:
               - buildInfo.hash å˜åŒ–ï¼Ÿ
               - ä¾èµ–å¼•ç”¨å˜åŒ–ï¼Ÿ
               - æ–‡ä»¶æ—¶é—´æˆ³å˜åŒ–ï¼Ÿ

             ç»“æœ:
               affectedModules = Set([...])
               â†’ Seal é˜¶æ®µåªå¤„ç†å—å½±å“çš„æ¨¡å—

          D. è§¦å‘ finishModules é’©å­ â­
             this.hooks.finishModules.callAsync(modules, err => {

               æ’ä»¶å¯ä»¥:
                 - åˆ é™¤æ¨¡å—
                 - ä¿®æ”¹æ¨¡å—
                 - æ·»åŠ é¢å¤–çš„æ¨¡å—
             })

          E. æŠ¥å‘Šæ¨¡å—é”™è¯¯å’Œè­¦å‘Š
             for (const module of modules) {
               // æ”¶é›†æ¨¡å—çš„é”™è¯¯å’Œè­¦å‘Š
               const errors = module.getErrors();
               const warnings = module.getWarnings();

               // æ·»åŠ åˆ° compilation
               this.errors.push(...errors);
               this.warnings.push(...warnings);

               // æŠ¥å‘Šä¾èµ–é”™è¯¯
               this.reportDependencyErrorsAndWarnings(module);
             }

          F. å†»ç»“ ModuleGraph â­
             this.moduleGraph.freeze("dependency errors");

             ä½œç”¨:
               - æ ‡è®° ModuleGraph åªè¯»
               - å¼€å¯ç¼“å­˜
               - æ£€æµ‹éæ³•ä¿®æ”¹
        â†“
        callback();  // finish å®Œæˆ
      });
    });
  });
  â†“
è¿›å…¥ Seal é˜¶æ®µ:
  compilation.seal(callback);
```

---

## ğŸ¯ å®Œæ•´çš„ Make é˜¶æ®µæµç¨‹å›¾ï¼ˆä¿®æ­£ç‰ˆï¼‰

```mermaid
graph TB
    Start["make é’©å­è§¦å‘<br/>AsyncParallelHook"] --> Entry["EntryPlugin ç›‘å¬å™¨<br/>æ‰§è¡Œ"]

    Entry --> AddEntry["addEntry<br/>æ·»åŠ å…¥å£ä¾èµ–"]

    AddEntry --> EntryItem["_addEntryItem<br/>â”œâ”€ åˆ›å»º/æ›´æ–° entryData<br/>â”œâ”€ åˆå¹¶é€‰é¡¹<br/>â””â”€ è§¦å‘ addEntry é’©å­"]

    EntryItem --> Tree["addModuleTree<br/>å¼€å§‹æ¨¡å—æ ‘æ„å»º"]

    Tree --> FindFactory["æŸ¥æ‰¾ä¾èµ–å·¥å‚<br/>dependencyFactories.get"]

    FindFactory --> Handle["â­â­â­ handleModuleCreation<br/>åè°ƒå››ä¸ªé˜Ÿåˆ—"]

    Handle --> Q1["é˜Ÿåˆ—1: factorizeQueue<br/>åˆ›å»ºæ¨¡å—å®ä¾‹"]

    Q1 --> Factory["NormalModuleFactory.create:<br/>â”œâ”€ beforeResolve é’©å­<br/>â”œâ”€ è§£æè·¯å¾„ enhanced-resolve<br/>â”œâ”€ åŒ¹é… loader ruleSet.exec<br/>â”œâ”€ åˆå¹¶ loader é“¾<br/>â”œâ”€ afterResolve é’©å­<br/>â”œâ”€ ç¡®å®š parser/generator<br/>â”œâ”€ createModule é’©å­<br/>â””â”€ new NormalModule"]

    Factory --> Q2["é˜Ÿåˆ—2: addModuleQueue<br/>æ·»åŠ æ¨¡å—å»é‡"]

    Q2 --> Dedup{"æ¨¡å—å·²å­˜åœ¨?<br/>_modules.get"}

    Dedup -->|æ˜¯| UseExist["â­ å¤ç”¨ç°æœ‰æ¨¡å—<br/>å»é‡æœºåˆ¶"]
    Dedup -->|å¦| CheckCache{"æŒä¹…åŒ–ç¼“å­˜?<br/>_modulesCache.get"}

    CheckCache -->|æœ‰| Restore["æ¢å¤ç¼“å­˜:<br/>â”œâ”€ buildInfo<br/>â”œâ”€ buildMeta<br/>â”œâ”€ dependencies<br/>â”œâ”€ _source<br/>â””â”€ _ast â­"]
    CheckCache -->|æ— | AddNew["æ·»åŠ åˆ° modules<br/>_modules.set"]

    UseExist --> Connect
    Restore --> AddNew
    AddNew --> Connect["å»ºç«‹ ModuleGraph è¿æ¥<br/>setResolvedModule"]

    Connect --> CreateConn["åˆ›å»º ModuleGraphConnection:<br/>â”œâ”€ originModule<br/>â”œâ”€ dependency<br/>â”œâ”€ module<br/>â””â”€ condition â­"]

    CreateConn --> AddEdge["æ·»åŠ å›¾è¾¹:<br/>â”œâ”€ target.incoming.add<br/>â”œâ”€ origin.outgoing.add<br/>â””â”€ _unassignedConnections â­â­"]

    AddEdge --> Q3["é˜Ÿåˆ—3: buildQueue<br/>æ„å»ºæ¨¡å—"]

    Q3 --> NeedBuild{"needBuild?<br/>æ£€æŸ¥æ–‡ä»¶æ—¶é—´æˆ³"}

    NeedBuild -->|å¦| UseCache["â­ ä½¿ç”¨ç¼“å­˜<br/>è§¦å‘ stillValidModule"]
    NeedBuild -->|æ˜¯| DoBuild["module.build<br/>_doBuild"]

    DoBuild --> Loader["loader-runner:<br/>â”œâ”€ Pitching é˜¶æ®µ â†’<br/>â”œâ”€ è¯»å–æ–‡ä»¶<br/>â””â”€ Normal é˜¶æ®µ â†<br/>â­ meta.webpackAST ä¼˜åŒ–"]

    Loader --> Parse["JavascriptParser.parse:<br/>â”œâ”€ acorn.parse AST<br/>â”œâ”€ å››è½®éå† â­â­â­<br/>â””â”€ è¯†åˆ«ä¾èµ–"]

    Parse --> FourPass["ç¬¬1è½®: detectMode<br/>ç¬¬2è½®: preWalk æ”¶é›†å£°æ˜<br/>ç¬¬3è½®: blockPreWalk<br/>â­â­â­ ç¬¬4è½®: walk è¯†åˆ«ä¾èµ–"]

    FourPass --> Deps["æ”¶é›†ç»“æœ:<br/>â”œâ”€ module.dependencies<br/>â”œâ”€ module.blocks<br/>â””â”€ module.buildMeta"]

    Deps --> Cache2["ç¼“å­˜æ¨¡å—<br/>_modulesCache.store"]

    UseCache --> Q4
    Cache2 --> Q4["é˜Ÿåˆ—4: processDependenciesQueue<br/>å¤„ç†ä¾èµ–"]

    Q4 --> Traverse["BFS éå†ä¾èµ–å—<br/>â­ å¹¿åº¦ä¼˜å…ˆ"]

    Traverse --> Group["ä¾èµ–åˆ†ç»„:<br/>â­â­â­ ä¸‰çº§ç¼“å­˜ä¼˜åŒ–<br/>æŒ‰å·¥å‚+èµ„æºåˆ†ç»„"]

    Group --> IncrPara["å¢åŠ é˜Ÿåˆ—å¹¶è¡Œåº¦<br/>increaseParallelism"]

    IncrPara --> Recurse["éå†ä¾èµ–ç»„"]

    Recurse -->|æ¯ä¸ªç»„| Handle2["ğŸ”„ é€’å½’ handleModuleCreation"]

    Handle2 --> Handle

    Recurse -->|å…¨éƒ¨å®Œæˆ| DecrPara["æ¢å¤é˜Ÿåˆ—å¹¶è¡Œåº¦<br/>decreaseParallelism"]

    DecrPara --> AllDone{"æ‰€æœ‰ä¾èµ–<br/>éƒ½å·²å¤„ç†?"}

    AllDone -->|æ˜¯| FinishMake["finishMake é’©å­<br/>â­ process.nextTick"]
    AllDone -->|å¦| Recurse

    FinishMake --> Finish["compilation.finish:<br/>â”œâ”€ æ¸…ç†é˜Ÿåˆ—<br/>â”œâ”€ è®¡ç®—æ€§èƒ½æ•°æ®<br/>â”œâ”€ è®¡ç®—å—å½±å“æ¨¡å—<br/>â”œâ”€ finishModules é’©å­<br/>â”œâ”€ æŠ¥å‘Šé”™è¯¯è­¦å‘Š<br/>â””â”€ å†»ç»“ ModuleGraph"]

    Finish --> Result["âœ… Make é˜¶æ®µå®Œæˆ<br/><br/>ç»“æœ:<br/>âœ… modules é›†åˆ<br/>âœ… ModuleGraph å®Œæ•´<br/>âœ… ä¾èµ–å›¾å»ºç«‹<br/>âœ… å¯¼å‡ºä¿¡æ¯æ”¶é›†"]

    Result --> Next([ä¸‹ä¸€é˜¶æ®µ:<br/>Seal å°è£…])

    style Handle fill:#ff6666
    style Factory fill:#ffcc99
    style Parse fill:#ffcc99
    style FourPass fill:#99ff99
    style Group fill:#ff9999
    style Handle2 fill:#ff6666
```

---

## ğŸ’ æºç ä¸­çš„éšè—çŸ¥è¯†ç‚¹å’Œæœ€ä½³å®è·µ

### çŸ¥è¯†ç‚¹1: é˜Ÿåˆ—çš„çˆ¶å­å…³ç³» â­â­â­

```
é˜Ÿåˆ—å®šä¹‰ï¼ˆlib/Compilation.js æ„é€ å‡½æ•°ï¼‰:

processDependenciesQueue
  â†‘ parent
addModuleQueue
  â†‘ parent
factorizeQueue
  â†‘ parent
buildQueue

çˆ¶å­å…³ç³»çš„ç¥å¥‡ä¹‹å¤„ â­â­â­:

åœºæ™¯: å¤„ç† module1 çš„ä¾èµ–æ—¶ï¼Œéœ€è¦åˆ›å»º module2

processDependenciesQueue å¤„ç† module1
  â†“ è°ƒç”¨ handleModuleCreation(dep2)
  â†“ éœ€è¦ factorize module2
  â†“ factorizeQueue.add(module2)
  â†“ ä½† processDependenciesQueue è¿˜åœ¨å¤„ç† module1
  â†“ å¦‚æœæ²¡æœ‰çˆ¶å­å…³ç³» â†’ æ­»é”ï¼

æœ‰äº†çˆ¶å­å…³ç³»:
  factorizeQueue å‘ç°æœ‰ parent
  â†’ é€šçŸ¥ parent ç­‰å¾…
  â†’ processDependenciesQueue æš‚åœ module1
  â†’ factorizeQueue å¤„ç† module2
  â†’ factorizeQueue å®Œæˆ
  â†’ processDependenciesQueue æ¢å¤ module1

å®ç°åŸç†ï¼ˆlib/util/AsyncQueue.jsï¼‰:

  å­é˜Ÿåˆ—å¯åŠ¨æ—¶:
    if (this._parent) {
      this._parent._activeTasks++;  // â­ å¢åŠ çˆ¶é˜Ÿåˆ—ä»»åŠ¡è®¡æ•°
    }

  å­é˜Ÿåˆ—å®Œæˆæ—¶:
    if (this._parent) {
      this._parent._activeTasks--;  // â­ å‡å°‘çˆ¶é˜Ÿåˆ—ä»»åŠ¡è®¡æ•°
      this._parent._ensureProcessing();  // æ¢å¤çˆ¶é˜Ÿåˆ—
    }

æ€§èƒ½ä¼˜åŠ¿:
  - é¿å…æ­»é”
  - è‡ªåŠ¨è°ƒåº¦
  - æœ€å¤§åŒ–å¹¶è¡Œåº¦
```

### çŸ¥è¯†ç‚¹2: ä¸å®‰å…¨ç¼“å­˜çš„æ·±åº¦ä¼˜åŒ– â­â­

```
é…ç½®:
  module.exports = {
    module: {
      unsafeCache: true  // æˆ–å‡½æ•°
    }
  }

å·¥ä½œåŸç† â­â­â­:

å…¨å±€ WeakMapï¼ˆæ¨¡å—ä½œç”¨åŸŸï¼‰:
  const unsafeCacheDependencies = new WeakMap<Dependency, Module>();
  const unsafeCacheData = new WeakMap<Module, CacheData>();

é¦–æ¬¡ç¼–è¯‘:
  æ„å»º module1
    â†’ æ·»åŠ ä¾èµ– dep1
    â†’ åˆ›å»º module2
    â†’ unsafeCacheDependencies.set(dep1, module2)  // â­ è®°å½•
    â†’ unsafeCacheData.set(module2, {
        buildInfo,
        buildMeta,
        dependencies,
        ...
      })

ç¬¬äºŒæ¬¡ç¼–è¯‘ï¼ˆæ–‡ä»¶æœªå˜ï¼‰:
  æ„å»º module1
    â†’ é‡åˆ°ä¾èµ– dep1
    â†’ cached = unsafeCacheDependencies.get(dep1)  // â­ å‘½ä¸­
    â†’ if (cached) {
        // ç›´æ¥ä½¿ç”¨ç¼“å­˜çš„ module2
        // è·³è¿‡ factorizeã€resolveã€build âœ…
        moduleGraph.setResolvedModule(module1, dep1, cached);
        return;  // å®Œæˆï¼
      }

æ€§èƒ½å¯¹æ¯”:
  å®‰å…¨ç¼“å­˜:
    æ£€æŸ¥æ—¶é—´æˆ³ â†’ è¯»å–ç¼“å­˜ â†’ ååºåˆ—åŒ–
    = 10ms

  ä¸å®‰å…¨ç¼“å­˜:
    WeakMap æŸ¥æ‰¾
    = 0.01ms

  å¿« 1000 å€ï¼â­â­â­

é£é™©:
  å¦‚æœæ–‡ä»¶è¢«å¤–éƒ¨å·¥å…·ä¿®æ”¹ï¼ˆä¸é€šè¿‡ webpack watchï¼‰
  â†’ webpack ä¸çŸ¥é“å˜åŒ–
  â†’ ä½¿ç”¨æ—§çš„æ¨¡å—
  â†’ ç»“æœé”™è¯¯ âŒ

æ¨èç”¨æ³•:
  åªå¯¹ node_modules å¯ç”¨:
    unsafeCache: (module) => {
      return /node_modules/.test(module.resource);
    }
```

### çŸ¥è¯†ç‚¹3: ä¾èµ–çš„ getResourceIdentifier æœºåˆ¶ â­â­

```
ä¸ºä»€ä¹ˆéœ€è¦ resourceIdentifierï¼Ÿ

é—®é¢˜:
  å¤šä¸ªä¸åŒçš„ä¾èµ–å¯èƒ½æŒ‡å‘åŒä¸€ä¸ªèµ„æº

  ä¾‹å¦‚:
    import './a'
    require('./a')
    import('./a')

  è¿™ä¸‰ä¸ªä¾èµ–:
    - ç±»å‹ä¸åŒï¼ˆHarmonyImportã€CommonJsRequireã€Importï¼‰
    - ä½†æŒ‡å‘åŒä¸€ä¸ªæ–‡ä»¶ './a'

è§£å†³:
  dependency.getResourceIdentifier() è¿”å›ç»Ÿä¸€çš„æ ‡è¯†

  ä¾‹å¦‚ï¼ˆlib/dependencies/HarmonyImportSideEffectDependency.jsï¼‰:
    getResourceIdentifier() {
      return `harmony-side-effect ${this.request}`;
    }

  ä¾‹å¦‚ï¼ˆlib/dependencies/CommonJsRequireDependency.jsï¼‰:
    getResourceIdentifier() {
      return `commonjs ${this.request}`;
    }

ä½œç”¨:
  processDependencyForResolving ä¸­:
    const ident = dep.getResourceIdentifier();
    const cacheKey = category === 'esm' ? ident : `${category}${ident}`;

    ç›¸åŒ cacheKey çš„ä¾èµ– â†’ åˆ†åˆ°åŒä¸€ç»„
    â†’ ä¸€èµ·å¤„ç†ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰

ä¼˜åŒ–æ•ˆæœ:
  100 ä¸ªä¾èµ–æŒ‡å‘ 10 ä¸ªæ–‡ä»¶
  â†’ åªè°ƒç”¨ 10 æ¬¡ handleModuleCreation
  â†’ æ¯æ¬¡å¤„ç†ä¸€ç»„ä¾èµ–
  â†’ å‡å°‘ 90% çš„å·¥å‚è°ƒç”¨
```

### çŸ¥è¯†ç‚¹4: é”™è¯¯çš„ stack é‡èµ‹å€¼æŠ€å·§è¯¦è§£ â­â­â­

```
ä»£ç ä½ç½®ï¼ˆå¤šå¤„ï¼‰:
  if (err && this.bail) {
    err.stack = err.stack;  // â­â­â­ çœ‹èµ·æ¥æ²¡ç”¨ï¼Œä½†éå¸¸é‡è¦ï¼
    callback(err);
  }

é—®é¢˜åˆ†æ â­â­â­:

V8 å¼•æ“çš„ Error å¯¹è±¡å†…éƒ¨ç»“æ„:

  Error {
    message: '...',
    stack: '...',

    // â­ éšè—å±æ€§ï¼ˆV8 å†…éƒ¨ï¼‰
    [[InternalStack]]: [
      é—­åŒ…å¼•ç”¨ â†’ onDependenciesSortedå‡½æ•°
        â†“ å¼•ç”¨äº†
      sortedDependencies å˜é‡
        â†“ å¼•ç”¨äº†
      factory å¯¹è±¡
        â†“ å¼•ç”¨äº†
      compilation å¯¹è±¡ (10MB+)
    ]
  }

å†…å­˜æ³„æ¼åœºæ™¯:
  ç¼–è¯‘å‡ºé”™ â†’ åˆ›å»º Error
  â†’ Error.[[InternalStack]] ä¿æŒå¯¹ Compilation çš„å¼•ç”¨
  â†’ Compilation æ— æ³•è¢« GC
  â†’ æ¯æ¬¡ç¼–è¯‘æ³„æ¼ 10MB+
  â†’ å¤šæ¬¡ç¼–è¯‘åå†…å­˜çˆ†ç‚¸ âŒ

è§£å†³åŸç†:
  err.stack = err.stack;
    â†“ V8 å¼•æ“å¤„ç†

  1. è¯»å– err.stackï¼ˆè§¦å‘ getterï¼‰
  2. V8 æ ¼å¼åŒ–å †æ ˆä¸ºå­—ç¬¦ä¸²
  3. èµ‹å€¼å› err.stackï¼ˆè§¦å‘ setterï¼‰
  4. V8 å‘ç°æ˜¯å­—ç¬¦ä¸²ï¼Œä¸¢å¼ƒ [[InternalStack]]
  5. é—­åŒ…å¼•ç”¨é“¾æ–­å¼€ âœ…
  6. Compilation å¯ä»¥è¢« GC âœ…

å†…å­˜å¯¹æ¯”:
  ä¸å¤„ç†: Error ä¿æŒ ~10MB Compilation å¼•ç”¨
  å¤„ç†å: Error åªä¿æŒ stack å­—ç¬¦ä¸² ~1KB

  èŠ‚çœ 10,000 å€å†…å­˜ï¼â­â­â­
```

### çŸ¥è¯†ç‚¹5: æ¨¡å—æ·±åº¦ï¼ˆdepthï¼‰çš„è®¡ç®—å’Œä½œç”¨ â­â­

```
è®¡ç®—æ—¶æœºï¼ˆlib/Compilation.js: sealï¼‰:

for (const [name, entryData] of this.entries) {
  const entryModules = new Set();

  // æ”¶é›†å…¥å£æ¨¡å—
  for (const dep of entryData.dependencies) {
    const module = moduleGraph.getModule(dep);
    entryModules.add(module);
  }

  // â­ è®¡ç®—æ·±åº¦
  this.assignDepths(entryModules);
}

è®¡ç®—ç®—æ³•ï¼ˆBFSï¼‰:

assignDepths(modules) {
  const queue = new Set(modules);
  queue.add(1);  // â­ æ·»åŠ æ·±åº¦åˆ†éš”ç¬¦
  let depth = 0;

  for (const item of queue) {
    if (typeof item === 'number') {
      // é‡åˆ°åˆ†éš”ç¬¦ï¼Œæ·±åº¦+1
      depth = item;
      queue.add(depth + 1);  // æ·»åŠ ä¸‹ä¸€å±‚åˆ†éš”ç¬¦
    } else {
      // å¤„ç†æ¨¡å—
      moduleGraph.setDepth(item, depth);

      // æ·»åŠ æ‰€æœ‰ä¾èµ–åˆ°é˜Ÿåˆ—
      for (const conn of moduleGraph.getOutgoingConnections(item)) {
        queue.add(conn.module);
      }
    }
  }
}

å¯è§†åŒ–:

queue = [entry, 1]  depth = 0
  â†“ å¤„ç† entry
queue = [1, a, b]  depth = 0
  â†“ é‡åˆ°åˆ†éš”ç¬¦ 1
queue = [a, b, 2]  depth = 1
  â†“ å¤„ç† a
queue = [b, 2, common]  depth = 1
  â†“ å¤„ç† b
queue = [2, common, common]  depth = 1
  â†“ é‡åˆ°åˆ†éš”ç¬¦ 2
queue = [common, common, 3]  depth = 2
  â†“ å¤„ç† common
queue = [common, 3]  depth = 2
  â†“ common å·²å¤„ç†ï¼Œè·³è¿‡
queue = [3]  depth = 2
  â†“ é˜Ÿåˆ—ä¸ºç©ºï¼Œå®Œæˆ

ç»“æœ:
  entry.depth = 0
  a.depth = 1
  b.depth = 1
  common.depth = 2  â­ è¢«ä¸¤ä¸ªæ¨¡å—ä¾èµ–ï¼Œå–æœ€å¤§æ·±åº¦

æ·±åº¦çš„ä½œç”¨ â­â­:
  1. æ¨¡å—æ’åºï¼ˆè¾“å‡ºç¡®å®šæ€§ï¼‰
  2. Chunk ä¼˜åŒ–ï¼ˆæ·±å±‚æ¨¡å—ä¼˜å…ˆæå–ï¼‰
  3. é¢„åŠ è½½æç¤ºï¼ˆPrefetch/Preloadï¼‰
  4. ç»Ÿè®¡æŠ¥å‘Š
```

### çŸ¥è¯†ç‚¹6: fileDependencies çš„å®Œæ•´æ”¶é›†é“¾ â­â­

```
æ–‡ä»¶ä¾èµ–çš„æ”¶é›†è¿‡ç¨‹ï¼ˆå¤šä¸ªæ¥æºï¼‰:

æ¥æº1: è·¯å¾„è§£æé˜¶æ®µ
  NormalModuleFactory.create() ä¸­:
    resolver.resolve(..., resolveContext, callback)

    resolveContext.fileDependencies = LazySet

    resolver å†…éƒ¨ä¼šæ·»åŠ :
      - å°è¯•çš„æ–‡ä»¶è·¯å¾„
      - package.json æ–‡ä»¶
      - tsconfig.json æ–‡ä»¶
      - ç¬¦å·é“¾æ¥ç›®æ ‡

æ¥æº2: Loader æ‰§è¡Œé˜¶æ®µ
  loader-runner æ‰§è¡Œæ—¶:
    loaderContext.addDependency(file)

    loader å¯ä»¥æ·»åŠ :
      - è¯»å–çš„é…ç½®æ–‡ä»¶ï¼ˆ.babelrcï¼‰
      - å¼•å…¥çš„å…¶ä»–æ–‡ä»¶
      - ç”Ÿæˆçš„ä¸´æ—¶æ–‡ä»¶

æ¥æº3: æ¨¡å—æ„å»ºé˜¶æ®µ
  module.build() ä¸­:
    this.buildInfo.fileDependencies = new Set([
      this.resource,  // æ¨¡å—æ–‡ä»¶æœ¬èº«
      ...resolverFileDeps,
      ...loaderFileDeps
    ])

æ¥æº4: æ±‡æ€»åˆ° compilation
  handleModuleCreation å›è°ƒä¸­:
    if (factoryResult.fileDependencies) {
      this.fileDependencies.addAll(
        factoryResult.fileDependencies
      );
    }

æœ€ç»ˆç»“æœ:
  compilation.fileDependencies = LazySet([
    '/project/src/index.js',
    '/project/src/a.js',
    '/project/src/b.js',
    '/project/package.json',
    '/project/node_modules/lodash/package.json',
    '/project/.babelrc',
    ... æ‰€æœ‰ç›¸å…³æ–‡ä»¶
  ])

Watch æ¨¡å¼ä½¿ç”¨ â­â­:
  watcher.watch(
    compilation.fileDependencies,  // ç›‘å¬è¿™äº›æ–‡ä»¶
    compilation.contextDependencies,
    compilation.missingDependencies,
    (err, fileTimestamps, contextTimestamps) => {
      // æ–‡ä»¶å˜åŒ– â†’ é‡æ–°ç¼–è¯‘
      compiler.compile(callback);
    }
  )
```

### çŸ¥è¯†ç‚¹7: å¼‚æ­¥å—ï¼ˆAsyncDependenciesBlockï¼‰çš„ç‰¹æ®Šå¤„ç† â­â­â­

```
å¼‚æ­¥å¯¼å…¥çš„å¤„ç†ï¼ˆä½ çš„æ€»ç»“ä¸­ç¼ºå¤±ï¼‰:

æºç :
  const component = await import('./component.js');

parser è¯†åˆ«:
  walkImportExpression(expr) {
    this.hooks.importCall.call(expr);
  }

ImportPlugin å¤„ç†:
  parser.hooks.importCall.tap((expr) => {
    // â­â­ åˆ›å»ºå¼‚æ­¥å—ï¼ˆä¸æ˜¯ç›´æ¥æ·»åŠ ä¾èµ–ï¼ï¼‰
    const block = new AsyncDependenciesBlock({
      name: chunkName,  // ä»é­”æ³•æ³¨é‡Šæå–
      ...groupOptions
    });

    const dep = new ImportDependency(request, expr.range);
    block.addDependency(dep);  // æ·»åŠ åˆ°å—

    // â­ æ·»åŠ åˆ°æ¨¡å—çš„ blocksï¼Œä¸æ˜¯ dependenciesï¼
    module.addBlock(block);
  })

å…³é”®åŒºåˆ« â­â­â­:

åŒæ­¥ä¾èµ–:
  module.dependencies = [dep1, dep2, ...]
  â†’ processModuleDependencies éå† dependencies
  â†’ ç›®æ ‡æ¨¡å—æ·»åŠ åˆ°åŒä¸€ä¸ª Chunk

å¼‚æ­¥ä¾èµ–:
  module.blocks = [block1, block2, ...]
  block.dependencies = [dep3, dep4, ...]
  â†’ processModuleDependencies ä¹Ÿä¼šéå† blocks
  â†’ ä½†åœ¨ Seal é˜¶æ®µåˆ›å»ºæ–°çš„ Chunk â­â­â­

Seal é˜¶æ®µå¤„ç†ï¼ˆlib/buildChunkGraph.jsï¼‰:
  éå† module.blocks:
    for (const block of module.blocks) {
      // â­ åˆ›å»ºæ–° Chunk
      const newChunk = new Chunk(block.chunkName);

      // â­ å»ºç«‹çˆ¶å­å…³ç³»
      mainChunk.addChild(newChunk);

      // â­ æ·»åŠ æ¨¡å—åˆ°æ–° Chunk
      for (const dep of block.dependencies) {
        const depModule = moduleGraph.getModule(dep);
        chunkGraph.connectChunkAndModule(newChunk, depModule);
      }
    }

ç»“æœ:
  entry.js (main chunk)
    â”œâ”€ app.js (main chunk)
    â””â”€ import('./lazy.js') â†’ åˆ›å»º lazy chunk
        â””â”€ lazy.js (lazy chunk)
```

### çŸ¥è¯†ç‚¹8: è¡¨è¾¾å¼æ±‚å€¼çš„å¼ºå¤§èƒ½åŠ› â­â­

```
parser çš„è¡¨è¾¾å¼æ±‚å€¼ï¼ˆlib/javascript/JavascriptParser.jsï¼‰:

åœºæ™¯1: å¸¸é‡æŠ˜å 
  æºç :
    if (1 + 2 === 3) {
      import('./a');
    }

  parser å¤„ç†:
    evaluateExpression(1 + 2)
      â†’ BasicEvaluatedExpression.setNumber(3)

    evaluateExpression(3 === 3)
      â†’ BasicEvaluatedExpression.setBoolean(true)

    walkIfStatement() å‘ç°æ¡ä»¶ä¸º true
      â†’ åª walk consequent
      â†’ åˆ é™¤ alternate åˆ†æ”¯ â­

  ç»“æœ:
    import('./a');  // ä¿ç•™
    // alternate åˆ†æ”¯è¢«åˆ é™¤ï¼Œä¸ç”Ÿæˆä»£ç 

åœºæ™¯2: ç¯å¢ƒå˜é‡
  æºç :
    if (process.env.NODE_ENV === 'production') {
      // ç”Ÿäº§ä»£ç 
    } else {
      // å¼€å‘ä»£ç 
    }

  DefinePlugin é…ç½®:
    new webpack.DefinePlugin({
      'process.env.NODE_ENV': JSON.stringify('production')
    })

  parser å¤„ç†:
    DefinePlugin æ³¨å†Œé’©å­:
      parser.hooks.expression.for('process.env.NODE_ENV').tap(() => {
        return new BasicEvaluatedExpression()
          .setString('production')
          .setRange(expr.range);
      })

    evaluateExpression('production' === 'production')
      â†’ setBoolean(true)

    walkIfStatement() å‘ç°æ¡ä»¶ä¸º true
      â†’ åªä¿ç•™ if åˆ†æ”¯
      â†’ åˆ é™¤ else åˆ†æ”¯ â­â­

  ç”Ÿæˆä»£ç :
    // ç”Ÿäº§ä»£ç ï¼ˆä¿ç•™ï¼‰
    // else åˆ†æ”¯å®Œå…¨åˆ é™¤ï¼Œå‡å°‘ä½“ç§¯

åœºæ™¯3: åŠ¨æ€å¯¼å…¥çš„å­—ç¬¦ä¸²æ‹¼æ¥
  æºç :
    const lang = 'zh';
    import(`./locales/${lang}.json`);

  parser å¤„ç†:
    evaluateExpression(`./locales/${lang}.json`)
      â†’ setTemplateString(['./locales/', '.json'], [langExpr])

    ImportPlugin è¯†åˆ«:
      â†’ åˆ›å»º ImportContextDependency
      â†’ directory: './locales'
      â†’ regExp: /^\.\/.*\.json$/

    æ„å»ºæ—¶:
      æ‰«æ ./locales ç›®å½•
      æ‰¾åˆ°æ‰€æœ‰ .json æ–‡ä»¶
      å…¨éƒ¨æ·»åŠ ä¸ºå¯èƒ½çš„ä¾èµ–

å¼ºå¤§ä¹‹å¤„ â­â­â­:
  parser ä¸åªæ˜¯è¯†åˆ«ä¾èµ–
  è¿˜èƒ½ç†è§£ä»£ç é€»è¾‘
  ä¼˜åŒ–æœ€ç»ˆè¾“å‡º
```

---

## ğŸ“Š Make é˜¶æ®µæ€§èƒ½åˆ†æå’Œä¼˜åŒ–å»ºè®®

```
Make é˜¶æ®µè€—æ—¶åˆ†å¸ƒï¼ˆ2000ms æ€»è€—æ—¶ï¼‰:

â”œâ”€ Factorizeï¼ˆåˆ›å»ºæ¨¡å—ï¼‰: 10% = 200ms
â”‚   â”œâ”€ è·¯å¾„è§£æ: 60% = 120ms
â”‚   â”‚   ä¼˜åŒ–: é…ç½® resolve.cache
â”‚   â”œâ”€ Loader åŒ¹é…: 30% = 60ms
â”‚   â”‚   ä¼˜åŒ–: å‡å°‘ rules æ•°é‡
â”‚   â””â”€ æ¨¡å—å®ä¾‹åŒ–: 10% = 20ms
â”‚
â”œâ”€ Buildï¼ˆæ„å»ºæ¨¡å—ï¼‰: 70% = 1400ms â­â­â­
â”‚   â”œâ”€ Loader æ‰§è¡Œ: 50% = 700ms
â”‚   â”‚   ä¼˜åŒ–å»ºè®®:
â”‚   â”‚     - é™åˆ¶ loader èŒƒå›´ï¼ˆinclude/excludeï¼‰
â”‚   â”‚     - ä½¿ç”¨ thread-loader å¹¶è¡Œ
â”‚   â”‚     - å¯ç”¨ loader ç¼“å­˜ï¼ˆbabel-loader?cacheDirectoryï¼‰
â”‚   â”‚
â”‚   â”œâ”€ AST è§£æ: 30% = 420ms
â”‚   â”‚   ä¼˜åŒ–å»ºè®®:
â”‚   â”‚     - ä½¿ç”¨ loader æä¾›çš„ ASTï¼ˆmeta.webpackASTï¼‰
â”‚   â”‚     - å‡å°‘æ–‡ä»¶å¤§å°
â”‚   â”‚     - å¯ç”¨æŒä¹…åŒ–ç¼“å­˜
â”‚   â”‚
â”‚   â””â”€ ä¾èµ–è¯†åˆ«: 20% = 280ms
â”‚       ä¼˜åŒ–å»ºè®®:
â”‚         - å‡å°‘ä¾èµ–æ•°é‡
â”‚         - ä½¿ç”¨ sideEffects: false
â”‚
â”œâ”€ ProcessDependenciesï¼ˆå¤„ç†ä¾èµ–ï¼‰: 15% = 300ms
â”‚   â”œâ”€ ä¾èµ–åˆ†ç»„: 20% = 60ms
â”‚   â”‚   å·²ä¼˜åŒ–: ä¸‰çº§ç¼“å­˜ âœ…
â”‚   â”œâ”€ é˜Ÿåˆ—è°ƒåº¦: 30% = 90ms
â”‚   â”‚   ä¼˜åŒ–: è°ƒæ•´ parallelism
â”‚   â””â”€ é€’å½’è°ƒç”¨: 50% = 150ms
â”‚
â””â”€ å…¶ä»–ï¼ˆå»é‡ã€ç¼“å­˜ï¼‰: 5% = 100ms
    å·²ä¼˜åŒ– âœ…

å…³é”®ä¼˜åŒ–ç‚¹ â­â­â­:

1. å¯ç”¨æŒä¹…åŒ–ç¼“å­˜ï¼ˆæœ€é‡è¦ï¼ï¼‰
   cache: {
     type: 'filesystem',
     buildDependencies: {
       config: [__filename]
     }
   }

   æ•ˆæœ: ç¬¬äºŒæ¬¡ç¼–è¯‘å¿« 5-10 å€

2. é™åˆ¶ loader èŒƒå›´
   {
     test: /\.js$/,
     include: path.resolve('src'),  // â­ åªå¤„ç† src
     exclude: /node_modules/,       // â­ æ’é™¤ node_modules
     use: 'babel-loader'
   }

3. ä½¿ç”¨ä¸å®‰å…¨ç¼“å­˜ï¼ˆnode_modulesï¼‰
   module: {
     unsafeCache: (module) => /node_modules/.test(module.resource)
   }

4. å‡å°‘ä¾èµ–æ·±åº¦
   æ‰å¹³åŒ–ä¾èµ–ç»“æ„
   é¿å…è¿‡æ·±çš„åµŒå¥—å¯¼å…¥

5. é…ç½® watchOptions
   watchOptions: {
     ignored: /node_modules/,  // ä¸ç›‘å¬ node_modules
     aggregateTimeout: 300     // èšåˆå˜æ›´
   }
```

---

**Make é˜¶æ®µçš„ç²¾é«“ï¼šé€’å½’æ„å»º + é˜Ÿåˆ—åè°ƒ + ç¼“å­˜ä¼˜åŒ–ï¼** ğŸš€