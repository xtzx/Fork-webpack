# ä¾èµ–å›¾æ„å»ºåŸç† - å¯è§†åŒ–æµç¨‹å›¾

> é€šè¿‡æµç¨‹å›¾å®Œå…¨ç†è§£ ModuleGraph çš„æ„å»ºè¿‡ç¨‹

## ğŸ“‹ å›¾è¡¨ç›®å½•

1. [ä¸»æµç¨‹å›¾ - ä¾èµ–å›¾æ„å»ºæ¦‚è§ˆ](#å›¾è¡¨-1ä¸»æµç¨‹å›¾---ä¾èµ–å›¾æ„å»ºæ¦‚è§ˆ)
2. [è¯¦ç»†æµç¨‹ - å…¥å£å¤„ç†](#å›¾è¡¨-2è¯¦ç»†æµç¨‹---å…¥å£å¤„ç†)
3. [è¯¦ç»†æµç¨‹ - æ¨¡å—åˆ›å»º](#å›¾è¡¨-3è¯¦ç»†æµç¨‹---æ¨¡å—åˆ›å»º)
4. [è¯¦ç»†æµç¨‹ - æ¨¡å—æ„å»ºä¸ASTè§£æ](#å›¾è¡¨-4è¯¦ç»†æµç¨‹---æ¨¡å—æ„å»ºä¸astè§£æ)
5. [è¯¦ç»†æµç¨‹ - å»ºç«‹å›¾è¿æ¥](#å›¾è¡¨-5è¯¦ç»†æµç¨‹---å»ºç«‹å›¾è¿æ¥)
6. [è¯¦ç»†æµç¨‹ - ä¾èµ–å¤„ç†ä¸é€’å½’](#å›¾è¡¨-6è¯¦ç»†æµç¨‹---ä¾èµ–å¤„ç†ä¸é€’å½’)
7. [æ•°æ®ç»“æ„å…³ç³»å›¾](#å›¾è¡¨-7æ•°æ®ç»“æ„å…³ç³»å›¾)
8. [Tree Shaking åº”ç”¨æµç¨‹](#å›¾è¡¨-8tree-shaking-åº”ç”¨æµç¨‹)

---

## å›¾è¡¨ 1ï¼šä¸»æµç¨‹å›¾ - ä¾èµ–å›¾æ„å»ºæ¦‚è§ˆ

> ä» addEntry åˆ° ModuleGraph å®Œæˆçš„æ•´ä½“æµç¨‹

```mermaid
graph TD
    Start([å¼€å§‹: webpack config]) --> Init[åˆ›å»º Compiler<br/>åˆ›å»º Compilation]
    Init --> MakeStart[è§¦å‘ make é’©å­<br/>compiler.hooks.make]

    MakeStart --> Step1[æ­¥éª¤1: æ·»åŠ å…¥å£<br/>compilation.addEntry]

    Step1 --> Step2[æ­¥éª¤2: åˆ›å»ºå…¥å£æ¨¡å—<br/>factorizeModule]
    Step2 --> Factory[NormalModuleFactory.create<br/>è§£æè·¯å¾„ + åŒ¹é…loader]
    Factory --> CreateModule[new NormalModule]

    CreateModule --> Step3[æ­¥éª¤3: æ·»åŠ æ¨¡å—<br/>addModule - å»é‡æ£€æŸ¥]
    Step3 --> Exists{æ¨¡å—å·²å­˜åœ¨?}
    Exists -->|æ˜¯| UseExisting[å¤ç”¨ç°æœ‰æ¨¡å—]
    Exists -->|å¦| AddNew[æ·»åŠ åˆ° modules é›†åˆ]

    UseExisting --> Step4
    AddNew --> Step4[æ­¥éª¤4: æ„å»ºæ¨¡å—<br/>buildModule]

    Step4 --> Build[module.build<br/>è¯¦è§å›¾è¡¨4]
    Build --> CollectDeps[æ”¶é›†ä¾èµ–<br/>module.dependencies]

    CollectDeps --> Step5[æ­¥éª¤5: å»ºç«‹å›¾è¿æ¥<br/>setResolvedModule<br/>è¯¦è§å›¾è¡¨5]

    Step5 --> ConnectDone[åŒå‘è¿æ¥å»ºç«‹<br/>incoming + outgoing]

    ConnectDone --> Step6[æ­¥éª¤6: å¤„ç†ä¾èµ–<br/>processModuleDependencies<br/>è¯¦è§å›¾è¡¨6]

    Step6 --> HasMore{è¿˜æœ‰æœªå¤„ç†<br/>çš„ä¾èµ–?}
    HasMore -->|æ˜¯| Recursive[é€’å½’: handleModuleCreation<br/>å›åˆ°æ­¥éª¤2]
    Recursive --> Step2

    HasMore -->|å¦| Complete[å®Œæˆ: ModuleGraph æ„å»ºå®Œæˆ]

    Complete --> GraphReady[âœ… åŒ…å«:<br/>- æ‰€æœ‰æ¨¡å—<br/>- æ‰€æœ‰ä¾èµ–å…³ç³»<br/>- å¯¼å…¥å¯¼å‡ºä¿¡æ¯<br/>- æ¨¡å—æ·±åº¦]

    GraphReady --> SealStart[è¿›å…¥ Seal é˜¶æ®µ]

    style Step5 fill:#ff9999
    style Step6 fill:#ff9999
    style GraphReady fill:#99ff99
```

---

## å›¾è¡¨ 2ï¼šè¯¦ç»†æµç¨‹ - å…¥å£å¤„ç†

> addEntry çš„è¯¦ç»†æ­¥éª¤

```mermaid
graph TD
    Start([compilation.addEntry]) --> Extract[æå–å‚æ•°<br/>context, entry, options]

    Extract --> Normalize[è§„èŒƒåŒ–é€‰é¡¹<br/>options = object or name]

    Normalize --> Call_addEntryItem[è°ƒç”¨ _addEntryItem]

    Call_addEntryItem --> GetEntry{è·å–å…¥å£æ•°æ®<br/>entryData}

    GetEntry -->|ä¸å­˜åœ¨| CreateNew[åˆ›å»ºæ–°å…¥å£æ•°æ®<br/>entryData = {<br/>  dependencies: [],<br/>  includeDeps: [],<br/>  options: {...}<br/>}]

    GetEntry -->|å·²å­˜åœ¨| MergeOptions[åˆå¹¶é€‰é¡¹<br/>å¤„ç†å†²çª]

    CreateNew --> AddDep
    MergeOptions --> CheckConflict{é€‰é¡¹å†²çª?}
    CheckConflict -->|æ˜¯| Error[æŠ›å‡ºé”™è¯¯<br/>Conflicting options]
    CheckConflict -->|å¦| AddDep[æ·»åŠ ä¾èµ–åˆ°åˆ—è¡¨<br/>entryData.dependencies]

    AddDep --> SaveEntry[ä¿å­˜åˆ° entries Map<br/>entries.set name, entryData]

    SaveEntry --> HookAdd[è§¦å‘ addEntry é’©å­]

    HookAdd --> CallTree[è°ƒç”¨ addModuleTree<br/>å¼€å§‹æ„å»ºæ¨¡å—æ ‘]

    CallTree --> ValidateDep{éªŒè¯ä¾èµ–å¯¹è±¡}
    ValidateDep -->|æ— æ•ˆ| ErrorDep[é”™è¯¯: æ— æ•ˆä¾èµ–]
    ValidateDep -->|æœ‰æ•ˆ| GetFactory[è·å–æ¨¡å—å·¥å‚<br/>dependencyFactories.get]

    GetFactory --> FactoryExists{å·¥å‚å­˜åœ¨?}
    FactoryExists -->|å¦| ErrorFactory[é”™è¯¯: æ— å·¥å‚]
    FactoryExists -->|æ˜¯| CallCreate[è°ƒç”¨ handleModuleCreation<br/>è¿›å…¥å›¾è¡¨3]

    CallCreate --> Success[æˆåŠŸå›è°ƒ<br/>succeedEntry é’©å­]
    Success --> End([å®Œæˆ])

    Error --> End
    ErrorDep --> End
    ErrorFactory --> End

    style CallTree fill:#ffcc99
    style CallCreate fill:#99ccff
```

---

## å›¾è¡¨ 3ï¼šè¯¦ç»†æµç¨‹ - æ¨¡å—åˆ›å»º

> handleModuleCreation çš„æ ¸å¿ƒé€»è¾‘

```mermaid
graph TD
    Start([handleModuleCreation]) --> Profile[å¯åŠ¨æ€§èƒ½åˆ†æ<br/>if profile enabled]

    Profile --> Factorize[factorizeModule<br/>åˆ›å»ºæ¨¡å—å®ä¾‹]

    Factorize --> FactoryCreate[factory.create<br/>è¯¦ç»†æµç¨‹:]
    FactoryCreate --> Resolve[resolve è·¯å¾„<br/>./a.js â†’ /path/to/a.js]
    Resolve --> MatchLoader[åŒ¹é… loader è§„åˆ™<br/>test: /\.js$/ â†’ babel-loader]
    MatchLoader --> NewModule[new NormalModule<br/>åŒ…å« loaders, parser, generator]

    NewModule --> FactoryResult{å·¥å‚ç»“æœ}
    FactoryResult -->|é”™è¯¯| HandleError[å¤„ç†é”™è¯¯<br/>ModuleNotFoundError]
    FactoryResult -->|æˆåŠŸ| HasModule{è¿”å›æ¨¡å—?}

    HasModule -->|å¦| CollectDeps[æ”¶é›†æ–‡ä»¶ä¾èµ–<br/>fileDependencies]
    CollectDeps --> ReturnNull[è¿”å› null]

    HasModule -->|æ˜¯| SetProfile[è®¾ç½®æ€§èƒ½åˆ†æ]
    SetProfile --> AddModule[addModule<br/>æ·»åŠ åˆ°ç¼–è¯‘]

    AddModule --> CheckExist{æ¨¡å—å·²å­˜åœ¨?}
    CheckExist -->|æ˜¯| ReturnExist[è¿”å›ç°æœ‰æ¨¡å—<br/>å»é‡æœºåˆ¶ â­]
    CheckExist -->|å¦| TryCache[å°è¯•ä»ç¼“å­˜æ¢å¤<br/>_modulesCache.get]

    TryCache --> HasCache{æœ‰ç¼“å­˜?}
    HasCache -->|æ˜¯| MergeCache[åˆå¹¶ç¼“å­˜æ¨¡å—<br/>updateCacheModule]
    HasCache -->|å¦| UseNew[ä½¿ç”¨æ–°æ¨¡å—]

    MergeCache --> AddToSet
    UseNew --> AddToSet[æ·»åŠ åˆ° modules é›†åˆ]

    AddToSet --> BuildConnect[å»ºç«‹å›¾è¿æ¥<br/>setResolvedModule<br/>è¯¦è§å›¾è¡¨5 â­â­â­]
    ReturnExist --> BuildConnect

    BuildConnect --> SetIssuer[è®¾ç½®å¼•å…¥è€…<br/>moduleGraph.setIssuerIfUnset]

    SetIssuer --> HandleBuild[_handleModuleBuildAndDependencies<br/>æ„å»ºå’Œä¾èµ–å¤„ç†]

    HandleBuild --> End([è¿”å›æ¨¡å—])
    HandleError --> End
    ReturnNull --> End

    style BuildConnect fill:#ff9999
    style CheckExist fill:#ffcc99
```

---

## å›¾è¡¨ 4ï¼šè¯¦ç»†æµç¨‹ - æ¨¡å—æ„å»ºä¸ASTè§£æ

> module.build() å’Œ parser.parse() çš„è¯¦ç»†è¿‡ç¨‹

```mermaid
graph TD
    Start([module.build]) --> Reset[é‡ç½®æ¨¡å—çŠ¶æ€<br/>æ¸…ç©º dependencies<br/>æ¸…ç©º errors/warnings]

    Reset --> InitBuild[åˆå§‹åŒ– buildInfo<br/>buildMeta = {}]

    InitBuild --> DoBuild[_doBuild<br/>æ‰§è¡Œ loader]

    DoBuild --> CreateContext[åˆ›å»º loaderContext<br/>æä¾› loader API]
    CreateContext --> RunLoaders[runLoaders<br/>loader-runner]

    RunLoaders --> Pitching[Pitching é˜¶æ®µ<br/>ä»å·¦åˆ°å³]
    Pitching --> ReadFile[è¯»å–æºæ–‡ä»¶<br/>fs.readFile]
    ReadFile --> Normal[Normal é˜¶æ®µ<br/>ä»å³åˆ°å·¦]

    Normal --> Loader3[loader3 source]
    Loader3 --> Loader2[loader2 transformed]
    Loader2 --> Loader1[loader1 final]

    Loader1 --> CreateSource[åˆ›å»º Source å¯¹è±¡<br/>RawSource / SourceMapSource]

    CreateSource --> CheckAST{loader è¿”å›<br/>é¢„è§£æ AST?}
    CheckAST -->|æ˜¯| UseAST[ä½¿ç”¨ loader çš„ AST<br/>è·³è¿‡ parse]
    CheckAST -->|å¦| NeedParse[éœ€è¦è§£æ]

    NeedParse --> Parse[parser.parse<br/>JavascriptParser]

    Parse --> AcornParse[acorn.parse<br/>ç”Ÿæˆ AST]
    AcornParse --> DetectMode[ç¬¬1è½®: detectMode<br/>æ£€æµ‹ä¸¥æ ¼æ¨¡å¼]
    DetectMode --> PreWalk[ç¬¬2è½®: preWalkStatements<br/>æ”¶é›†å£°æ˜]
    PreWalk --> BlockPreWalk[ç¬¬3è½®: blockPreWalkStatements<br/>å—çº§ä½œç”¨åŸŸ]
    BlockPreWalk --> Walk[ç¬¬4è½®: walkStatements<br/>è¯†åˆ«ä¾èµ– â­â­â­]

    Walk --> ImportStmt{é‡åˆ° import?}
    ImportStmt -->|æ˜¯| CreateHarmony[åˆ›å»º HarmonyImportDependency<br/>æ·»åŠ åˆ° dependencies]

    Walk --> RequireCall{é‡åˆ° require?}
    RequireCall -->|æ˜¯| CreateCommonJs[åˆ›å»º CommonJsRequireDependency<br/>æ·»åŠ åˆ° dependencies]

    Walk --> ImportCall{é‡åˆ° import?}
    ImportCall -->|æ˜¯| CreateImport[åˆ›å»º ImportDependency<br/>+ AsyncDependenciesBlock<br/>æ·»åŠ åˆ° blocks]

    Walk --> ExportStmt{é‡åˆ° export?}
    ExportStmt -->|æ˜¯| CreateExport[åˆ›å»º HarmonyExportDependency<br/>è®°å½•å¯¼å‡ºä¿¡æ¯]

    CreateHarmony --> DepsCollected
    CreateCommonJs --> DepsCollected
    CreateImport --> DepsCollected
    CreateExport --> DepsCollected
    UseAST --> DepsCollected

    DepsCollected[ä¾èµ–æ”¶é›†å®Œæˆ<br/>module.dependencies]

    DepsCollected --> SortDeps[æ’åºä¾èµ–<br/>æŒ‰æºç ä½ç½®]
    SortDeps --> InitHash[ç”Ÿæˆ buildHash]
    InitHash --> CreateSnapshot[åˆ›å»ºæ–‡ä»¶å¿«ç…§<br/>ç”¨äº watch æ¨¡å¼]

    CreateSnapshot --> End([æ„å»ºå®Œæˆ<br/>è¿”å› module])

    style Walk fill:#ff9999
    style CreateImport fill:#ffcc99
```

---

## å›¾è¡¨ 5ï¼šè¯¦ç»†æµç¨‹ - å»ºç«‹å›¾è¿æ¥

> setResolvedModule çš„è¯¦ç»†å®ç°ï¼ˆä¾èµ–å›¾æ„å»ºçš„æ ¸å¿ƒï¼ï¼‰

```mermaid
graph TD
    Start([setResolvedModule<br/>origin, dependency, target]) --> CreateConn[åˆ›å»ºè¿æ¥å¯¹è±¡<br/>new ModuleGraphConnection]

    CreateConn --> SetProps[è®¾ç½®è¿æ¥å±æ€§<br/>originModule: origin<br/>dependency: dep<br/>module: target<br/>weak: dep.weak]

    SetProps --> GetTarget[è·å–ç›®æ ‡æ¨¡å—çš„å›¾èŠ‚ç‚¹<br/>targetMgm = _getModuleGraphModule target]

    GetTarget --> TargetExists{èŠ‚ç‚¹å­˜åœ¨?}
    TargetExists -->|å¦| CreateTarget[åˆ›å»ºæ–°èŠ‚ç‚¹<br/>new ModuleGraphModule<br/>ä¿å­˜åˆ° _moduleMap]
    TargetExists -->|æ˜¯| UseTarget[ä½¿ç”¨ç°æœ‰èŠ‚ç‚¹]

    CreateTarget --> AddIncoming
    UseTarget --> AddIncoming[æ·»åŠ åˆ°å…¥è¾¹ â­<br/>targetMgm.incomingConnections<br/>.add connection]

    AddIncoming --> TargetKnows[âœ… ç›®æ ‡æ¨¡å—ç°åœ¨çŸ¥é“<br/>origin ä¾èµ–å®ƒ]

    TargetKnows --> HasOrigin{æœ‰æºæ¨¡å—?}

    HasOrigin -->|å¦| MapDep[å…¥å£ä¾èµ–<br/>_dependencyMap.set<br/>dependency, connection]

    HasOrigin -->|æ˜¯| GetOrigin[è·å–æºæ¨¡å—çš„å›¾èŠ‚ç‚¹<br/>originMgm = _getModuleGraphModule origin]

    GetOrigin --> OriginExists{èŠ‚ç‚¹å­˜åœ¨?}
    OriginExists -->|å¦| CreateOrigin[åˆ›å»ºæ–°èŠ‚ç‚¹]
    OriginExists -->|æ˜¯| UseOrigin[ä½¿ç”¨ç°æœ‰èŠ‚ç‚¹]

    CreateOrigin --> CheckOutgoing
    UseOrigin --> CheckOutgoing{outgoing<br/>å­˜åœ¨?}

    CheckOutgoing -->|å¦| CreateOut[æ‡’åˆ›å»º<br/>outgoing = new SortableSet]
    CheckOutgoing -->|æ˜¯| UseOut[ä½¿ç”¨ç°æœ‰]

    CreateOut --> AddOutgoing
    UseOut --> AddOutgoing[æ·»åŠ åˆ°å‡ºè¾¹ â­<br/>originMgm.outgoingConnections<br/>.add connection]

    AddOutgoing --> OriginKnows[âœ… æºæ¨¡å—ç°åœ¨çŸ¥é“<br/>å®ƒä¾èµ– target]

    OriginKnows --> AddUnassigned[æ·»åŠ åˆ°æœªåˆ†é…åˆ—è¡¨<br/>_unassignedConnections]

    AddUnassigned --> Done
    MapDep --> Done([å®Œæˆ<br/>å›¾è¿æ¥å»ºç«‹ âœ…])

    Done --> Result[ç»“æœ:<br/>åŒå‘è¿æ¥å»ºç«‹<br/>origin.outgoing â† conn â†’ target.incoming]

    style AddIncoming fill:#99ff99
    style AddOutgoing fill:#99ff99
    style Done fill:#ffcc99
```

---

## å›¾è¡¨ 6ï¼šè¯¦ç»†æµç¨‹ - ä¾èµ–å¤„ç†ä¸é€’å½’

> processModuleDependencies çš„é€’å½’æœºåˆ¶

```mermaid
graph TD
    Start([processModuleDependencies<br/>module]) --> Init[åˆå§‹åŒ–æ•°æ®ç»“æ„<br/>sortedDependencies = []<br/>dependencies = Map]

    Init --> InitCache[åˆå§‹åŒ–ç¼“å­˜å˜é‡<br/>factoryCacheKey<br/>listCacheKey1/2]

    InitCache --> InitCounter[åˆå§‹åŒ–è®¡æ•°å™¨<br/>inProgressSorting = 1<br/>inProgressTransitive = 1]

    InitCounter --> StartLoop[å¼€å§‹éå†<br/>queue = module]

    StartLoop --> PopBlock{é˜Ÿåˆ—éç©º?}
    PopBlock -->|å¦| AllDone[éå†å®Œæˆ]
    PopBlock -->|æ˜¯| GetBlock[block = queue.pop]

    GetBlock --> HasDeps{block.dependencies?}
    HasDeps -->|æ˜¯| LoopDeps[éå† dependencies]
    HasDeps -->|å¦| CheckBlocks

    LoopDeps --> ProcessDep[processDependency<br/>è®¾ç½®çˆ¶çº§å¼•ç”¨]

    ProcessDep --> CheckCache{æ£€æŸ¥ç¼“å­˜}
    CheckCache -->|å‘½ä¸­| UseCache[ä½¿ç”¨ç¼“å­˜æ¨¡å—]
    CheckCache -->|æœªå‘½ä¸­| Resolve[processDependencyForResolving<br/>ä¾èµ–åˆ†ç»„]

    Resolve --> GetIdent[è·å–èµ„æºæ ‡è¯†<br/>resourceIdent]
    GetIdent --> GetCategory[è·å–ç±»åˆ«<br/>category = 'esm']
    GetCategory --> GetConstructor[è·å–æ„é€ å‡½æ•°<br/>HarmonyImportDependency]

    GetConstructor --> Cache1{ç¼“å­˜çº§åˆ«1<br/>æ„é€ å‡½æ•°ç›¸åŒ?}
    Cache1 -->|æ˜¯| SuperFast[âš¡è¶…å¿«è·¯å¾„<br/>ç›´æ¥ä½¿ç”¨ listCacheValue]
    Cache1 -->|å¦| Cache2{ç¼“å­˜çº§åˆ«2<br/>å·¥å‚ç›¸åŒ?}

    Cache2 -->|æ˜¯| Fast[âš¡å¿«è·¯å¾„<br/>ä½¿ç”¨ factoryCacheValue]
    Cache2 -->|å¦| Slow[æ…¢è·¯å¾„<br/>Map.get factory]

    SuperFast --> AddToGroup
    Fast --> AddToGroup
    Slow --> AddToGroup[æ·»åŠ åˆ°ä¾èµ–ç»„<br/>sortedDependencies.push]

    UseCache --> NextDep
    AddToGroup --> NextDep{è¿˜æœ‰ä¾èµ–?}
    NextDep -->|æ˜¯| LoopDeps
    NextDep -->|å¦| CheckBlocks

    CheckBlocks{block.blocks?}
    CheckBlocks -->|æ˜¯| AddBlocks[æ·»åŠ åµŒå¥—å—åˆ°é˜Ÿåˆ—]
    CheckBlocks -->|å¦| PopBlock
    AddBlocks --> PopBlock

    AllDone --> CallbackSort[onDependenciesSorted]

    CallbackSort --> CheckEmpty{æœ‰ä¾èµ–ç»„?}
    CheckEmpty -->|å¦| Finish[ç›´æ¥å®Œæˆ]
    CheckEmpty -->|æ˜¯| IncreasePara[å¢åŠ é˜Ÿåˆ—å¹¶è¡Œåº¦]

    IncreasePara --> LoopGroups[éå† sortedDependencies]

    LoopGroups --> CallHandle[ğŸ”„ é€’å½’è°ƒç”¨<br/>handleModuleCreation<br/>å›åˆ°å›¾è¡¨3]

    CallHandle --> CountDown[è®¡æ•°å™¨ - 1]
    CountDown --> AllComplete{æ‰€æœ‰å®Œæˆ?}
    AllComplete -->|å¦| Wait[ç­‰å¾…...]
    AllComplete -->|æ˜¯| DecreasePara[æ¢å¤é˜Ÿåˆ—å¹¶è¡Œåº¦]

    DecreasePara --> Finish([å®Œæˆ<br/>æ‰€æœ‰ä¾èµ–å·²å¤„ç†])

    style CallHandle fill:#ff9999
    style SuperFast fill:#99ff99
    style AddToGroup fill:#ffcc99
```

---

## å›¾è¡¨ 7ï¼šæ•°æ®ç»“æ„å…³ç³»å›¾

> ModuleGraph çš„æ ¸å¿ƒæ•°æ®ç»“æ„

```mermaid
graph TB
    subgraph ModuleGraph["ğŸ›ï¸ ModuleGraph (ä¸»ç±»)"]
        DependencyMap["_dependencyMap<br/>WeakMap&lt;Dependency, Connection&gt;<br/>â”â”â”â”â”â”â”â”â”â”â”<br/>dependency1 â†’ connection1<br/>dependency2 â†’ connection2"]

        ModuleMap["_moduleMap<br/>Map&lt;Module, ModuleGraphModule&gt;<br/>â”â”â”â”â”â”â”â”â”â”â”<br/>module1 â†’ mgm1<br/>module2 â†’ mgm2"]

        MetaMap["_metaMap<br/>WeakMap (å…ƒæ•°æ®)"]

        Cache["_cache<br/>WeakTupleMap (ç¼“å­˜)"]
    end

    subgraph MGM["ğŸ“¦ ModuleGraphModule (å›¾èŠ‚ç‚¹)"]
        Incoming["incomingConnections<br/>SortableSet&lt;Connection&gt;<br/>â”â”â”â”â”â”â”â”â”â”â”<br/>è°ä¾èµ–æˆ‘ (å…¥è¾¹)"]

        Outgoing["outgoingConnections<br/>SortableSet&lt;Connection&gt;<br/>â”â”â”â”â”â”â”â”â”â”â”<br/>æˆ‘ä¾èµ–è° (å‡ºè¾¹)"]

        Exports["exports: ExportsInfo<br/>â”â”â”â”â”â”â”â”â”â”â”<br/>Map&lt;å¯¼å‡ºå, ExportInfo&gt;<br/>foo: {used: true}<br/>bar: {used: false}"]

        Issuer["issuer: Module<br/>å¼•å…¥è€…"]

        Depth["depth: number<br/>æ¨¡å—æ·±åº¦"]

        Indexes["preOrderIndex<br/>postOrderIndex<br/>éå†ç´¢å¼•"]
    end

    subgraph Conn["ğŸ”— ModuleGraphConnection (è¾¹)"]
        Origin["originModule<br/>æºæ¨¡å—"]

        Dep["dependency<br/>ä¾èµ–å¯¹è±¡"]

        Target["module<br/>ç›®æ ‡æ¨¡å—"]

        Active["active: boolean<br/>æ˜¯å¦æ¿€æ´»"]

        Weak["weak: boolean<br/>æ˜¯å¦å¼±ä¾èµ–"]
    end

    ModuleMap -.-> MGM
    DependencyMap -.-> Conn

    Incoming -.->|åŒ…å«| Conn
    Outgoing -.->|åŒ…å«| Conn

    Origin -.->|å¼•ç”¨| ModuleMap
    Target -.->|å¼•ç”¨| ModuleMap

    style ModuleGraph fill:#e1f5ff
    style MGM fill:#fff4e1
    style Conn fill:#f0ffe1
```

---

## å›¾è¡¨ 8ï¼šTree Shaking åº”ç”¨æµç¨‹

> å¦‚ä½•åˆ©ç”¨ä¾èµ–å›¾å®ç° Tree Shaking

```mermaid
graph TD
    subgraph Make["Make é˜¶æ®µ - æ”¶é›†ä¿¡æ¯"]
        M1[æ¨¡å— a.js æ„å»º<br/>export const foo = 1<br/>export const bar = 2]

        M1 --> M2[parser è¯†åˆ« export<br/>è®°å½•æä¾›çš„å¯¼å‡º]

        M2 --> M3[exportsInfo.setProvided<br/>foo, bar]

        M4[æ¨¡å— b.js æ„å»º<br/>import foo from './a']

        M4 --> M5[parser è¯†åˆ« import<br/>è®°å½•ä½¿ç”¨çš„å¯¼å‡º]

        M5 --> M6[dependency.getReferencedExports<br/>è¿”å›: foo]
    end

    subgraph Seal["Seal é˜¶æ®µ - æ ‡è®°ä½¿ç”¨"]
        S1[FlagDependencyUsagePlugin]

        S1 --> S2[éå†æ‰€æœ‰ dependencies<br/>è·å– referencedExports]

        S2 --> S3[åˆ†æå“ªäº›å¯¼å‡ºè¢«ä½¿ç”¨]

        S3 --> S4[æ›´æ–° exportsInfo<br/>setUsed foo: true<br/>setUsed bar: false]
    end

    subgraph Gen["ä»£ç ç”Ÿæˆ - åˆ é™¤æœªä½¿ç”¨"]
        G1[ç”Ÿæˆ a.js çš„ä»£ç ]

        G1 --> G2[è·å– exportsInfo]

        G2 --> G3{isUsed foo?}
        G3 -->|æ˜¯| G4[ç”Ÿæˆ: exports.foo = 1 âœ…]

        G2 --> G5{isUsed bar?}
        G5 -->|å¦| G6[è·³è¿‡ bar âŒ<br/>ä¸ç”Ÿæˆä»£ç ]

        G4 --> Result
        G6 --> Result[æœ€ç»ˆä»£ç :<br/>åªåŒ…å« foo<br/>â”â”â”â”â”â”â”<br/>èŠ‚çœ 50% ä»£ç ]
    end

    M3 -.-> S1
    M6 -.-> S2
    S4 -.-> G1

    style M3 fill:#ffcc99
    style S4 fill:#ffcc99
    style G6 fill:#ff9999
    style Result fill:#99ff99
```

---

## å›¾è¡¨ 9ï¼šä»£ç åˆ†å‰²æµç¨‹

> SplitChunksPlugin å¦‚ä½•åˆ©ç”¨ä¾èµ–å›¾

```mermaid
graph TD
    Start([SplitChunksPlugin<br/>optimizeChunks é’©å­]) --> Analyze[é˜¶æ®µ1: åˆ†æå…±äº«<br/>éå†æ‰€æœ‰æ¨¡å—]

    Analyze --> GetConnections[è·å– incomingConnections]

    GetConnections --> CheckShared{connections.size > 1?}
    CheckShared -->|æ˜¯| AddCandidate[æ·»åŠ åˆ°å€™é€‰æ¨¡å—<br/>candidates.add module]
    CheckShared -->|å¦| Skip1[è·³è¿‡<br/>æœªè¢«å…±äº«]

    AddCandidate --> Group[é˜¶æ®µ2: åˆ†ç»„<br/>æŒ‰ cacheGroups é…ç½®]
    Skip1 --> NextModule1{è¿˜æœ‰æ¨¡å—?}
    NextModule1 -->|æ˜¯| Analyze
    NextModule1 -->|å¦| Group

    Group --> MatchRule[éå† cacheGroups<br/>åŒ¹é…è§„åˆ™]

    MatchRule --> TestMatch{test åŒ¹é…?}
    TestMatch -->|æ˜¯| AddGroup[æ·»åŠ åˆ°åˆ†ç»„<br/>groups vendors.add module]
    TestMatch -->|å¦| Skip2[è·³è¿‡]

    AddGroup --> NextCandidate{è¿˜æœ‰å€™é€‰?}
    Skip2 --> NextCandidate
    NextCandidate -->|æ˜¯| MatchRule
    NextCandidate -->|å¦| Filter[é˜¶æ®µ3: è¿‡æ»¤<br/>åº”ç”¨è§„åˆ™]

    Filter --> CalcSize[è®¡ç®—åˆ†ç»„æ€»å¤§å°<br/>size = sum module.size]

    CalcSize --> CheckMinSize{size >= minSize?}
    CheckMinSize -->|å¦| Reject1[âŒ å¤ªå°ï¼Œä¸æå–]
    CheckMinSize -->|æ˜¯| CheckMinChunks{chunks >= minChunks?}

    CheckMinChunks -->|å¦| Reject2[âŒ å…±äº«ä¸å¤Ÿ]
    CheckMinChunks -->|æ˜¯| CheckMaxReq{requests <= max?}

    CheckMaxReq -->|å¦| PartialExtract[âš ï¸ åªæå–æœ€å¤§çš„å‡ ä¸ª]
    CheckMaxReq -->|æ˜¯| CheckEnforce{enforce?}

    CheckEnforce -->|æ˜¯| ForceCreate[âœ… å¼ºåˆ¶åˆ›å»º<br/>å¿½ç•¥æ‰€æœ‰é™åˆ¶]
    CheckEnforce -->|å¦| NormalCreate[âœ… æ­£å¸¸åˆ›å»º]

    PartialExtract --> Create
    ForceCreate --> Create
    NormalCreate --> Create[é˜¶æ®µ4: åˆ›å»º Chunk<br/>addChunk groupName]

    Reject1 --> NextGroup
    Reject2 --> NextGroup

    Create --> MoveModules[ç§»åŠ¨æ¨¡å—åˆ°æ–° Chunk]

    MoveModules --> Disconnect[chunkGraph.disconnectChunkAndModule<br/>oldChunk, module]
    Disconnect --> Connect[chunkGraph.connectChunkAndModule<br/>newChunk, module]

    Connect --> NextGroup{è¿˜æœ‰åˆ†ç»„?}
    NextGroup -->|æ˜¯| Filter
    NextGroup -->|å¦| Done([å®Œæˆ<br/>æ–° Chunk åˆ›å»º])

    Done --> Result[ç»“æœ:<br/>vendors chunk: react, lodash<br/>common chunk: utils<br/>â”â”â”â”â”â”â”<br/>å‡å°‘ 400KB é‡å¤ä»£ç ]

    style Create fill:#99ff99
    style MoveModules fill:#ffcc99
    style Result fill:#99ff99
```

---

## å›¾è¡¨ 10ï¼šæ¨¡å—å»é‡æœºåˆ¶

> addModule çš„å»é‡é€»è¾‘

```mermaid
graph TD
    Start([addModule<br/>newModule]) --> GetId[è·å–å”¯ä¸€æ ‡è¯†ç¬¦<br/>identifier = module.identifier<br/>æ ¼å¼: type|path]

    GetId --> Example[ç¤ºä¾‹:<br/>javascript/auto|/path/to/a.js]

    Example --> Lookup[æŸ¥æ‰¾å·²å­˜åœ¨æ¨¡å—<br/>existing = _modules.get identifier]

    Lookup --> Exists{æ¨¡å—å·²å­˜åœ¨?}

    Exists -->|æ˜¯| ReturnExist[â­ è¿”å›ç°æœ‰æ¨¡å—<br/>ä¸é‡å¤æ·»åŠ ]

    Exists -->|å¦| TryCache[å°è¯•ä»ç¼“å­˜æ¢å¤<br/>cached = _modulesCache.get identifier]

    TryCache --> HasCache{æœ‰ç¼“å­˜?}

    HasCache -->|æ˜¯| Restore[æ¢å¤ç¼“å­˜æ¨¡å—<br/>cached.updateCacheModule newModule]
    HasCache -->|å¦| UseNew[ä½¿ç”¨æ–°æ¨¡å—]

    Restore --> Merge[åˆå¹¶:<br/>å·¥å‚æ•°æ®æ¥è‡ª newModule<br/>æ„å»ºæ•°æ®æ¥è‡ª cached]

    Merge --> UseCache[ä½¿ç”¨ cached æ¨¡å—]

    UseCache --> AddMap
    UseNew --> AddMap[æ·»åŠ åˆ° _modules Map<br/>æ·»åŠ åˆ° modules Set]

    AddMap --> SetGraph[è®¾ç½® moduleGraph å¼•ç”¨<br/>å‘åå…¼å®¹]

    SetGraph --> Return([è¿”å›æ¨¡å—<br/>å¯èƒ½æ˜¯ new/existing/cached])

    ReturnExist --> Scenario[åœºæ™¯ç¤ºä¾‹:<br/>a.js import './common'<br/>b.js import './common'<br/>â”â”â”â”â”â”â”<br/>common åªåˆ›å»ºä¸€æ¬¡<br/>a å’Œ b å…±äº«åŒä¸€å®ä¾‹]

    style ReturnExist fill:#99ff99
    style UseCache fill:#ffcc99
    style Scenario fill:#e1f5ff
```

---

## å›¾è¡¨ 11ï¼šå¾ªç¯ä¾èµ–æ£€æµ‹

> å¦‚ä½•æ£€æµ‹å’Œå¤„ç†å¾ªç¯ä¾èµ–

```mermaid
graph TD
    Start([æ£€æµ‹å¾ªç¯ä¾èµ–<br/>DFS ç®—æ³•]) --> Init[åˆå§‹åŒ–<br/>visiting = Set<br/>visited = Set<br/>cycles = []]

    Init --> StartDFS[å¯¹æ¯ä¸ªæ¨¡å—<br/>æ‰§è¡Œ DFS]

    StartDFS --> Visit[è®¿é—® module]

    Visit --> InVisiting{åœ¨ visiting ä¸­?}

    InVisiting -->|æ˜¯| Found[ğŸ”´ æ£€æµ‹åˆ°ç¯!<br/>è®°å½•å¾ªç¯è·¯å¾„]

    InVisiting -->|å¦| InVisited{åœ¨ visited ä¸­?}

    InVisited -->|æ˜¯| Skip[å·²è®¿é—®<br/>è·³è¿‡]

    InVisited -->|å¦| AddVisiting[æ·»åŠ åˆ° visiting<br/>æ ‡è®°æ­£åœ¨è®¿é—®]

    AddVisiting --> GetOut[è·å–å‡ºè¾¹<br/>getOutgoingConnections]

    GetOut --> LoopOut[éå†å‡ºè¾¹<br/>for conn of connections]

    LoopOut --> RecurDFS[é€’å½’ DFS<br/>visit conn.module]

    RecurDFS --> MoreOut{è¿˜æœ‰å‡ºè¾¹?}
    MoreOut -->|æ˜¯| LoopOut
    MoreOut -->|å¦| RemoveVisiting[ä» visiting ç§»é™¤]

    RemoveVisiting --> AddVisited[æ·»åŠ åˆ° visited<br/>æ ‡è®°å·²å®Œæˆ]

    AddVisited --> NextModule{è¿˜æœ‰æ¨¡å—?}
    NextModule -->|æ˜¯| StartDFS
    NextModule -->|å¦| Report

    Found --> Report[æŠ¥å‘Šå¾ªç¯ä¾èµ–<br/>Warning: a â†’ b â†’ c â†’ a]

    Skip --> NextModule

    Report --> Handle[å¤„ç†ç­–ç•¥:<br/>âš ï¸ è­¦å‘Šä½†ä¸é˜»æ­¢<br/>âœ… è°ƒæ•´åŠ è½½é¡ºåº<br/>âœ… ä½¿ç”¨å»¶è¿Ÿæ‰§è¡Œ]

    Handle --> End([å®Œæˆ])

    style Found fill:#ff9999
    style Handle fill:#ffcc99
```

---

## å›¾è¡¨ 12ï¼šåŠ¨æ€å¯¼å…¥å¤„ç†

> import() å¦‚ä½•åˆ›å»ºæ–° Chunk

```mermaid
graph TD
    subgraph Make["Make é˜¶æ®µ - è¯†åˆ«"]
        M1[parser è§£æåˆ°<br/>import './lazy.js']

        M1 --> M2[è¯†åˆ«ä¸º ImportExpression<br/>AST èŠ‚ç‚¹ç±»å‹]

        M2 --> M3[walkImportExpression]

        M3 --> M4[åˆ›å»º ImportDependency<br/>æ ‡è®° async: true]

        M4 --> M5[åˆ›å»º AsyncDependenciesBlock<br/>åŒ…å«é­”æ³•æ³¨é‡Š]

        M5 --> M6[module.blocks.push block]
    end

    subgraph Seal["Seal é˜¶æ®µ - åˆ›å»º Chunk"]
        S1[buildChunkGraph<br/>éå† module.blocks]

        S1 --> S2{é‡åˆ° AsyncBlock?}

        S2 -->|æ˜¯| S3[iteratorBlock b]

        S3 --> S4{asyncChunks?}

        S4 -->|false| S5[eager æ¨¡å¼<br/>ä¸åˆ›å»ºæ–° chunk]

        S4 -->|true| S6[lazy æ¨¡å¼<br/>åˆ›å»ºæ–° ChunkGroup]

        S6 --> S7[compilation.addChunkInGroup<br/>name: webpackChunkName]

        S7 --> S8[åˆ›å»ºæ–° Chunk]

        S8 --> S9[å»ºç«‹çˆ¶å­å…³ç³»<br/>main chunk â†’ lazy chunk]
    end

    subgraph Gen["ä»£ç ç”Ÿæˆ - ç”ŸæˆåŠ è½½ä»£ç "]
        G1[ImportDependency.Template]

        G1 --> G2[ç”ŸæˆåŠ è½½ä»£ç ]

        G2 --> G3["__webpack_require__.e chunkId"]

        G3 --> G4[".then(__webpack_require__ moduleId)"]

        G4 --> G5[è¿”å› Promise]
    end

    M6 -.-> S1
    S9 -.-> G1

    G5 --> Runtime[è¿è¡Œæ—¶è¡Œä¸º:<br/>1. åˆ›å»º script æ ‡ç­¾<br/>2. åŠ è½½ lazy.chunk.js<br/>3. æ‰§è¡Œæ¨¡å—ä»£ç <br/>4. resolve Promise]

    style S6 fill:#99ff99
    style S8 fill:#ffcc99
    style Runtime fill:#e1f5ff
```

---

## ä½¿ç”¨è¯´æ˜

### å¦‚ä½•é˜…è¯»è¿™äº›æµç¨‹å›¾

**å­¦ä¹ è·¯å¾„**ï¼š
1. å…ˆçœ‹ **å›¾è¡¨1 - ä¸»æµç¨‹å›¾**ï¼ˆæ•´ä½“æ¦‚è§ˆï¼‰
2. æŒ‰éœ€æŸ¥çœ‹è¯¦ç»†æµç¨‹å›¾ï¼ˆæ·±å…¥ç»†èŠ‚ï¼‰
3. ç†è§£æ•°æ®ç»“æ„å…³ç³»å›¾ï¼ˆå›¾è¡¨7ï¼‰
4. å­¦ä¹ åº”ç”¨åœºæ™¯ï¼ˆå›¾è¡¨8-12ï¼‰

**æµç¨‹å›¾è¯´æ˜**ï¼š
- ğŸ”´ çº¢è‰²ï¼šæ ¸å¿ƒæ­¥éª¤
- ğŸŸ¢ ç»¿è‰²ï¼šå®Œæˆ/æˆåŠŸ
- ğŸŸ¡ é»„è‰²ï¼šé‡è¦èŠ‚ç‚¹
- â­ æ˜Ÿæ ‡ï¼šç‰¹åˆ«é‡è¦

**èŠ‚ç‚¹ç±»å‹**ï¼š
- `[çŸ©å½¢]`: å¤„ç†æ­¥éª¤
- `{è±å½¢}`: åˆ¤æ–­æ¡ä»¶
- `([åœ†è§’])`: å¼€å§‹/ç»“æŸ
- `subgraph`: åˆ†ç»„/é˜¶æ®µ

---

## å…³é”®è¦ç‚¹é€ŸæŸ¥

### ModuleGraph æ ¸å¿ƒ

```
ä¸¤ä¸ªæ ¸å¿ƒ Mapï¼š
â”œâ”€ _dependencyMap: Dependency â†’ Connection (WeakMap)
â””â”€ _moduleMap: Module â†’ ModuleGraphModule (Map)

åŒå‘è¿æ¥ï¼š
â”œâ”€ incoming: è°ä¾èµ–æˆ‘ (Tree Shaking)
â””â”€ outgoing: æˆ‘ä¾èµ–è° (é€’å½’æ„å»º)
```

### æ„å»ºæ ¸å¿ƒ

```
é€’å½’ä¸‰è¦ç´ ï¼š
1. factorizeModule - åˆ›å»ºæ¨¡å—
2. setResolvedModule - å»ºç«‹è¿æ¥ â­â­â­
3. processModuleDependencies - é€’å½’å¤„ç†

å»é‡æœºåˆ¶ï¼š
identifier = type|path
_modules.get(identifier) â†’ å¤ç”¨å·²å­˜åœ¨
```

### æ€§èƒ½ä¼˜åŒ–

```
ä¸‰çº§ç¼“å­˜ï¼š
â”œâ”€ è¶…å¿«è·¯å¾„: 99% (æ„é€ å‡½æ•°ç›¸åŒ)
â”œâ”€ å¿«è·¯å¾„: 0.9% (å·¥å‚ç›¸åŒ)
â””â”€ æ…¢è·¯å¾„: 0.1% (Map æŸ¥æ‰¾)

å†…å­˜ä¼˜åŒ–ï¼š
â”œâ”€ WeakMap: è‡ªåŠ¨ GC
â”œâ”€ æ‡’åˆ›å»º: èŠ‚çœ 50% å†…å­˜
â””â”€ å»é‡: é¿å…é‡å¤æ„å»º
```

---

**ç›¸å…³æ–‡æ¡£**ï¼š
- 05-ä¾èµ–å›¾æ„å»ºåŸç†è¯¦è§£.mdï¼ˆæ–‡å­—è¯¦è§£ï¼‰
- 04-Webpackæ ¸å¿ƒè¿è¡Œæµç¨‹è¯¦è§£.mdï¼ˆå®Œæ•´æµç¨‹ï¼‰
- 08-æ„å»ºé˜¶æ®µï¼ˆMakeï¼‰.mdï¼ˆMake é˜¶æ®µï¼‰

**ç›¸å…³ä»£ç **ï¼ˆå·²æ·»åŠ è¯¦ç»†é€è¡Œæ³¨é‡Šï¼‰ï¼š
- lib/ModuleGraph.jsï¼ˆ80% æ³¨é‡Šï¼‰
- lib/Compilation.jsï¼ˆ85% æ³¨é‡Šï¼Œæ ¸å¿ƒæ–¹æ³• 100%ï¼‰
- lib/NormalModuleFactory.jsï¼ˆ85% æ³¨é‡Šï¼‰

