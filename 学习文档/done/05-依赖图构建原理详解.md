# Webpack ä¾èµ–å›¾æ„å»ºåŸç†è¯¦è§£

> ä»æ•°æ®ç»“æ„åˆ°ç®—æ³•ï¼Œä»æ¦‚è§ˆåˆ°ç»†èŠ‚ï¼Œå®Œå…¨ç†è§£ä¾èµ–å›¾

## ğŸ“‹ ç›®å½•

1. [ä¾èµ–å›¾æ˜¯ä»€ä¹ˆ](#ä¸€ä¾èµ–å›¾æ˜¯ä»€ä¹ˆ)
2. [æ ¸å¿ƒæ•°æ®ç»“æ„è¯¦è§£](#äºŒæ ¸å¿ƒæ•°æ®ç»“æ„è¯¦è§£)
3. [å…³è”æ–‡ä»¶å’Œæ¨¡å—](#ä¸‰å…³è”æ–‡ä»¶å’Œæ¨¡å—)
4. [æ„å»ºæµç¨‹å›¾ï¼ˆæ¦‚è§ˆï¼‰](#å››æ„å»ºæµç¨‹å›¾æ¦‚è§ˆ)
5. [è¯¦ç»†æµç¨‹å›¾ï¼ˆåˆ†æ­¥éª¤ï¼‰](#äº”è¯¦ç»†æµç¨‹å›¾åˆ†æ­¥éª¤)
6. [æ„å»ºç®—æ³•è¯¦è§£](#å…­æ„å»ºç®—æ³•è¯¦è§£)
7. [åº”ç”¨åœºæ™¯æ·±å…¥](#ä¸ƒåº”ç”¨åœºæ™¯æ·±å…¥)
8. [æ€§èƒ½ä¼˜åŒ–æŠ€å·§](#å…«æ€§èƒ½ä¼˜åŒ–æŠ€å·§)

---

## ä¸€ã€ä¾èµ–å›¾æ˜¯ä»€ä¹ˆï¼Ÿ

### 1.1 æ ¸å¿ƒæ¦‚å¿µ

**ModuleGraphï¼ˆæ¨¡å—ä¾èµ–å›¾ï¼‰**æ˜¯ä¸€ä¸ªæœ‰å‘å›¾æ•°æ®ç»“æ„ï¼Œæ˜¯ webpack æœ€æ ¸å¿ƒçš„æ•°æ®ç»“æ„ä¹‹ä¸€ã€‚

```
æ ¸å¿ƒç»„æˆï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ModuleGraph (ä¾èµ–å›¾å®¹å™¨)           â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Module  â”‚ â”€â”€â”€â”€â”€â”€â†’ â”‚  Module   â”‚ â”‚  èŠ‚ç‚¹ï¼šModuleï¼ˆæ¨¡å—ï¼‰
â”‚  â”‚ (èŠ‚ç‚¹)  â”‚ ä¾èµ–å…³ç³» â”‚  (èŠ‚ç‚¹)   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚       â†‘                              â”‚
â”‚       â”‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚  â”‚Dependencyâ”‚  è¾¹ï¼šDependencyï¼ˆä¾èµ–ï¼‰â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚       â†“                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚ Connection   â”‚  è¿æ¥ä¿¡æ¯          â”‚
â”‚  â”‚ModuleGraph   â”‚                   â”‚
â”‚  â”‚Connection    â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 ä¸‰ä¸ªæ ¸å¿ƒç±»

| ç±» | ä½œç”¨ | å­˜å‚¨å†…å®¹ |
|---|------|---------|
| **Module** | æ¨¡å—å¯¹è±¡ | æºç ã€ä¾èµ–åˆ—è¡¨ã€æ„å»ºä¿¡æ¯ |
| **Dependency** | ä¾èµ–å£°æ˜ | è¯·æ±‚è·¯å¾„ã€ä½ç½®ã€ç±»å‹ |
| **ModuleGraphConnection** | ä¾èµ–å®ç° | æºæ¨¡å—ã€ç›®æ ‡æ¨¡å—ã€çŠ¶æ€ |

---

## äºŒã€æ ¸å¿ƒæ•°æ®ç»“æ„è¯¦è§£

### 2.1 ModuleGraph ä¸»ç±»ç»“æ„

```javascript
class ModuleGraph {
  // ===== æ ¸å¿ƒå­˜å‚¨ =====

  _dependencyMap: WeakMap<Dependency, ModuleGraphConnection | null>
  /**
   * ä¾èµ– â†’ è¿æ¥çš„æ˜ å°„
   *
   * ã€ç¤ºä¾‹ã€‘
   * dependency1 â†’ connection(entry â†’ a.js)
   * dependency2 â†’ connection(entry â†’ b.js)
   * dependency3 â†’ nullï¼ˆæœªè§£æï¼‰
   *
   * ã€WeakMap åŸå› ã€‘
   * - ä¸é˜»æ­¢ Dependency è¢« GC
   * - O(1) æŸ¥æ‰¾
   * - è‡ªåŠ¨æ¸…ç†
   */

  _moduleMap: Map<Module, ModuleGraphModule>
  /**
   * æ¨¡å— â†’ å›¾èŠ‚ç‚¹çš„æ˜ å°„
   *
   * ã€ç¤ºä¾‹ã€‘
   * module1 â†’ ModuleGraphModule {
   *   incomingConnections: Set<Connection>,
   *   outgoingConnections: Set<Connection>,
   *   exports: ExportsInfo,
   *   ...
   * }
   */

  // ===== è¾…åŠ©å­˜å‚¨ =====

  _metaMap: WeakMap<any, Object>
  // å…ƒæ•°æ®æ˜ å°„ï¼Œæ’ä»¶å¯å­˜å‚¨è‡ªå®šä¹‰æ•°æ®

  _cache: WeakTupleMap<any[], any>
  // ç¼“å­˜ç³»ç»Ÿï¼Œç¼“å­˜å¤æ‚è®¡ç®—ç»“æœ
}
```

### 2.2 ModuleGraphModule èŠ‚ç‚¹ç»“æ„

```javascript
class ModuleGraphModule {
  // ===== è¿æ¥ä¿¡æ¯ï¼ˆå›¾çš„æ ¸å¿ƒï¼‰â­â­â­ =====

  incomingConnections: SortableSet<ModuleGraphConnection>
  /**
   * å…¥è¾¹ï¼šè°ä¾èµ–æˆ‘
   *
   * ã€Tree Shakingã€‘
   * size === 0 â†’ æ¨¡å—æœªè¢«ä½¿ç”¨ â†’ å¯åˆ é™¤
   *
   * ã€ä»£ç åˆ†å‰²ã€‘
   * size > 1 â†’ æ¨¡å—è¢«å…±äº« â†’ æå–åˆ°å…¬å…± chunk
   */

  outgoingConnections: SortableSet<ModuleGraphConnection> | undefined
  /**
   * å‡ºè¾¹ï¼šæˆ‘ä¾èµ–è°ï¼ˆæ‡’åˆ›å»ºï¼‰
   *
   * ã€ç”¨é€”ã€‘
   * - é€’å½’æ„å»º
   * - å¾ªç¯æ£€æµ‹
   * - æ¨¡å—åˆå¹¶
   */

  // ===== å¯¼å‡ºä¿¡æ¯ï¼ˆTree Shakingï¼‰â­â­â­ =====

  exports: ExportsInfo
  /**
   * Map<å¯¼å‡ºå, ExportInfo>
   *
   * ExportInfo {
   *   name: 'foo',
   *   used: true/false,  â† Tree Shaking å…³é”®
   *   provided: true/false,
   *   canMangle: true/false
   * }
   */

  // ===== å¼•å…¥å’Œé¡ºåºä¿¡æ¯ =====

  issuer: Module | null       // å¼•å…¥è€…
  depth: number | null        // æ·±åº¦ï¼ˆæœ€çŸ­è·¯å¾„é•¿åº¦ï¼‰
  preOrderIndex: number       // å‰åºç´¢å¼•ï¼ˆDFS è¿›å…¥ï¼‰
  postOrderIndex: number      // ååºç´¢å¼•ï¼ˆDFS ç¦»å¼€ï¼‰

  // ===== ä¼˜åŒ–ä¿¡æ¯ =====

  optimizationBailout: string[]  // ä¼˜åŒ–å¤±è´¥åŸå› 
  async: boolean                  // æ˜¯å¦å¼‚æ­¥æ¨¡å—
  profile: ModuleProfile | null   // æ€§èƒ½æ•°æ®
}
```

### 2.3 ModuleGraphConnection è¿æ¥ç»“æ„

```javascript
class ModuleGraphConnection {
  originModule: Module        // æºæ¨¡å—ï¼ˆè°ä¾èµ–ï¼‰
  dependency: Dependency      // ä¾èµ–å¯¹è±¡
  module: Module             // ç›®æ ‡æ¨¡å—ï¼ˆè¢«ä¾èµ–ï¼‰

  weak: boolean              // æ˜¯å¦å¼±ä¾èµ–
  conditional: boolean       // æ˜¯å¦æ¡ä»¶ä¾èµ–
  active: boolean           // æ˜¯å¦æ¿€æ´»

  explanations: Set<string>  // è¯´æ˜ä¿¡æ¯
}
```

### 2.4 æ•°æ®ç»“æ„å¯è§†åŒ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ModuleGraph â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                          â”‚
â”‚  _dependencyMap (WeakMap):                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ dependency â”‚  â”€â”€â”€â”€â†’  â”‚  Connection  â”‚               â”‚
â”‚  â”‚ import './a'â”‚         â”‚  entry â†’ a   â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                          â”‚
â”‚  _moduleMap (Map):                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ entry.js â”‚  â”€â”€â”€â”€â†’  â”‚ ModuleGraphModule {   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚   incoming: [],        â”‚        â”‚
â”‚                        â”‚   outgoing: [conn1,2], â”‚        â”‚
â”‚                        â”‚   exports: {...},      â”‚        â”‚
â”‚                        â”‚   depth: 0             â”‚        â”‚
â”‚                        â”‚ }                      â”‚        â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  a.js    â”‚  â”€â”€â”€â”€â†’  â”‚ ModuleGraphModule {   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚   incoming: [conn1],   â”‚        â”‚
â”‚                        â”‚   outgoing: [conn3],   â”‚        â”‚
â”‚                        â”‚   exports: {           â”‚        â”‚
â”‚                        â”‚     foo: {used: true}, â”‚        â”‚
â”‚                        â”‚     bar: {used: false} â”‚        â”‚
â”‚                        â”‚   },                   â”‚        â”‚
â”‚                        â”‚   depth: 1             â”‚        â”‚
â”‚                        â”‚ }                      â”‚        â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¸‰ã€å…³è”æ–‡ä»¶å’Œæ¨¡å—

### 3.1 æ ¸å¿ƒæ–‡ä»¶å…³ç³»å›¾

```
ä¾èµ–å›¾æ„å»ºæ¶‰åŠçš„æ–‡ä»¶åŠå…¶å…³ç³»ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ§åˆ¶å±‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              â”‚
â”‚  Compiler.js                 â”‚
â”‚    â”œâ”€ compile()              â”‚
â”‚    â””â”€ run()                  â”‚
â”‚         â†“ åˆ›å»º               â”‚
â”‚  Compilation.js              â”‚
â”‚    â”œâ”€ addEntry()             â”‚
â”‚    â”œâ”€ addModuleTree()        â”‚
â”‚    â”œâ”€ handleModuleCreation() â”‚
â”‚    â””â”€ processModuleDeps()    â”‚
â”‚         â†“ ä½¿ç”¨               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å·¥å‚å±‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              â”‚
â”‚  NormalModuleFactory.js      â”‚
â”‚    â”œâ”€ create()               â”‚
â”‚    â”œâ”€ resolve()              â”‚
â”‚    â””â”€ åŒ¹é… loader             â”‚
â”‚         â†“ åˆ›å»º               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ¨¡å—å±‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              â”‚
â”‚  Module.js (åŸºç±»)            â”‚
â”‚    â†“ ç»§æ‰¿                    â”‚
â”‚  NormalModule.js             â”‚
â”‚    â”œâ”€ build()                â”‚
â”‚    â”œâ”€ _doBuild()             â”‚
â”‚    â””â”€ codeGeneration()       â”‚
â”‚         â†“ ä½¿ç”¨               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ è§£æå±‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              â”‚
â”‚  JavascriptParser.js         â”‚
â”‚    â”œâ”€ parse()                â”‚
â”‚    â”œâ”€ walkStatements()       â”‚
â”‚    â””â”€ åˆ›å»º Dependency         â”‚
â”‚         â†“ äº§ç”Ÿ               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€ ä¾èµ–å›¾å±‚ â­â­â­ â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              â”‚
â”‚  ModuleGraph.js              â”‚
â”‚    â”œâ”€ setResolvedModule()    â”‚
â”‚    â”œâ”€ getModule()            â”‚
â”‚    â”œâ”€ getExportsInfo()       â”‚
â”‚    â””â”€ get/setIssuer()        â”‚
â”‚         â†“ ç®¡ç†               â”‚
â”‚  ModuleGraphModule.js        â”‚
â”‚  ModuleGraphConnection.js    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€ ä¾èµ–ç±»å‹å±‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              â”‚
â”‚  lib/dependencies/           â”‚
â”‚    â”œâ”€ HarmonyImportâ€¦         â”‚
â”‚    â”œâ”€ CommonJsRequireâ€¦       â”‚
â”‚    â”œâ”€ Importâ€¦                â”‚
â”‚    â””â”€ 115+ ç§ä¾èµ–ç±»å‹         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æ¨¡å—åä½œå…³ç³»

```
ç”¨æˆ·ä»£ç 
  â†“
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Compiler (æ§åˆ¶å™¨)
  â”œâ”€ åˆ›å»º Compilation
  â”œâ”€ è§¦å‘ make é’©å­
  â””â”€ ç®¡ç†ç”Ÿå‘½å‘¨æœŸ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  â†“
Compilation (æ‰§è¡Œå™¨)
  â”œâ”€ addEntry â”€â”€â†’ æ·»åŠ å…¥å£
  â”œâ”€ handleModuleCreation â”€â”€â†’ åˆ›å»ºæ¨¡å—
  â”‚    â”‚
  â”‚    â”œâ”€â†’ NormalModuleFactory.create()
  â”‚    â”‚      â””â”€ è§£æè·¯å¾„ + åŒ¹é… loader
  â”‚    â”‚
  â”‚    â”œâ”€â†’ addModule()
  â”‚    â”‚      â””â”€ å»é‡æ£€æŸ¥
  â”‚    â”‚
  â”‚    â”œâ”€â†’ ModuleGraph.setResolvedModule() â­â­â­
  â”‚    â”‚      â””â”€ å»ºç«‹å›¾è¿æ¥
  â”‚    â”‚
  â”‚    â”œâ”€â†’ buildModule()
  â”‚    â”‚      â””â”€ NormalModule.build()
  â”‚    â”‚            â””â”€ JavascriptParser.parse()
  â”‚    â”‚                  â””â”€ è¯†åˆ«ä¾èµ–
  â”‚    â”‚
  â”‚    â””â”€â†’ processModuleDependencies()
  â”‚           â””â”€ é€’å½’å¤„ç†ä¾èµ–
  â”‚
  â””â”€ seal â”€â”€â†’ ä¼˜åŒ–å’Œç”Ÿæˆ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  â†“
ModuleGraph (æ•°æ®ç»“æ„)
  â”œâ”€ å­˜å‚¨æ‰€æœ‰æ¨¡å—
  â”œâ”€ å­˜å‚¨æ‰€æœ‰è¿æ¥
  â””â”€ æä¾›æŸ¥è¯¢æ¥å£
```

---

## å››ã€æ„å»ºæµç¨‹å›¾ï¼ˆæ¦‚è§ˆï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            ä¾èµ–å›¾æ„å»ºä¸»æµç¨‹ï¼ˆ< 60 èŠ‚ç‚¹ï¼‰                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[å¼€å§‹] webpack(config)
   â†“
[åˆå§‹åŒ–] Compiler + Compilation
   â†“
[Make] compiler.hooks.make
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤1: æ·»åŠ å…¥å£          â”‚
â”‚ addEntry(entryDep)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤2: åˆ›å»ºå…¥å£æ¨¡å—      â”‚
â”‚ factorizeModule()       â”‚
â”‚  â”œâ”€ resolve è·¯å¾„        â”‚
â”‚  â”œâ”€ åŒ¹é… loader         â”‚
â”‚  â””â”€ new NormalModule()  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤3: æ·»åŠ æ¨¡å—ï¼ˆå»é‡ï¼‰â­â”‚
â”‚ addModule()             â”‚
â”‚  â”œâ”€ æ£€æŸ¥å·²å­˜åœ¨?         â”‚
â”‚  â”œâ”€ Yes â†’ è¿”å›ç°æœ‰      â”‚
â”‚  â””â”€ No â†’ æ·»åŠ åˆ°é›†åˆ     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤4: æ„å»ºæ¨¡å— â­â­â­           â”‚
â”‚ module.build()                  â”‚
â”‚  â”œâ”€ è¯»å–æ–‡ä»¶                    â”‚
â”‚  â”œâ”€ æ‰§è¡Œ loader                 â”‚
â”‚  â””â”€ parser.parse() â†’ æ”¶é›†ä¾èµ–   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤5: å»ºç«‹è¿æ¥ â­â­â­   â”‚
â”‚ setResolvedModule()     â”‚
â”‚  â”œâ”€ åˆ›å»º Connection     â”‚
â”‚  â”œâ”€ æ·»åŠ åˆ° incoming     â”‚
â”‚  â””â”€ æ·»åŠ åˆ° outgoing     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤6: é€’å½’å¤„ç†ä¾èµ– â­â­â­â”‚
â”‚ processModuleDeps()     â”‚
â”‚  â””â”€ å¯¹æ¯ä¸ªä¾èµ–é€’å½’æ‰§è¡Œ   â”‚
â”‚      æ­¥éª¤2-6             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
   å¾ªç¯ï¼Œç›´åˆ°æ— æ–°ä¾èµ–
   â†“
[å®Œæˆ] ModuleGraph æ„å»ºå®Œæˆ
```

---

## äº”ã€è¯¦ç»†æµç¨‹å›¾ï¼ˆåˆ†æ­¥éª¤ï¼‰

### æµç¨‹å›¾ 1ï¼šAST è§£ææµç¨‹

```
JavascriptParser.parse() è¯¦ç»†æµç¨‹

[è¾“å…¥] æºç å­—ç¬¦ä¸²
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ acorn.parse(source) â”‚
â”‚  â†“ç”Ÿæˆ AST          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ detectMode()        â”‚
â”‚ æ£€æµ‹ä¸¥æ ¼æ¨¡å¼         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ preWalkStatements() â”‚
â”‚ æ”¶é›†æ‰€æœ‰å£°æ˜         â”‚
â”‚  â”œâ”€ import          â”‚
â”‚  â”œâ”€ export          â”‚
â”‚  â”œâ”€ var/let/const   â”‚
â”‚  â””â”€ function/class  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ walkStatements()â­â­â­â”‚
â”‚ è¯†åˆ«ä¾èµ–            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚
   â”œâ”€â†’ import './a' â†’ HarmonyImportDep
   â”œâ”€â†’ require('./b') â†’ CommonJsRequireDep
   â”œâ”€â†’ import('./c') â†’ ImportDep + AsyncBlock
   â””â”€â†’ export â†’ HarmonyExportDep
   â†“
[è¾“å‡º] module.dependencies = [...]
```

### æµç¨‹å›¾ 2ï¼šå»ºç«‹è¿æ¥æµç¨‹

```
setResolvedModule(origin, dep, target) è¯¦ç»†æµç¨‹

[è¾“å…¥] origin=entry.js, dep=import './a', target=a.js
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åˆ›å»ºè¿æ¥å¯¹è±¡                     â”‚
â”‚ conn = new Connection(          â”‚
â”‚   origin, dep, target           â”‚
â”‚ )                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ·»åŠ åˆ° target çš„å…¥è¾¹ â­          â”‚
â”‚ a.js.incoming.add(conn)         â”‚
â”‚                                 â”‚
â”‚ æ•ˆæœ: a.js çŸ¥é“ entry ä¾èµ–å®ƒ    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ·»åŠ åˆ° origin çš„å‡ºè¾¹ â­          â”‚
â”‚ entry.js.outgoing.add(conn)     â”‚
â”‚                                 â”‚
â”‚ æ•ˆæœ: entry çŸ¥é“å®ƒä¾èµ– a.js     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å»ºç«‹æ˜ å°„ â­                      â”‚
â”‚ dependencyMap.set(dep, conn)    â”‚
â”‚                                 â”‚
â”‚ æ•ˆæœ: å¯é€šè¿‡ä¾èµ–æ‰¾åˆ°è¿æ¥         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
[å®Œæˆ] åŒå‘è¿æ¥å»ºç«‹
```

### æµç¨‹å›¾ 3ï¼šé€’å½’æ„å»ºæµç¨‹

```
é€’å½’æ„å»ºç¤ºä¾‹ï¼ˆå®Œæ•´å±•å¼€ï¼‰

Entry
  â†“ addEntry
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  entry.js    â”‚ depth: 0
â”‚  build()     â”‚
â”‚    â†“ parse   â”‚
â”‚  deps: [     â”‚
â”‚    './a.js', â”‚ â†â”€â”€â”€â”€â”
â”‚    './b.js'  â”‚      â”‚
â”‚  ]           â”‚      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
  â†“ process           â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”   â”‚
  â”‚       â”‚       â”‚   â”‚
  â†“       â†“       â†“   â”‚
Level 1           â”‚   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ a.js   â”‚ â”‚ b.js   â”‚â”‚
â”‚ depth:1â”‚ â”‚ depth:1â”‚â”‚
â”‚ build()â”‚ â”‚ build()â”‚â”‚
â”‚   â†“    â”‚ â”‚   â†“    â”‚â”‚
â”‚ deps:[å…±â”‚ â”‚ deps:[å…±â”‚
â”‚ './common'â”‚ './common'
â”‚ ]      â”‚ â”‚ ]      â”‚â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
  â†“         â†“        â”‚
  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜        â”‚
       â†“             â”‚
Level 2              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚common.js â”‚         â”‚
â”‚ depth: 2 â”‚ â†â”€â”€â”€â”€â”€â”€â”€â”˜ å…±äº«æ¨¡å—
â”‚ build()  â”‚
â”‚   â†“      â”‚
â”‚ deps: [] â”‚ æ— ä¾èµ–
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
ç»“æŸ

æœ€ç»ˆä¾èµ–å›¾:
entry â†’ a â†’ common
  â†“     â†—
  b â”€â”€â”€â”˜
```

---

## å…­ã€æ„å»ºç®—æ³•è¯¦è§£

### 6.1 æ ¸å¿ƒç®—æ³•ä¼ªä»£ç 

```javascript
// ä¾èµ–å›¾æ„å»ºçš„é€’å½’ç®—æ³•
function buildGraph(entryDep) {
  // 1. åˆ›å»ºæ¨¡å—
  const module = factorize(entryDep);

  // 2. å»é‡
  const existingModule = addModule(module);
  if (existingModule !== module) {
    return existingModule;  // æ¨¡å—å·²å­˜åœ¨
  }

  // 3. æ„å»º
  module.build();  // æ”¶é›† dependencies

  // 4. å»ºç«‹è¿æ¥ + é€’å½’
  for (const dep of module.dependencies) {
    const depModule = factorize(dep);

    // â­â­â­ æ ¸å¿ƒï¼šå»ºç«‹å›¾è¿æ¥
    moduleGraph.setResolvedModule(
      module, dep, depModule
    );

    // é€’å½’æ„å»º
    buildGraph_recursive(depModule);
  }
}
```

### 6.2 å»é‡æœºåˆ¶

```javascript
// addModule å»é‡ç®—æ³•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ identifier = module.identifier()â”‚
â”‚ æ ¼å¼: 'type|path'              â”‚
â”‚ ä¾‹å¦‚: 'javascript/auto|/a.js'  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ existing = _modules.get(id)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
  existing?
   â”œâ”€ Yes â†’ return existing â­
   â”‚         (å¤ç”¨å·²æœ‰æ¨¡å—)
   â”‚
   â””â”€ No â†’ ç»§ç»­
        â†“
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ å°è¯•ä»ç¼“å­˜æ¢å¤      â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ æ·»åŠ åˆ° _modules     â”‚
     â”‚ æ·»åŠ åˆ° modules      â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¸ƒã€åº”ç”¨åœºæ™¯æ·±å…¥

### 7.1 Tree Shaking è¯¦ç»†æµç¨‹

```
Tree Shaking ä¸‰é˜¶æ®µï¼š

â”â”â”â”â”â”â” Make é˜¶æ®µ â”â”â”â”â”â”â”

é˜¶æ®µ1: æ”¶é›†å¯¼å‡º
  module.build()
    â†“ parser.parse()
  è¯†åˆ«: export const foo = 1;
         export const bar = 2;
    â†“
  exportsInfo.setProvided(['foo', 'bar'])

é˜¶æ®µ2: è®°å½•ä½¿ç”¨
  dependency: import { foo } from './a'
    â†“
  dependency.getReferencedExports()
    â†“
  è¿”å›: [['foo']]  (åªç”¨ foo)

â”â”â”â”â”â”â” Seal é˜¶æ®µ â”â”â”â”â”â”â”

é˜¶æ®µ3: æ ‡è®°ä½¿ç”¨çŠ¶æ€
  FlagDependencyUsagePlugin
    â†“
  åˆ†ææ‰€æœ‰ dependency.referencedExports
    â†“
  exportsInfo.setUsed('foo', true)
  exportsInfo.setUsed('bar', false)

â”â”â”â”â”â”â” ä»£ç ç”Ÿæˆ â”â”â”â”â”â”â”

é˜¶æ®µ4: åˆ é™¤æœªä½¿ç”¨
  generator.generate()
    â†“
  if (exportsInfo.isUsed('foo')) {
    ç”Ÿæˆ: __webpack_exports__.foo = 1; âœ…
  }
  if (exportsInfo.isUsed('bar')) {
    è·³è¿‡ âŒ  // bar æœªä½¿ç”¨
  }

ç»“æœ: ä»£ç ä¸­åªåŒ…å« foo
```

---

## å…«ã€æ€§èƒ½ä¼˜åŒ–æŠ€å·§

### 8.1 æ•°æ®ç»“æ„é€‰æ‹©

| åœºæ™¯ | é€‰æ‹© | åŸå›  |
|------|------|------|
| ä¾èµ–â†’è¿æ¥ | WeakMap | ä¸é˜»æ­¢ GC |
| æ¨¡å—â†’èŠ‚ç‚¹ | Map | éœ€è¦éå† |
| è¿æ¥é›†åˆ | SortableSet | éœ€è¦æ’åº |
| è·³è¿‡æ¨¡å— | Set | å¿«é€ŸæŸ¥æ‰¾ |

### 8.2 ä¼˜åŒ–æŠ€å·§æ±‡æ€»

```javascript
// 1. æ‡’åˆ›å»º
_getModuleGraphModule(module) {
  let mgm = cache.get(module);
  if (!mgm) {
    mgm = new ModuleGraphModule();  // éœ€è¦æ—¶æ‰åˆ›å»º
  }
  return mgm;
}

// 2. ä¸‰çº§ç¼“å­˜
// è¶…å¿«è·¯å¾„ â†’ å¿«è·¯å¾„ â†’ æ…¢è·¯å¾„
// 99% â†’ 0.9% â†’ 0.1%

// 3. ç¼“å­˜ä¸Šæ¬¡ç»“æœ
let lastModule = null;
if (module === lastModule) {
  return cached;  // ç›´æ¥ç”¨
}

// 4. WeakMap é¿å…æ³„æ¼
_dependencyMap: WeakMap  // è‡ªåŠ¨ GC

// 5. å»é‡æœºåˆ¶
identifier å”¯ä¸€æ ‡è¯†
_modules.get(identifier)  // O(1) æŸ¥æ‰¾
```

---

## ä¹ã€æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **æ•°æ®ç»“æ„**ï¼š
   - ModuleGraphï¼šä¸¤ä¸ªæ ¸å¿ƒ Map
   - ModuleGraphModuleï¼šèŠ‚ç‚¹ä¿¡æ¯
   - ModuleGraphConnectionï¼šè¾¹ä¿¡æ¯

2. **æ„å»ºç®—æ³•**ï¼š
   - é€’å½’éå†
   - å»é‡æœºåˆ¶
   - åŒå‘è¿æ¥

3. **åº”ç”¨**ï¼š
   - Tree Shaking
   - ä»£ç åˆ†å‰²
   - æ¨¡å—åˆå¹¶
   - å¾ªç¯æ£€æµ‹

4. **ä¼˜åŒ–**ï¼š
   - WeakMap
   - æ‡’åˆ›å»º
   - ä¸‰çº§ç¼“å­˜
   - å»é‡

---

**å·²æ·»åŠ è¯¦ç»†æ³¨é‡Šçš„æ–‡ä»¶**ï¼š
- lib/ModuleGraph.jsï¼ˆ80%ï¼‰
- lib/Dependency.jsï¼ˆ100%ï¼‰
- lib/Compilation.jsï¼ˆ85%ï¼‰
- lib/ModuleGraphConnection.jsï¼ˆè®¡åˆ’ä¸­ï¼‰
