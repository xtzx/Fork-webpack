å¥½çš„ï¼è®©æˆ‘ä»”ç»†é˜…è¯»æºç ï¼Œé‡æ–°æ¢³ç†åˆå§‹åŒ–é˜¶æ®µçš„å®Œæ•´æµç¨‹ï¼š
Ran tool

å¥½çš„ï¼è®©æˆ‘ä»”ç»†é˜…è¯»æºç åï¼Œä¸ºä½ æä¾›**æœ€å‡†ç¡®**çš„åˆå§‹åŒ–é˜¶æ®µæµç¨‹ï¼š

---

## ğŸ“‹ åˆå§‹åŒ–ï¼ˆInitializationï¼‰é˜¶æ®µ - å®Œæ•´æµç¨‹ï¼ˆåŸºäºæºç ï¼‰

### æ–‡å­—ç‰ˆè¯¦ç»†æµç¨‹ â­â­â­

```
ç”¨æˆ·æ‰§è¡Œ: webpack / webpack-cli
  â†“
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
é˜¶æ®µ0: å‘½ä»¤è¡Œå…¥å£ï¼ˆå¯é€‰ï¼‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

bin/webpack.jsï¼ˆå¦‚æœé€šè¿‡å‘½ä»¤è¡Œï¼‰
  â”œâ”€ æ£€æŸ¥ webpack-cli æ˜¯å¦å®‰è£…
  â”œâ”€ å¦‚æœæœªå®‰è£… â†’ æ£€æµ‹åŒ…ç®¡ç†å™¨ï¼ˆyarn.lock/pnpm-lock.yaml/npmï¼‰
  â”œâ”€ è¯¢é—®ç”¨æˆ·æ˜¯å¦å®‰è£…
  â”œâ”€ å®‰è£… webpack-cli
  â””â”€ åŠ è½½å¹¶è¿è¡Œ webpack-cli

webpack-cliï¼ˆå‘½ä»¤è¡Œç•Œé¢ï¼‰
  â”œâ”€ è§£æå‘½ä»¤è¡Œå‚æ•°ï¼ˆ--mode, --entry, --config ç­‰ï¼‰
  â”œâ”€ åŠ è½½é…ç½®æ–‡ä»¶ï¼ˆwebpack.config.jsï¼‰
  â”œâ”€ åˆå¹¶é…ç½®ï¼ˆCLI å‚æ•° > é…ç½®æ–‡ä»¶ï¼‰
  â””â”€ è°ƒç”¨ webpack() API â­ è¿›å…¥æ ¸å¿ƒæµç¨‹

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
é˜¶æ®µ1: webpack() ä¸»å‡½æ•°æ‰§è¡Œ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

lib/webpack.js: webpack(options, callback?)
  â†“
æ­¥éª¤1: æ‰§è¡Œå†…éƒ¨ create() å‡½æ•°
  â†“
  æ­¥éª¤1.1: é…ç½®éªŒè¯ï¼ˆä¸¤é˜¶æ®µéªŒè¯ç­–ç•¥ï¼‰â­â­
    â”œâ”€ ç¬¬ä¸€é˜¶æ®µ: é¢„ç¼–è¯‘ schema å¿«é€Ÿæ£€æŸ¥
    â”‚   â””â”€ webpackOptionsSchemaCheck(options)
    â”‚       â””â”€ schemas/WebpackOptions.check.jsï¼ˆé¢„ç¼–è¯‘çš„éªŒè¯å‡½æ•°ï¼‰
    â”‚       â””â”€ æ€§èƒ½: ~2msï¼ˆéå¸¸å¿«ï¼‰
    â”‚       â””â”€ å¦‚æœé€šè¿‡ â†’ ç»§ç»­
    â”‚       â””â”€ å¦‚æœå¤±è´¥ â†’ è¿›å…¥ç¬¬äºŒé˜¶æ®µ
    â”‚
    â””â”€ ç¬¬äºŒé˜¶æ®µ: å®Œæ•´ schema è¯¦ç»†æ£€æŸ¥
        â””â”€ getValidateSchema()(webpackOptionsSchema, options)
            â””â”€ ä½¿ç”¨ ajv åº“éªŒè¯
            â””â”€ æä¾›è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ï¼ˆå“ªä¸ªå­—æ®µã€æœŸæœ›ç±»å‹ã€å®é™…å€¼ï¼‰
            â””â”€ æ€§èƒ½: ~50msï¼ˆè¾ƒæ…¢ï¼Œä½†é”™è¯¯ä¿¡æ¯è¯¦ç»†ï¼‰
            â””â”€ å¦‚æœå¤±è´¥ â†’ æŠ›å‡º WebpackOptionsValidationError
  â†“
  æ­¥éª¤1.2: åˆ¤æ–­å•é…ç½® vs å¤šé…ç½® â­â­
    â”œâ”€ if (Array.isArray(options))
    â”‚   â”œâ”€ å¤šé…ç½®åˆ†æ”¯:
    â”‚   â”‚   â”œâ”€ ä¸ºæ¯ä¸ªé…ç½®è°ƒç”¨ createCompiler(config)
    â”‚   â”‚   â”œâ”€ åˆ›å»º MultiCompiler(compilers)
    â”‚   â”‚   â”œâ”€ è®¾ç½®é…ç½®é—´ä¾èµ–å…³ç³»ï¼ˆdependenciesï¼‰
    â”‚   â”‚   â””â”€ è¿”å› { compiler: MultiCompiler, watch, watchOptions }
    â”‚   â”‚
    â”‚   â””â”€ å•é…ç½®åˆ†æ”¯:
    â”‚       â”œâ”€ è°ƒç”¨ createCompiler(options) â­â­â­ æ ¸å¿ƒ
    â”‚       â””â”€ è¿”å› { compiler: Compiler, watch, watchOptions }
    â”‚
    â””â”€ è¿”å› { compiler, watch, watchOptions }

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
é˜¶æ®µ2: createCompiler() - å•ä¸ªç¼–è¯‘å™¨åˆ›å»ºï¼ˆæ ¸å¿ƒï¼‰â­â­â­
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

lib/webpack.js: createCompiler(rawOptions)
  â†“
æ­¥éª¤2.1: è§„èŒƒåŒ–é…ç½®
  â””â”€ const options = getNormalizedWebpackOptions(rawOptions)
      â””â”€ lib/config/normalization.js
      â””â”€ ä½œç”¨: ç»Ÿä¸€é…ç½®æ ¼å¼
          â”œâ”€ entry: string â†’ {main: {import: [string]}}
          â”œâ”€ output: string â†’ {path: string, ...}
          â”œâ”€ æ•°ç»„ â†’ å¯¹è±¡
          â””â”€ ç®€å†™ â†’ å®Œæ•´å½¢å¼
  â†“
æ­¥éª¤2.2: åº”ç”¨åŸºç¡€é»˜è®¤å€¼
  â””â”€ applyWebpackOptionsBaseDefaults(options)
      â””â”€ lib/config/defaults.js
      â””â”€ ä½œç”¨: åªè®¾ç½®åˆ›å»º Compiler å¿…éœ€çš„é…ç½®
          â”œâ”€ context: process.cwd()ï¼ˆå·¥ä½œç›®å½•ï¼‰
          â”œâ”€ infrastructureLogging: {}ï¼ˆæ—¥å¿—é…ç½®ï¼‰
          â””â”€ å…¶ä»–æš‚ä¸è®¾ç½®ï¼ˆç­‰ç”¨æˆ·æ’ä»¶æ³¨å†Œåå†è®¾ç½®ï¼‰
  â†“
æ­¥éª¤2.3: åˆ›å»º Compiler å®ä¾‹ â­â­â­
  â””â”€ const compiler = new Compiler(options.context, options)
      â””â”€ lib/Compiler.js: constructor
      â””â”€ æ‰§è¡Œå†…å®¹:
          â”œâ”€ åˆå§‹åŒ– 30+ é’©å­ï¼ˆhooksï¼‰
          â”œâ”€ ä¿å­˜é…ç½®ï¼ˆthis.options = optionsï¼‰
          â”œâ”€ åˆå§‹åŒ–å±æ€§ï¼ˆrunning, name, startTime ç­‰ï¼‰
          â”œâ”€ åˆ›å»ºç¼“å­˜ç³»ç»Ÿï¼ˆthis.cacheï¼‰
          â”œâ”€ åˆ›å»ºè§£æå™¨å·¥å‚ï¼ˆthis.resolverFactoryï¼‰
          â””â”€ åˆå§‹åŒ–å…¶ä»–ç®¡ç†å™¨
      â””â”€ æ­¤æ—¶ compiler åªæ˜¯åˆ›å»ºäº†ï¼Œæ–‡ä»¶ç³»ç»Ÿè¿˜æœªæ³¨å…¥
  â†“
æ­¥éª¤2.4: åº”ç”¨ Node ç¯å¢ƒæ’ä»¶ â­â­
  â””â”€ new NodeEnvironmentPlugin({...}).apply(compiler)
      â””â”€ lib/node/NodeEnvironmentPlugin.js
      â””â”€ ä½œç”¨: æ³¨å…¥æ–‡ä»¶ç³»ç»Ÿèƒ½åŠ›
          â”œâ”€ compiler.infrastructureLoggerï¼ˆæ—¥å¿—ç³»ç»Ÿï¼‰
          â”œâ”€ compiler.inputFileSystemï¼ˆè¯»å–æºæ–‡ä»¶ï¼‰
          â”‚   â””â”€ CachedInputFileSystem(fs, 60000)
          â”‚   â””â”€ 60ç§’ç¼“å­˜ï¼Œå‡å°‘ç£ç›˜IO
          â”œâ”€ compiler.outputFileSystemï¼ˆå†™å…¥æ„å»ºäº§ç‰©ï¼‰
          â”‚   â””â”€ graceful-fsï¼ˆå¤„ç†EMFILEé”™è¯¯ï¼‰
          â”œâ”€ compiler.intermediateFileSystemï¼ˆä¸­é—´æ–‡ä»¶ï¼‰
          â”œâ”€ compiler.watchFileSystemï¼ˆæ–‡ä»¶ç›‘å¬ï¼‰
          â”‚   â””â”€ NodeWatchFileSystemï¼ˆåŸºäºchokidarï¼‰
          â”‚   â””â”€ ä½¿ç”¨inotify/FSEventsåŸç”Ÿäº‹ä»¶
          â””â”€ æ³¨å†Œ beforeRun é’©å­ï¼ˆæ¸…ç†æ–‡ä»¶ç¼“å­˜ï¼‰
  â†“
æ­¥éª¤2.5: æ³¨å†Œç”¨æˆ·æ’ä»¶ â­â­â­
  â””â”€ for (const plugin of options.plugins) {
        plugin.apply(compiler);
      }
      â””â”€ ç”¨æˆ·æ’ä»¶æ³¨å†Œé’©å­
      â””â”€ ä¾‹å¦‚:
          â”œâ”€ HtmlWebpackPlugin â†’ æ³¨å†Œ processAssets é’©å­
          â”œâ”€ MiniCssExtractPlugin â†’ æ³¨å†Œ thisCompilation é’©å­
          â””â”€ è‡ªå®šä¹‰æ’ä»¶ â†’ æ³¨å†Œå„ç§é’©å­

      âš ï¸ å…³é”®: ä¸ºä»€ä¹ˆåœ¨"åº”ç”¨å®Œæ•´é»˜è®¤å€¼"ä¹‹å‰æ³¨å†Œï¼Ÿ

      åŸå› 1: è®©ç”¨æˆ·æ’ä»¶æœ‰æœºä¼šå½±å“é…ç½®
      ä¾‹å¦‚:
        class MyPlugin {
          apply(compiler) {
            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦é…ç½®äº† optimization.minimize
            if (compiler.options.optimization.minimize === undefined) {
              // ç”¨æˆ·æœªé…ç½®ï¼Œæ’ä»¶å¯ä»¥è®¾ç½®
              compiler.options.optimization.minimize = true;
            }
          }
        }

      åŸå› 2: é»˜è®¤å€¼åº”è¯¥æ ¹æ®"æœ€ç»ˆé…ç½®"æ¨æ–­
        ç”¨æˆ·é…ç½® + ç”¨æˆ·æ’ä»¶ä¿®æ”¹ â†’ æœ€ç»ˆé…ç½® â†’ æ¨æ–­é»˜è®¤å€¼

      åŸå› 3: å…¼å®¹æ€§å’Œçµæ´»æ€§
        æ—§ç‰ˆæœ¬çš„æ’ä»¶å¯èƒ½ä¾èµ–ä¿®æ”¹é…ç½®
  â†“
æ­¥éª¤2.6: åº”ç”¨å®Œæ•´é»˜è®¤å€¼ â­â­â­
  â””â”€ applyWebpackOptionsDefaults(options)
      â””â”€ lib/config/defaults.js
      â””â”€ ä½œç”¨: æ ¹æ®å·²æœ‰é…ç½®æ¨æ–­å…¶ä»–é…ç½®çš„é»˜è®¤å€¼

      æ ¸å¿ƒæ¨æ–­é€»è¾‘:

      1. æ ¹æ® mode æ¨æ–­ â­â­â­
         if (mode === 'production') {
           optimization.minimize = true        // å¯ç”¨å‹ç¼©
           optimization.moduleIds = 'deterministic'
           optimization.chunkIds = 'deterministic'
           optimization.usedExports = true     // Tree Shaking
           optimization.concatenateModules = true  // Scope Hoisting
           optimization.sideEffects = true
           devtool = false                     // ä¸ç”ŸæˆSourceMap
           cache = false                       // ä¸å¯ç”¨ç¼“å­˜
           performance.hints = 'warning'       // æ˜¾ç¤ºæ€§èƒ½è­¦å‘Š
         }

         if (mode === 'development') {
           optimization.minimize = false       // ä¸å‹ç¼©
           optimization.moduleIds = 'named'    // å¯è¯»çš„ID
           optimization.chunkIds = 'named'
           devtool = 'eval'                    // å¿«é€Ÿçš„SourceMap
           cache = { type: 'memory' }          // å†…å­˜ç¼“å­˜
           performance.hints = false           // ä¸æ˜¾ç¤ºè­¦å‘Š
         }

      2. æ ¹æ® target æ¨æ–­ â­â­
         if (target === 'web') {
           output.chunkLoading = 'jsonp'       // JSONPåŠ è½½
           output.globalObject = 'window'
           resolve.mainFields = ['browser', 'module', 'main']
           node.global = false
         }

         if (target === 'node') {
           output.chunkLoading = 'require'     // requireåŠ è½½
           output.globalObject = 'global'
           resolve.mainFields = ['module', 'main']
           node.global = true
           externalsPresets.node = true        // è‡ªåŠ¨external
         }

      3. æ ¹æ® experiments æ¨æ–­
         if (experiments.css) {
           // æ·»åŠ  CSS å¤„ç†è§„åˆ™
           module.rules.push({
             test: /\.css$/,
             type: 'css/auto'
           })
         }

      4. æ ¹æ® output.library æ¨æ–­
         if (output.library.type === 'umd') {
           externalsType = 'umd'
           optimization.concatenateModules = false
         }

      5. æ›´å¤šæ¨æ–­...
         - entry æœªè®¾ç½® â†’ './src/index.js'
         - output.path æœªè®¾ç½® â†’ path.join(context, 'dist')
         - output.filename æœªè®¾ç½® â†’ '[name].js'
         - resolve.extensions æœªè®¾ç½® â†’ ['.js', '.json', '.wasm']
  â†“
æ­¥éª¤2.7: è§¦å‘ç¯å¢ƒé’©å­
  â”œâ”€ compiler.hooks.environment.call()
  â”‚   â””â”€ æ’ä»¶å¯ä»¥åœ¨è¿™é‡Œåšç¯å¢ƒå‡†å¤‡å·¥ä½œ
  â”‚
  â””â”€ compiler.hooks.afterEnvironment.call()
      â””â”€ ç¯å¢ƒå‡†å¤‡å®Œæˆçš„é€šçŸ¥
  â†“
æ­¥éª¤2.8: åº”ç”¨å†…ç½®æ’ä»¶ â­â­â­
  â””â”€ new WebpackOptionsApply().process(options, compiler)
      â””â”€ lib/WebpackOptionsApply.js
      â””â”€ æ ¹æ®é…ç½®æ³¨å†Œ 40+ ä¸ªå†…ç½®æ’ä»¶

      æ³¨å†Œé¡ºåº:

      1. è®¾ç½®åŸºæœ¬å±æ€§
         compiler.outputPath = options.output.path
         compiler.name = options.name

      2. ExternalsPluginï¼ˆå¦‚æœé…ç½®äº† externalsï¼‰

      3. ç¯å¢ƒé¢„è®¾æ’ä»¶
         â”œâ”€ NodeTargetPluginï¼ˆtarget: 'node'ï¼‰
         â”œâ”€ ElectronTargetPluginï¼ˆElectronç¯å¢ƒï¼‰
         â””â”€ WebAsync/Web å¤–éƒ¨ä¾èµ–å¤„ç†

      4. ChunkPrefetchPreloadPluginï¼ˆé¢„åŠ è½½ï¼‰

      5. Chunk æ ¼å¼æ’ä»¶
         â”œâ”€ ArrayPushCallbackChunkFormatPluginï¼ˆJSONPï¼‰
         â”œâ”€ CommonJsChunkFormatPluginï¼ˆCommonJSï¼‰
         â””â”€ ModuleChunkFormatPluginï¼ˆESMï¼‰

      6. Chunk åŠ è½½æ’ä»¶
         â”œâ”€ JsonpChunkLoadingPlugin
         â”œâ”€ ImportScriptsChunkLoadingPlugin
         â””â”€ RequireChunkLoadingPlugin

      7. WASM åŠ è½½æ’ä»¶

      8. åº“è¾“å‡ºæ’ä»¶ï¼ˆå¦‚æœè¾“å‡ºä¸ºåº“ï¼‰

      9. ModuleInfoHeaderPluginï¼ˆpathinfoï¼‰

      10. CleanPluginï¼ˆoutput.cleanï¼‰

      11. SourceMap æ’ä»¶ï¼ˆdevtoolï¼‰â­
          â”œâ”€ SourceMapDevToolPlugin
          â”œâ”€ EvalSourceMapDevToolPlugin
          â””â”€ EvalDevToolModulePlugin

      12. æ ¸å¿ƒæ¨¡å—ç±»å‹æ’ä»¶ â­â­â­
          â”œâ”€ JavascriptModulesPluginï¼ˆå¤„ç† JS æ–‡ä»¶ï¼‰
          â”œâ”€ JsonModulesPluginï¼ˆå¤„ç† JSON æ–‡ä»¶ï¼‰
          â””â”€ AssetModulesPluginï¼ˆå¤„ç†èµ„æºæ–‡ä»¶ï¼‰

      13. å®éªŒæ€§ç‰¹æ€§æ’ä»¶
          â”œâ”€ WebAssemblyModulesPluginï¼ˆWASMæ”¯æŒï¼‰
          â”œâ”€ CssModulesPluginï¼ˆCSSæ”¯æŒï¼‰
          â”œâ”€ LazyCompilationPluginï¼ˆæ‡’ç¼–è¯‘ï¼‰
          â””â”€ HttpUriPluginï¼ˆHTTPå¯¼å…¥ï¼‰

      14. EntryOptionPlugin â­â­â­
          â””â”€ å¤„ç† entry é…ç½®ï¼Œæ³¨å†Œå…¥å£æ’ä»¶

      15. RuntimePlugin â­â­â­
          â””â”€ ç®¡ç†è¿è¡Œæ—¶æ¨¡å—çš„ç”Ÿæˆ

      16. InferAsyncModulesPlugin
          â””â”€ æ¨æ–­å¼‚æ­¥æ¨¡å—

      17. åè®®æ’ä»¶
          â”œâ”€ DataUriPluginï¼ˆdata: URIï¼‰
          â””â”€ FileUriPluginï¼ˆfile: URIï¼‰

      18. ä¾èµ–å¤„ç†æ’ä»¶ï¼ˆæ ¸å¿ƒï¼‰â­â­â­
          â”œâ”€ CompatibilityPluginï¼ˆrequire, module, exportsï¼‰
          â”œâ”€ HarmonyModulesPluginï¼ˆimport/exportï¼‰
          â”œâ”€ CommonJsPluginï¼ˆrequire/module.exportsï¼‰
          â”œâ”€ AMDPluginï¼ˆdefine/require - AMDï¼‰
          â”œâ”€ LoaderPluginï¼ˆloader APIï¼‰
          â””â”€ NodeStuffPluginï¼ˆ__dirname, __filenameï¼‰

      19. API æ’ä»¶
          â”œâ”€ APIPluginï¼ˆ__webpack_public_path__ï¼‰
          â”œâ”€ ExportsInfoApiPlugin
          â”œâ”€ WebpackIsIncludedPlugin
          â”œâ”€ ConstPluginï¼ˆtypeof æ›¿æ¢ï¼‰
          â””â”€ UseStrictPlugin

      20. æ›´å¤šä¾èµ–è¯­æ³•æ’ä»¶ â­â­
          â”œâ”€ RequireIncludePlugin
          â”œâ”€ RequireEnsurePlugin
          â”œâ”€ RequireContextPluginï¼ˆrequire.contextï¼‰
          â”œâ”€ ImportPluginï¼ˆimport() - æœ€é‡è¦ï¼‰
          â”œâ”€ ImportMetaContextPlugin
          â”œâ”€ SystemPlugin
          â”œâ”€ ImportMetaPluginï¼ˆimport.metaï¼‰
          â”œâ”€ URLPluginï¼ˆnew URLï¼‰
          â””â”€ WorkerPluginï¼ˆnew Workerï¼‰

      21. ç»Ÿè®¡æ’ä»¶ â­
          â”œâ”€ DefaultStatsFactoryPlugin
          â”œâ”€ DefaultStatsPresetPlugin
          â””â”€ DefaultStatsPrinterPlugin

      22. JavascriptMetaInfoPlugin

      23. WarnNoModeSetPluginï¼ˆå¦‚æœæœªè®¾ç½® modeï¼‰

      24. ä¼˜åŒ–æ’ä»¶ï¼ˆæ ¹æ® optimization é…ç½®ï¼‰â­â­â­
          â”œâ”€ EnsureChunkConditionsPlugin
          â”œâ”€ RemoveParentModulesPluginï¼ˆoptimization.removeAvailableModulesï¼‰
          â”œâ”€ RemoveEmptyChunksPluginï¼ˆoptimization.removeEmptyChunksï¼‰
          â”œâ”€ MergeDuplicateChunksPluginï¼ˆoptimization.mergeDuplicateChunksï¼‰
          â”œâ”€ FlagIncludedChunksPluginï¼ˆoptimization.flagIncludedChunksï¼‰
          â”œâ”€ SideEffectsFlagPluginï¼ˆoptimization.sideEffects - Tree Shakingï¼‰
          â”œâ”€ FlagDependencyExportsPluginï¼ˆoptimization.providedExportsï¼‰
          â”œâ”€ FlagDependencyUsagePluginï¼ˆoptimization.usedExports - Tree Shakingï¼‰
          â”œâ”€ InnerGraphPluginï¼ˆoptimization.innerGraphï¼‰
          â”œâ”€ MangleExportsPluginï¼ˆoptimization.mangleExportsï¼‰
          â”œâ”€ ModuleConcatenationPluginï¼ˆoptimization.concatenateModules - Scope Hoistingï¼‰
          â”œâ”€ SplitChunksPluginï¼ˆoptimization.splitChunks - ä»£ç åˆ†å‰²ï¼‰
          â”œâ”€ RuntimeChunkPluginï¼ˆoptimization.runtimeChunkï¼‰
          â”œâ”€ NoEmitOnErrorsPluginï¼ˆ!optimization.emitOnErrorsï¼‰
          â””â”€ RealContentHashPluginï¼ˆoptimization.realContentHashï¼‰

      25. ID ç”Ÿæˆæ’ä»¶ â­â­
          â”œâ”€ moduleIds:
          â”‚   â”œâ”€ 'natural' â†’ NaturalModuleIdsPlugin
          â”‚   â”œâ”€ 'named' â†’ NamedModuleIdsPlugin
          â”‚   â”œâ”€ 'deterministic' â†’ DeterministicModuleIdsPlugin
          â”‚   â””â”€ 'size' â†’ OccurrenceModuleIdsPlugin
          â”‚
          â””â”€ chunkIds:
              â”œâ”€ 'natural' â†’ NaturalChunkIdsPlugin
              â”œâ”€ 'named' â†’ NamedChunkIdsPlugin
              â”œâ”€ 'deterministic' â†’ DeterministicChunkIdsPlugin
              â””â”€ 'size' â†’ OccurrenceChunkIdsPlugin

      26. DefinePluginï¼ˆoptimization.nodeEnvï¼‰
          â””â”€ å®šä¹‰ process.env.NODE_ENV

      27. Minimizer æ’ä»¶ï¼ˆoptimization.minimizeï¼‰
          â””â”€ TerserPluginï¼ˆé»˜è®¤å‹ç¼©å™¨ï¼‰

      28. SizeLimitsPluginï¼ˆperformanceï¼‰
          â””â”€ æ€§èƒ½æç¤º

      29. TemplatedPathPlugin
          â””â”€ å¤„ç† [name]ã€[hash] ç­‰æ¨¡æ¿å˜é‡

      30. RecordIdsPlugin
          â””â”€ è®°å½•æ¨¡å—å’Œ chunk çš„ IDï¼ˆç”¨äº HMRï¼‰

      31. WarnCaseSensitiveModulesPlugin
          â””â”€ è­¦å‘Šå¤§å°å†™æ•æ„Ÿé—®é¢˜

      32. AddManagedPathsPlugin
          â””â”€ æ·»åŠ æ‰˜ç®¡è·¯å¾„ï¼ˆsnapshotä¼˜åŒ–ï¼‰

      33. ç¼“å­˜æ’ä»¶ â­â­
          if (cache.type === 'memory') {
            â”œâ”€ MemoryCachePlugin
            â””â”€ MemoryWithGcCachePluginï¼ˆæœ‰ä¸–ä»£é™åˆ¶ï¼‰
          }

          if (cache.type === 'filesystem') {
            â”œâ”€ AddBuildDependenciesPlugin
            â”œâ”€ MemoryCachePlugin/MemoryWithGcCachePlugin
            â””â”€ IdleFileCachePlugin + PackFileCacheStrategy
          }

      34. ResolverCachePlugin
          â””â”€ è§£æå™¨ç¼“å­˜

      35. IgnoreWarningsPluginï¼ˆignoreWarningsï¼‰

      36. é…ç½® resolverFactory çš„é’©å­
          â”œâ”€ normal resolverï¼ˆæ™®é€šæ¨¡å—è§£æï¼‰
          â”œâ”€ context resolverï¼ˆä¸Šä¸‹æ–‡æ¨¡å—è§£æï¼‰
          â””â”€ loader resolverï¼ˆloader è§£æï¼‰

      37. è§¦å‘ afterPlugins é’©å­

      38. è§¦å‘ afterResolvers é’©å­
  â†“
æ­¥éª¤2.9: è§¦å‘åˆå§‹åŒ–é’©å­
  â”œâ”€ compiler.hooks.initialize.call()
  â””â”€ é€šçŸ¥æ’ä»¶ï¼šåˆå§‹åŒ–å·²å®Œæˆ
  â†“
æ­¥éª¤2.10: è¿”å› compiler
  â””â”€ return compiler

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
é˜¶æ®µ3: webpack() ä¸»å‡½æ•°çš„åç»­å¤„ç†
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

å›åˆ° webpack() ä¸»å‡½æ•°ï¼Œæ‹¿åˆ° create() çš„è¿”å›å€¼
  â†“
åˆ†æ”¯åˆ¤æ–­: æœ‰æ—  callback? â­â­â­
  â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æœ‰ callbackï¼ˆå¼‚æ­¥è°ƒç”¨ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                      â”‚
  â”‚  if (watch) {                                       â”‚
  â”‚    compiler.watch(watchOptions, callback);          â”‚
  â”‚    // watch æ¨¡å¼ï¼ŒæŒç»­ç›‘å¬                          â”‚
  â”‚  } else {                                           â”‚
  â”‚    compiler.run((err, stats) => {                   â”‚
  â”‚      // å•æ¬¡ç¼–è¯‘                                    â”‚
  â”‚      compiler.close(err2 => {                       â”‚
  â”‚        callback(err || err2, stats);  // â­ è‡ªåŠ¨close â”‚
  â”‚      });                                            â”‚
  â”‚    });                                              â”‚
  â”‚  }                                                  â”‚
  â”‚  return compiler;                                   â”‚
  â”‚                                                      â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ—  callbackï¼ˆåŒæ­¥è°ƒç”¨ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                                      â”‚
  â”‚  return compiler;  // â­ ç›´æ¥è¿”å›ï¼Œç”¨æˆ·æ‰‹åŠ¨æ§åˆ¶      â”‚
  â”‚                                                      â”‚
  â”‚  // ç”¨æˆ·éœ€è¦:                                       â”‚
  â”‚  const compiler = webpack(config);                  â”‚
  â”‚  compiler.run(callback);  // æ‰‹åŠ¨è°ƒç”¨               â”‚
  â”‚  compiler.close(() => {}); // æ‰‹åŠ¨å…³é—­              â”‚
  â”‚                                                      â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
åˆå§‹åŒ–é˜¶æ®µå®Œæˆï¼
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

æ­¤æ—¶ compiler çš„çŠ¶æ€:
âœ… é’©å­ç³»ç»Ÿå·²åˆ›å»ºï¼ˆ30+ é’©å­ï¼‰
âœ… é…ç½®å·²å®Œæ•´ï¼ˆåŒ…å«æ‰€æœ‰é»˜è®¤å€¼ï¼‰
âœ… æ–‡ä»¶ç³»ç»Ÿå·²æ³¨å…¥ï¼ˆå¯ä»¥è¯»å†™æ–‡ä»¶ï¼‰
âœ… ç”¨æˆ·æ’ä»¶å·²æ³¨å†Œï¼ˆé’©å­å·²ç»‘å®šï¼‰
âœ… å†…ç½®æ’ä»¶å·²æ³¨å†Œï¼ˆ40+ æ’ä»¶ï¼‰
âœ… è§£æå™¨å·²é…ç½®ï¼ˆå¯ä»¥è§£ææ¨¡å—è·¯å¾„ï¼‰
âœ… ç¼“å­˜ç³»ç»Ÿå·²åˆå§‹åŒ–
â¸ï¸ è¿˜æœªå¼€å§‹ç¼–è¯‘ï¼ˆç­‰å¾… run() æˆ– watch() è°ƒç”¨ï¼‰
```

---

## ğŸ¯ Graph æµç¨‹å›¾ç‰ˆæœ¬

```mermaid
graph TD
    Start([ç”¨æˆ·æ‰§è¡Œ: webpack]) --> CLI{é€šè¿‡å‘½ä»¤è¡Œ?}

    CLI -->|æ˜¯| BinCheck[bin/webpack.js<br/>æ£€æŸ¥ webpack-cli]
    BinCheck --> LoadCLI[åŠ è½½ webpack-cli]
    LoadCLI --> ParseArgs[è§£æå‘½ä»¤è¡Œå‚æ•°]
    ParseArgs --> CallAPI[è°ƒç”¨ webpack API]

    CLI -->|å¦| CallAPI
    CallAPI --> WebpackFunc["webpack(options, callback?)"]

    WebpackFunc --> CreateFunc[æ‰§è¡Œå†…éƒ¨ create å‡½æ•°]

    CreateFunc --> Validate[æ­¥éª¤1: é…ç½®éªŒè¯<br/>ä¸¤é˜¶æ®µç­–ç•¥ â­]

    Validate --> Fast[ç¬¬1é˜¶æ®µ: å¿«é€Ÿæ£€æŸ¥<br/>webpackOptionsSchemaCheck]
    Fast --> FastOK{é€šè¿‡?}
    FastOK -->|å¦| Full[ç¬¬2é˜¶æ®µ: è¯¦ç»†æ£€æŸ¥<br/>ajv + å®Œæ•´ schema]
    Full --> FullOK{é€šè¿‡?}
    FullOK -->|å¦| Error[æŠ›å‡ºè¯¦ç»†é”™è¯¯]
    FullOK -->|æ˜¯| TypeCheck
    FastOK -->|æ˜¯| TypeCheck

    TypeCheck{é…ç½®ç±»å‹?} -->|Array| Multi[åˆ›å»º MultiCompiler]
    TypeCheck -->|Object| Single[åˆ›å»º Compiler â­â­â­]

    Multi --> LoopCreate[éå†é…ç½®æ•°ç»„]
    LoopCreate --> CreateEach[ä¸ºæ¯ä¸ªè°ƒç”¨<br/>createCompiler]
    CreateEach --> WrapMulti[åŒ…è£…ä¸º MultiCompiler]
    WrapMulti --> ReturnC

    Single --> CreateComp[createCompiler<br/>æ ¸å¿ƒå‡½æ•°]

    CreateComp --> S1[æ­¥éª¤1: è§„èŒƒåŒ–é…ç½®<br/>getNormalizedWebpackOptions]
    S1 --> S2[æ­¥éª¤2: åº”ç”¨åŸºç¡€é»˜è®¤å€¼<br/>applyWebpackOptionsBaseDefaults]
    S2 --> S3[æ­¥éª¤3: åˆ›å»º Compiler<br/>new Compiler context options]

    S3 --> CompCtor["Compiler æ„é€ å‡½æ•°æ‰§è¡Œ:<br/>â”œâ”€ åˆå§‹åŒ– 30+ hooks<br/>â”œâ”€ ä¿å­˜ options<br/>â”œâ”€ åˆ›å»º cache<br/>â”œâ”€ åˆ›å»º resolverFactory<br/>â””â”€ åˆå§‹åŒ–å±æ€§"]

    CompCtor --> S4[æ­¥éª¤4: åº”ç”¨ç¯å¢ƒæ’ä»¶<br/>NodeEnvironmentPlugin â­â­]

    S4 --> InjectFS["æ³¨å…¥æ–‡ä»¶ç³»ç»Ÿ:<br/>â”œâ”€ inputFileSystem ç¼“å­˜60s<br/>â”œâ”€ outputFileSystem graceful-fs<br/>â”œâ”€ intermediateFileSystem<br/>â”œâ”€ watchFileSystem chokidar<br/>â””â”€ infrastructureLogger"]

    InjectFS --> S5[æ­¥éª¤5: æ³¨å†Œç”¨æˆ·æ’ä»¶<br/>options.plugins â­â­â­]

    S5 --> UserPlugins["éå†ç”¨æˆ·æ’ä»¶:<br/>for plugin of options.plugins<br/>  plugin.apply compiler<br/><br/>âš ï¸ åœ¨å®Œæ•´é»˜è®¤å€¼å‰æ³¨å†Œ<br/>è®©æ’ä»¶æœ‰æœºä¼šå½±å“é…ç½®"]

    UserPlugins --> S6[æ­¥éª¤6: åº”ç”¨å®Œæ•´é»˜è®¤å€¼<br/>applyWebpackOptionsDefaults â­â­â­]

    S6 --> Infer["æ™ºèƒ½æ¨æ–­é»˜è®¤å€¼:<br/>â”œâ”€ mode â†’ 20+ é…ç½®<br/>â”œâ”€ target â†’ 15+ é…ç½®<br/>â”œâ”€ experiments â†’ 10+ é…ç½®<br/>â”œâ”€ output.library â†’ é…ç½®<br/>â””â”€ å…¶ä»–..."]

    Infer --> S7[æ­¥éª¤7: è§¦å‘ç¯å¢ƒé’©å­]
    S7 --> EnvHooks["â”œâ”€ environment.call<br/>â””â”€ afterEnvironment.call"]

    EnvHooks --> S8[æ­¥éª¤8: åº”ç”¨å†…ç½®æ’ä»¶<br/>WebpackOptionsApply â­â­â­]

    S8 --> BuiltinPlugins["æ³¨å†Œ 40+ å†…ç½®æ’ä»¶:<br/>â”œâ”€ EntryOptionPlugin<br/>â”œâ”€ RuntimePlugin<br/>â”œâ”€ JavascriptModulesPlugin<br/>â”œâ”€ HarmonyModulesPlugin<br/>â”œâ”€ ImportPlugin<br/>â”œâ”€ SplitChunksPlugin<br/>â”œâ”€ TerserPlugin<br/>â””â”€ æ›´å¤š..."]

    BuiltinPlugins --> S9[æ­¥éª¤9: è§¦å‘åˆå§‹åŒ–é’©å­]
    S9 --> InitHook[initialize.call]

    InitHook --> ReturnC[è¿”å› compiler åˆ° create]

    ReturnC --> BackWebpack[è¿”å›åˆ° webpack ä¸»å‡½æ•°]

    BackWebpack --> HasCB{æœ‰ callback?}

    HasCB -->|æ˜¯| AutoRun[å¼‚æ­¥è°ƒç”¨æ¨¡å¼]
    AutoRun --> IsWatch{watch æ¨¡å¼?}
    IsWatch -->|æ˜¯| WatchMode[compiler.watch<br/>æŒç»­ç›‘å¬]
    IsWatch -->|å¦| RunOnce[compiler.run<br/>å•æ¬¡ç¼–è¯‘]
    RunOnce --> AutoClose[ç¼–è¯‘å®Œæˆ<br/>â­ è‡ªåŠ¨ compiler.close]
    AutoClose --> CallCB[è°ƒç”¨ç”¨æˆ· callback]

    HasCB -->|å¦| ReturnComp[åŒæ­¥è°ƒç”¨æ¨¡å¼<br/>ç›´æ¥è¿”å› compiler]

    WatchMode --> End([åˆå§‹åŒ–å®Œæˆ<br/>ç­‰å¾…æ–‡ä»¶å˜åŒ–])
    CallCB --> End
    ReturnComp --> End

    style Validate fill:#ffcccc
    style CreateComp fill:#ff9999
    style S5 fill:#99ccff
    style S6 fill:#ffff99
    style S8 fill:#99ff99
```

---

## ğŸ” å¤„ç†ç»†èŠ‚è¯¦è§£

### ç»†èŠ‚1: ä¸¤é˜¶æ®µéªŒè¯ç­–ç•¥çš„å®ç° â­â­â­

```javascript
/**
 * ä¸ºä»€ä¹ˆéœ€è¦ä¸¤é˜¶æ®µéªŒè¯ï¼Ÿ
 *
 * é—®é¢˜: JSON Schema éªŒè¯å¾ˆæ…¢
 * - å®Œæ•´ schema 5000+ è¡Œ
 * - ajv éªŒè¯éœ€è¦ 30-50ms
 * - æ¯æ¬¡å¯åŠ¨éƒ½è¦éªŒè¯
 * - ä¸¥é‡å½±å“å¯åŠ¨é€Ÿåº¦
 */

// è§£å†³æ–¹æ¡ˆ: é¢„ç¼–è¯‘ schema â­â­â­

// é˜¶æ®µ1: é¢„ç¼–è¯‘çš„å¿«é€Ÿæ£€æŸ¥ï¼ˆæ„å»ºæ—¶ç”Ÿæˆï¼‰
// schemas/WebpackOptions.check.jsï¼ˆ69000+ è¡Œï¼‰
module.exports = function validate(data) {
  // ç›´æ¥çš„ if åˆ¤æ–­ï¼ˆæ— éœ€è§£æ schemaï¼‰
  if (typeof data.mode !== 'undefined') {
    if (typeof data.mode !== 'string') return false;
    if (!['development', 'production', 'none'].includes(data.mode)) {
      return false;
    }
  }
  // ... 3000+ ä¸ªç›´æ¥åˆ¤æ–­
  return true;
};

// æ‰§è¡Œæ—¶é—´: ~2ms âœ…

// é˜¶æ®µ2: å®Œæ•´ schema éªŒè¯ï¼ˆè¿è¡Œæ—¶åŠ è½½ï¼‰
// åªåœ¨å¿«é€Ÿæ£€æŸ¥å¤±è´¥æ—¶æ‰§è¡Œ
const ajv = new Ajv();
const validate = ajv.compile(webpackOptionsSchema);
const valid = validate(options);

if (!valid) {
  // æä¾›è¯¦ç»†é”™è¯¯ä¿¡æ¯
  throw new WebpackOptionsValidationError(validate.errors);
}

// æ‰§è¡Œæ—¶é—´: ~50ms âŒï¼ˆä½†é”™è¯¯ä¿¡æ¯è¯¦ç»†ï¼‰

/**
 * æ•ˆæœå¯¹æ¯”:
 *
 * é…ç½®æ­£ç¡®ï¼ˆ99% çš„æƒ…å†µï¼‰:
 * - åªæ‰§è¡Œé˜¶æ®µ1: ~2ms
 * - èŠ‚çœ 48ms
 *
 * é…ç½®é”™è¯¯ï¼ˆ1% çš„æƒ…å†µï¼‰:
 * - æ‰§è¡Œé˜¶æ®µ1 + é˜¶æ®µ2: ~52ms
 * - ä½†æä¾›è¯¦ç»†é”™è¯¯ä¿¡æ¯
 */
```

### ç»†èŠ‚2: å•é…ç½® vs å¤šé…ç½®çš„å¤„ç† â­â­

```javascript
/**
 * å•é…ç½® vs å¤šé…ç½®çš„å…³é”®å·®å¼‚
 */

// åœºæ™¯1: å•é…ç½®
const config = {
  entry: './src/index.js',
  output: { path: './dist' }
};

webpack(config);
  â†“
if (Array.isArray(options)) {
  // ä¸èµ°è¿™ä¸ªåˆ†æ”¯
} else {
  compiler = createCompiler(options);  // â­ ç›´æ¥åˆ›å»º
}
  â†“
è¿”å› Compiler å®ä¾‹

// åœºæ™¯2: å¤šé…ç½®ï¼ˆå¹¶è¡Œç¼–è¯‘ï¼‰
const configs = [
  { entry: './src/app.js', output: { path: './dist/app' } },
  { entry: './src/admin.js', output: { path: './dist/admin' } }
];

webpack(configs);
  â†“
if (Array.isArray(options)) {  // â­ è¿›å…¥è¿™ä¸ªåˆ†æ”¯
  compiler = createMultiCompiler(options);
    â†“
    // å†…éƒ¨å®ç°
    const compilers = options.map(config => {
      return createCompiler(config);  // â­ ä¸ºæ¯ä¸ªé…ç½®åˆ›å»º Compiler
    });

    return new MultiCompiler(compilers);
}
  â†“
è¿”å› MultiCompiler å®ä¾‹

/**
 * MultiCompiler çš„ä½œç”¨:
 *
 * 1. ç®¡ç†å¤šä¸ª Compiler
 * 2. æ”¯æŒå¹¶è¡Œç¼–è¯‘
 * 3. å¤„ç†é…ç½®é—´ä¾èµ–å…³ç³»
 *
 * ä¾‹å¦‚:
 * compiler.run() â†’ æ‰€æœ‰é…ç½®å¹¶è¡Œç¼–è¯‘
 * compiler.watch() â†’ ç›‘å¬æ‰€æœ‰é…ç½®çš„æ–‡ä»¶
 */

// åœºæ™¯3: å¤šé…ç½®ï¼ˆæœ‰ä¾èµ–å…³ç³»ï¼‰
const configs = [
  {
    name: 'dll',
    entry: './src/vendors.js',
    output: { library: 'dll_lib' }
  },
  {
    name: 'app',
    entry: './src/app.js',
    dependencies: ['dll']  // â­ ä¾èµ– dll é…ç½®
  }
];

webpack(configs);
  â†“
createMultiCompiler() ä¼šè®¾ç½®ä¾èµ–:
  multiCompiler.setDependencies(appCompiler, ['dll']);
  â†“
ç¼–è¯‘æ—¶:
  1. å…ˆç¼–è¯‘ dll é…ç½®
  2. dll å®Œæˆåå†ç¼–è¯‘ app é…ç½®
```

### ç»†èŠ‚3: ç”¨æˆ·æ’ä»¶æ³¨å†Œæ—¶æœºçš„æ·±å±‚åŸå›  â­â­â­

```javascript
/**
 * ä¸ºä»€ä¹ˆç”¨æˆ·æ’ä»¶åœ¨"åº”ç”¨å®Œæ•´é»˜è®¤å€¼"ä¹‹å‰æ³¨å†Œï¼Ÿ
 *
 * è¿™æ˜¯ä¸€ä¸ªéå¸¸å…³é”®çš„è®¾è®¡å†³ç­–ï¼
 */

// åœºæ™¯: ç”¨æˆ·æ’ä»¶æƒ³æ ¹æ®é…ç½®åšä¸åŒå¤„ç†

class MyCustomPlugin {
  apply(compiler) {
    // é—®é¢˜: æ­¤æ—¶ compiler.options çš„å¾ˆå¤šé…ç½®è¿˜æ˜¯ undefined

    // â­ è§£å†³æ–¹æ¡ˆ: ä½¿ç”¨ afterPlugins æˆ– initialize é’©å­
    compiler.hooks.afterPlugins.tap('MyPlugin', () => {
      // æ­¤æ—¶å®Œæ•´é»˜è®¤å€¼å·²åº”ç”¨
      // å¯ä»¥å®‰å…¨è®¿é—®æ‰€æœ‰é…ç½®

      if (compiler.options.optimization.minimize) {
        // åšç‰¹å®šå¤„ç†
      }
    });
  }
}

// æ‰§è¡Œé¡ºåº:
// 1. åº”ç”¨åŸºç¡€é»˜è®¤å€¼
// 2. æ³¨å†Œç”¨æˆ·æ’ä»¶ â­ MyCustomPlugin.apply()
// 3. åº”ç”¨å®Œæ•´é»˜è®¤å€¼ â­ æ­¤æ—¶ optimization.minimize æœ‰å€¼äº†
// 4. è§¦å‘ afterPlugins é’©å­ â­ MyCustomPlugin çš„å›è°ƒæ‰§è¡Œ

/**
 * ä¸ºä»€ä¹ˆä¸èƒ½å…ˆåº”ç”¨å®Œæ•´é»˜è®¤å€¼ï¼Œå†æ³¨å†Œç”¨æˆ·æ’ä»¶ï¼Ÿ
 *
 * åä¾‹:
 */
// å¦‚æœæ”¹æˆè¿™æ ·:
applyWebpackOptionsDefaults(options);  // å…ˆåº”ç”¨é»˜è®¤å€¼
for (const plugin of options.plugins) {
  plugin.apply(compiler);              // å†æ³¨å†Œæ’ä»¶
}

// é—®é¢˜: ç”¨æˆ·æ— æ³•å½±å“é»˜è®¤å€¼çš„æ¨æ–­
class MyPlugin {
  apply(compiler) {
    // æƒ³ä¿®æ”¹é…ç½®
    compiler.options.target = 'electron-renderer';

    // âŒ å¤ªæ™šäº†ï¼
    // é»˜è®¤å€¼å·²ç»æ ¹æ®æ—§çš„ target æ¨æ–­è¿‡äº†
    // ä¾‹å¦‚ output.chunkLoading å·²ç»è®¾ç½®ä¸º 'jsonp'
    // ä½† electron-renderer åº”è¯¥ç”¨å…¶ä»–æ–¹å¼
  }
}

/**
 * æ­£ç¡®çš„è®¾è®¡ï¼ˆå½“å‰ï¼‰:
 *
 * åŸºç¡€é»˜è®¤å€¼ â†’ ç”¨æˆ·æ’ä»¶ â†’ å®Œæ•´é»˜è®¤å€¼
 *              â†‘ ç”¨æˆ·å¯ä»¥ä¿®æ”¹é…ç½®
 *                         â†‘ åŸºäºæœ€ç»ˆé…ç½®æ¨æ–­
 */
```

### ç»†èŠ‚4: åŸºç¡€é»˜è®¤å€¼ vs å®Œæ•´é»˜è®¤å€¼ â­â­

```javascript
/**
 * ä¸ºä»€ä¹ˆåˆ†ä¸¤æ¬¡åº”ç”¨é»˜è®¤å€¼ï¼Ÿ
 */

// åŸºç¡€é»˜è®¤å€¼ï¼ˆapplyWebpackOptionsBaseDefaultsï¼‰
// åªè®¾ç½®åˆ›å»º Compiler å¿…éœ€çš„æœ€å°é…ç½®
{
  context: process.cwd(),           // å·¥ä½œç›®å½•ï¼ˆå¿…éœ€ï¼‰
  infrastructureLogging: {          // æ—¥å¿—é…ç½®ï¼ˆå¿…éœ€ï¼‰
    level: 'info',
    debug: false
  }
  // âš ï¸ å…¶ä»–é…ç½®æš‚ä¸è®¾ç½®
}

// å®Œæ•´é»˜è®¤å€¼ï¼ˆapplyWebpackOptionsDefaultsï¼‰
// æ ¹æ®å·²æœ‰é…ç½®æ¨æ–­æ‰€æœ‰å…¶ä»–é…ç½®
{
  // æ ¹æ® mode æ¨æ–­
  optimization: { minimize: true, ... },
  devtool: false,
  cache: false,

  // æ ¹æ® target æ¨æ–­
  output: { chunkLoading: 'jsonp', ... },
  resolve: { mainFields: ['browser', ...], ... },
  node: { global: false, ... },

  // æ ¹æ® experiments æ¨æ–­
  module: { rules: [...] },

  // ... 200+ é…ç½®é¡¹
}

/**
 * ä¸ºä»€ä¹ˆä¸ä¸€æ¬¡æ€§è®¾ç½®æ‰€æœ‰é»˜è®¤å€¼ï¼Ÿ
 *
 * åŸå› 1: ä¾èµ–å…³ç³»
 * - å®Œæ•´é»˜è®¤å€¼ä¾èµ–å…¶ä»–é…ç½®
 * - ä¾‹å¦‚: optimization.minimize ä¾èµ– mode
 * - å¦‚æœ mode è¿˜æœªç¡®å®šï¼Œæ— æ³•æ¨æ–­
 *
 * åŸå› 2: ç”¨æˆ·æ’ä»¶çš„å½±å“
 * - ç”¨æˆ·æ’ä»¶å¯èƒ½ä¿®æ”¹é…ç½®
 * - é»˜è®¤å€¼åº”è¯¥åŸºäº"æœ€ç»ˆé…ç½®"æ¨æ–­
 *
 * åŸå› 3: æ€§èƒ½
 * - åŸºç¡€é»˜è®¤å€¼å¾ˆå¿«ï¼ˆåªè®¾ç½®å‡ ä¸ªï¼‰
 * - å®Œæ•´é»˜è®¤å€¼è¾ƒæ…¢ï¼ˆéœ€è¦å¤§é‡æ¨æ–­ï¼‰
 * - åˆ†ç¦»å¯ä»¥è®© Compiler å°½æ—©åˆ›å»º
 */
```

### ç»†èŠ‚5: é…ç½®æ¨æ–­çš„çº§è”æ•ˆåº” â­â­

```javascript
/**
 * ä¸€ä¸ªé…ç½®å¦‚ä½•å½±å“å¤šä¸ªé»˜è®¤å€¼
 *
 * ç¤ºä¾‹: mode = 'production'
 */

// ç”¨æˆ·é…ç½®
module.exports = {
  mode: 'production'  // â­ åªè®¾ç½®äº†è¿™ä¸€ä¸ª
};

// webpack æ¨æ–­çš„é»˜è®¤å€¼ï¼ˆ20+ ä¸ªï¼‰:

// 1. ç›´æ¥æ¨æ–­ï¼ˆä¸€çº§å½±å“ï¼‰
{
  optimization: {
    minimize: true,              // â† mode === 'production'
    moduleIds: 'deterministic',  // â† mode === 'production'
    chunkIds: 'deterministic',   // â† mode === 'production'
    usedExports: true,           // â† mode === 'production'ï¼ˆTree Shakingï¼‰
    concatenateModules: true,    // â† mode === 'production'ï¼ˆScope Hoistingï¼‰
    sideEffects: true,           // â† mode === 'production'
    innerGraph: true,            // â† mode === 'production'
    mangleExports: true,         // â† mode === 'production'
    realContentHash: true,       // â† mode === 'production'
    nodeEnv: 'production'        // â† mode å€¼
  },

  devtool: false,                // â† mode === 'production'
  cache: false,                  // â† mode === 'production'

  performance: {
    hints: 'warning'             // â† mode === 'production'
  }
}

// 2. é—´æ¥æ¨æ–­ï¼ˆäºŒçº§å½±å“ï¼‰
{
  optimization: {
    minimizer: [
      TerserPlugin  // â† minimize === true â† mode === 'production'
    ]
  },

  plugins: [
    // è¿™äº›æ’ä»¶æ ¹æ® optimization é…ç½®æ³¨å†Œ
    SideEffectsFlagPlugin,       // â† sideEffects === true
    FlagDependencyExportsPlugin, // â† providedExports === true
    FlagDependencyUsagePlugin,   // â† usedExports === true
    ModuleConcatenationPlugin,   // â† concatenateModules === true
    // ...
  ]
}

/**
 * çº§è”æ¨æ–­ç¤ºæ„å›¾:
 *
 * mode: 'production'
 *   â†“
 * optimization.minimize: true
 *   â†“
 * optimization.minimizer: [TerserPlugin]
 *   â†“
 * WebpackOptionsApply æ³¨å†Œ TerserPlugin
 *   â†“
 * Seal é˜¶æ®µæ‰§è¡Œå‹ç¼©
 */
```

### ç»†èŠ‚6: å†…ç½®æ’ä»¶æ³¨å†Œçš„æ¡ä»¶é€»è¾‘ â­â­

```javascript
/**
 * WebpackOptionsApply å¦‚ä½•å†³å®šæ³¨å†Œå“ªäº›æ’ä»¶ï¼Ÿ
 *
 * ç­–ç•¥: æŒ‰éœ€æ³¨å†Œ
 */

// ç¤ºä¾‹1: optimization.splitChunks
if (options.optimization.splitChunks) {
  // â­ åªæœ‰å¯ç”¨æ—¶æ‰æ³¨å†Œ
  new SplitChunksPlugin(options.optimization.splitChunks).apply(compiler);
}

// å¦‚æœç”¨æˆ·é…ç½®:
{
  optimization: {
    splitChunks: false  // ç¦ç”¨ä»£ç åˆ†å‰²
  }
}
// â†’ SplitChunksPlugin ä¸ä¼šæ³¨å†Œ â†’ èŠ‚çœå†…å­˜å’Œæ€§èƒ½

// ç¤ºä¾‹2: devtool
if (options.devtool) {
  // â­ æ ¹æ® devtool çš„å€¼æ³¨å†Œä¸åŒçš„æ’ä»¶
  if (options.devtool.includes('source-map')) {
    new SourceMapDevToolPlugin(...).apply(compiler);
  } else if (options.devtool.includes('eval')) {
    new EvalDevToolModulePlugin(...).apply(compiler);
  }
}

// å¦‚æœç”¨æˆ·é…ç½®:
{
  devtool: false  // ä¸ç”Ÿæˆ SourceMap
}
// â†’ SourceMap æ’ä»¶ä¸ä¼šæ³¨å†Œ â†’ ç¼–è¯‘æ›´å¿«

/**
 * æŒ‰éœ€æ³¨å†Œçš„ä¼˜åŠ¿:
 *
 * 1. æ€§èƒ½: åªæ³¨å†Œéœ€è¦çš„æ’ä»¶
 * 2. å†…å­˜: å‡å°‘å¯¹è±¡åˆ›å»º
 * 3. çµæ´»: ç”¨æˆ·å¯ä»¥å®Œå…¨æ§åˆ¶
 */
```

### ç»†èŠ‚7: é’©å­çš„è§¦å‘æ—¶æœºå’Œä½œç”¨ â­â­

```javascript
/**
 * åˆå§‹åŒ–é˜¶æ®µçš„ 4 ä¸ªé’©å­
 */

// é’©å­1: environmentï¼ˆæœ€æ—©ï¼‰
compiler.hooks.environment.call();

/**
 * æ—¶æœº: NodeEnvironmentPlugin ä¹‹åï¼Œç”¨æˆ·æ’ä»¶æ³¨å†Œä¹‹å‰
 *
 * ç”¨é€”:
 * - å‡†å¤‡ç¼–è¯‘ç¯å¢ƒ
 * - è®¾ç½®å…¨å±€çŠ¶æ€
 * - å¾ˆå°‘ä½¿ç”¨ï¼ˆå› ä¸ºå¤ªæ—©äº†ï¼Œé…ç½®è¿˜ä¸å®Œæ•´ï¼‰
 */

// é’©å­2: afterEnvironment
compiler.hooks.afterEnvironment.call();

/**
 * æ—¶æœº: environment ä¹‹åï¼Œç”¨æˆ·æ’ä»¶æ³¨å†Œä¹‹å
 *
 * ç”¨é€”:
 * - ç¯å¢ƒå‡†å¤‡å®Œæˆçš„é€šçŸ¥
 * - å¯ä»¥è®¿é—®éƒ¨åˆ†é…ç½®
 * - è¾ƒå°‘ä½¿ç”¨
 */

// é’©å­3: afterPluginsï¼ˆåœ¨ WebpackOptionsApply æœ«å°¾ï¼‰
compiler.hooks.afterPlugins.call(compiler);

/**
 * æ—¶æœº: æ‰€æœ‰æ’ä»¶ï¼ˆç”¨æˆ·+å†…ç½®ï¼‰æ³¨å†Œå®Œæˆå
 *
 * ç”¨é€”:
 * - æ’ä»¶å¯ä»¥åœ¨è¿™é‡Œè®¿é—®å®Œæ•´é…ç½®
 * - å¯ä»¥åŸºäºé…ç½®åšæœ€åçš„è°ƒæ•´
 *
 * ç¤ºä¾‹:
 * compiler.hooks.afterPlugins.tap('MyPlugin', (compiler) => {
 *   // ç°åœ¨å¯ä»¥å®‰å…¨è®¿é—®æ‰€æœ‰é…ç½®äº†
 *   if (compiler.options.optimization.minimize) {
 *     // åšç‰¹å®šå¤„ç†
 *   }
 * });
 */

// é’©å­4: initializeï¼ˆæœ€æ™šï¼‰â­
compiler.hooks.initialize.call();

/**
 * æ—¶æœº: åˆå§‹åŒ–æµç¨‹çš„æœ€å
 *
 * ç”¨é€”:
 * - åˆå§‹åŒ–å®Œæˆçš„é€šçŸ¥
 * - æ’ä»¶åšæœ€åçš„å‡†å¤‡å·¥ä½œ
 * - å¾ˆå¸¸ç”¨
 *
 * æ­¤æ—¶ compiler çš„çŠ¶æ€:
 * âœ… æ‰€æœ‰é…ç½®å·²å®Œæ•´
 * âœ… æ‰€æœ‰æ’ä»¶å·²æ³¨å†Œ
 * âœ… æ–‡ä»¶ç³»ç»Ÿå·²æ³¨å…¥
 * âœ… è§£æå™¨å·²é…ç½®
 * â¸ï¸ ç­‰å¾… run() æˆ– watch() è°ƒç”¨
 */
```

### ç»†èŠ‚8: ç¼“å­˜ç³»ç»Ÿçš„åˆå§‹åŒ– â­â­

```javascript
/**
 * ç¼“å­˜æ’ä»¶çš„æ³¨å†Œé€»è¾‘ï¼ˆåœ¨ WebpackOptionsApply ä¸­ï¼‰
 */

if (options.cache && typeof options.cache === 'object') {
  const cacheOptions = options.cache;

  switch (cacheOptions.type) {
    case 'memory':
      // å†…å­˜ç¼“å­˜ï¼ˆå¿«é€Ÿï¼Œä½†è¿›ç¨‹é€€å‡ºåä¸¢å¤±ï¼‰

      if (isFinite(cacheOptions.maxGenerations)) {
        // æœ‰ä¸–ä»£é™åˆ¶çš„å†…å­˜ç¼“å­˜ï¼ˆå®šæœŸæ¸…ç†ï¼‰
        new MemoryWithGcCachePlugin({
          maxGenerations: cacheOptions.maxGenerations
        }).apply(compiler);
      } else {
        // æ— é™åˆ¶çš„å†…å­˜ç¼“å­˜
        new MemoryCachePlugin().apply(compiler);
      }
      break;

    case 'filesystem':
      // æ–‡ä»¶ç³»ç»Ÿç¼“å­˜ï¼ˆæŒä¹…åŒ–ï¼Œè·¨è¿›ç¨‹å…±äº«ï¼‰

      // 1. æ·»åŠ æ„å»ºä¾èµ–ï¼ˆwebpack.config.jsç­‰ï¼‰
      new AddBuildDependenciesPlugin(
        cacheOptions.buildDependencies
      ).apply(compiler);

      // 2. å†…å­˜ç¼“å­˜å±‚ï¼ˆL1 ç¼“å­˜ï¼‰
      new MemoryCachePlugin().apply(compiler);

      // 3. æ–‡ä»¶ç³»ç»Ÿç¼“å­˜å±‚ï¼ˆL2 ç¼“å­˜ï¼‰
      new IdleFileCachePlugin(
        new PackFileCacheStrategy({
          // ç¼“å­˜æ–‡ä»¶è·¯å¾„: node_modules/.cache/webpack/
          cacheLocation: cacheOptions.cacheLocation,
          version: cacheOptions.version,
          // ... æ›´å¤šé…ç½®
        })
      ).apply(compiler);

      break;
  }
}

/**
 * ä¸¤çº§ç¼“å­˜ç­–ç•¥:
 *
 * L1 (å†…å­˜):
 * - é€Ÿåº¦: æå¿«ï¼ˆ<1msï¼‰
 * - å®¹é‡: æœ‰é™ï¼ˆå‡ ç™¾MBï¼‰
 * - ç”Ÿå‘½å‘¨æœŸ: è¿›ç¨‹çº§åˆ«
 *
 * L2 (æ–‡ä»¶ç³»ç»Ÿ):
 * - é€Ÿåº¦: è¾ƒå¿«ï¼ˆ~10msï¼‰
 * - å®¹é‡: å¤§ï¼ˆå‡ GBï¼‰
 * - ç”Ÿå‘½å‘¨æœŸ: è·¨è¿›ç¨‹
 *
 * æŸ¥æ‰¾æµç¨‹:
 * 1. å…ˆæŸ¥ L1ï¼Œå‘½ä¸­ç‡ 80%
 * 2. L1 æœªå‘½ä¸­æŸ¥ L2ï¼Œå‘½ä¸­ç‡ 15%
 * 3. L2 ä¹Ÿæœªå‘½ä¸­ï¼Œé‡æ–°æ„å»ºï¼Œ5%
 */
```

### ç»†èŠ‚9: è§£æå™¨çš„é…ç½® â­

```javascript
/**
 * è§£æå™¨é…ç½®ï¼ˆåœ¨ WebpackOptionsApply æœ«å°¾ï¼‰
 */

// ä¸º 3 ç§è§£æå™¨é…ç½®é’©å­:

// 1. normal resolverï¼ˆæ™®é€šæ¨¡å—è§£æï¼‰
compiler.resolverFactory.hooks.resolveOptions
  .for('normal')
  .tap('WebpackOptionsApply', resolveOptions => {
    // åˆå¹¶ç”¨æˆ·çš„ resolve é…ç½®
    resolveOptions = cleverMerge(options.resolve, resolveOptions);

    // æ³¨å…¥æ–‡ä»¶ç³»ç»Ÿ
    resolveOptions.fileSystem = compiler.inputFileSystem;

    return resolveOptions;
  });

// 2. context resolverï¼ˆä¸Šä¸‹æ–‡æ¨¡å—è§£æï¼‰
compiler.resolverFactory.hooks.resolveOptions
  .for('context')
  .tap('WebpackOptionsApply', resolveOptions => {
    resolveOptions = cleverMerge(options.resolve, resolveOptions);
    resolveOptions.fileSystem = compiler.inputFileSystem;
    resolveOptions.resolveToContext = true;  // â­ è§£æä¸ºç›®å½•
    return resolveOptions;
  });

// 3. loader resolverï¼ˆloader è§£æï¼‰
compiler.resolverFactory.hooks.resolveOptions
  .for('loader')
  .tap('WebpackOptionsApply', resolveOptions => {
    resolveOptions = cleverMerge(options.resolveLoader, resolveOptions);
    resolveOptions.fileSystem = compiler.inputFileSystem;
    return resolveOptions;
  });

/**
 * ä¸‰ç§è§£æå™¨çš„åŒºåˆ«:
 *
 * normal: è§£ææ™®é€šæ¨¡å—
 * - import './app.js' â†’ /path/to/app.js
 * - ä½¿ç”¨ resolve é…ç½®
 *
 * context: è§£æç›®å½•
 * - require.context('./locales') â†’ /path/to/locales/
 * - resolveToContext: true
 *
 * loader: è§£æ loader
 * - use: ['babel-loader'] â†’ /node_modules/babel-loader/...
 * - ä½¿ç”¨ resolveLoader é…ç½®
 */
```

---

## ğŸ’¡ æºç ä¸­ä¸æ˜“å‘ç°çš„çŸ¥è¯†ç‚¹

### çŸ¥è¯†ç‚¹1: process.nextTick çš„å·§å¦™ä½¿ç”¨ â­â­

```javascript
/**
 * lib/webpack.js ä¸­çš„é”™è¯¯å¤„ç†
 */
if (callback) {
  try {
    const { compiler } = create();
    compiler.run(callback);
  } catch (err) {
    // â­ ä½¿ç”¨ nextTick å¼‚æ­¥ä¼ é€’é”™è¯¯
    process.nextTick(() => callback(err));
    return null;
  }
}

/**
 * ä¸ºä»€ä¹ˆç”¨ nextTickï¼Ÿ
 *
 * é—®é¢˜åœºæ™¯:
 */
webpack(invalidConfig, (err, stats) => {
  // ç”¨æˆ·æœŸæœ›è¿™é‡Œå¤„ç†é”™è¯¯
});

// å¦‚æœç›´æ¥åŒæ­¥è°ƒç”¨:
catch (err) {
  callback(err);  // âŒ åŒæ­¥è°ƒç”¨
}

// é—®é¢˜:
// - callback å¯èƒ½è¿˜åœ¨è®¾ç½®ä¸­
// - å¼‚å¸¸æ ˆå¯èƒ½ä¸æ­£ç¡®
// - ä¸å¼‚æ­¥æ¨¡å¼ä¸ä¸€è‡´

// ä½¿ç”¨ nextTick:
catch (err) {
  process.nextTick(() => callback(err));  // âœ… å¼‚æ­¥è°ƒç”¨
}

// å¥½å¤„:
// - é”™è¯¯å¤„ç†ç»Ÿä¸€ä¸ºå¼‚æ­¥
// - ç»™ç”¨æˆ·æœºä¼šå®ŒæˆåŒæ­¥è®¾ç½®
// - å¼‚å¸¸æ ˆæ›´æ¸…æ™°
```

### çŸ¥è¯†ç‚¹2: MultiCompiler çš„ä¾èµ–å¤„ç† â­

```javascript
/**
 * å¤šé…ç½®çš„ä¾èµ–å…³ç³»
 */

// å…¸å‹åœºæ™¯: DLL + App
const configs = [
  {
    name: 'dll',
    entry: './src/vendors.js',
    plugins: [
      new webpack.DllPlugin({ ... })
    ]
  },
  {
    name: 'app',
    entry: './src/app.js',
    dependencies: ['dll'],  // â­ å£°æ˜ä¾èµ–
    plugins: [
      new webpack.DllReferencePlugin({ ... })
    ]
  }
];

// MultiCompiler çš„å¤„ç†:
for (const childCompiler of compilers) {
  if (childCompiler.options.dependencies) {
    multiCompiler.setDependencies(
      childCompiler,
      childCompiler.options.dependencies
    );
  }
}

// ç¼–è¯‘æ—¶:
multiCompiler.run((err, multiStats) => {
  // 1. å…ˆç¼–è¯‘ dllï¼ˆæ— ä¾èµ–ï¼‰
  // 2. dll å®Œæˆåç¼–è¯‘ appï¼ˆä¾èµ– dllï¼‰
  // 3. ä¿è¯ä¾èµ–é¡ºåºæ­£ç¡®
});

/**
 * æ²¡æœ‰ä¾èµ–æ—¶:
 * - æ‰€æœ‰é…ç½®å¹¶è¡Œç¼–è¯‘
 * - å……åˆ†åˆ©ç”¨å¤šæ ¸
 */
```

### çŸ¥è¯†ç‚¹3: watch æ¨¡å¼çš„è­¦å‘Š â­

```javascript
/**
 * ä¸ºä»€ä¹ˆ watch æ¨¡å¼å¿…é¡»æä¾› callbackï¼Ÿ
 */

// é”™è¯¯ç”¨æ³•:
const compiler = webpack({
  watch: true  // â­ å¯ç”¨ watch
});
// âŒ æ²¡æœ‰æä¾› callback

// webpack ä¼šå‘å‡ºè­¦å‘Š:
"A 'callback' argument needs to be provided when 'watch' option is set."

/**
 * åŸå› :
 *
 * watch æ¨¡å¼çš„ç‰¹ç‚¹:
 * - æŒç»­è¿è¡Œï¼Œä¸ä¼šè‡ªåŠ¨åœæ­¢
 * - æ¯æ¬¡æ–‡ä»¶å˜åŒ–éƒ½è§¦å‘ç¼–è¯‘
 * - éœ€è¦ callback å¤„ç†æ¯æ¬¡ç¼–è¯‘ç»“æœ
 *
 * å¦‚æœæ²¡æœ‰ callback:
 * - ç”¨æˆ·æ— æ³•çŸ¥é“ä½•æ—¶ç¼–è¯‘å®Œæˆ
 * - æ— æ³•å¤„ç†ç¼–è¯‘ç»“æœ
 * - æ— æ³•å¤„ç†é”™è¯¯
 *
 * æ­£ç¡®ç”¨æ³•:
 * const compiler = webpack(config);
 *
 * const watching = compiler.watch({}, (err, stats) => {
 *   // å¤„ç†æ¯æ¬¡ç¼–è¯‘ç»“æœ
 * });
 */
```

### çŸ¥è¯†ç‚¹4: cleverMerge çš„æ™ºèƒ½åˆå¹¶ â­

```javascript
/**
 * cleverMerge ä¸æ˜¯ç®€å•çš„ Object.assign
 */

// åœºæ™¯: åˆå¹¶ resolve é…ç½®
const defaultResolve = {
  extensions: ['.js', '.json'],
  mainFields: ['module', 'main']
};

const userResolve = {
  extensions: ['.ts', '.tsx'],
  alias: { '@': '/src' }
};

// æ™®é€š merge:
Object.assign({}, defaultResolve, userResolve);
// ç»“æœ: extensions è¢«å®Œå…¨è¦†ç›–
{
  extensions: ['.ts', '.tsx'],  // âŒ ä¸¢å¤±äº† .js, .json
  mainFields: ['module', 'main'],
  alias: { '@': '/src' }
}

// cleverMerge:
cleverMerge(defaultResolve, userResolve);
// ç»“æœ: extensions æ™ºèƒ½åˆå¹¶
{
  extensions: ['.ts', '.tsx', '.js', '.json'],  // âœ… ä¿ç•™äº†é»˜è®¤å€¼
  mainFields: ['module', 'main'],
  alias: { '@': '/src' }
}

/**
 * cleverMerge çš„è§„åˆ™:
 *
 * 1. æ•°ç»„: åˆå¹¶å»é‡
 * 2. å¯¹è±¡: é€’å½’åˆå¹¶
 * 3. åŸå§‹å€¼: è¦†ç›–
 * 4. undefined: ä¿ç•™é»˜è®¤å€¼
 */
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### æ³¨æ„äº‹é¡¹1: é…ç½®éªŒè¯çš„æ€§èƒ½å½±å“

```
é¦–æ¬¡å¯åŠ¨ï¼ˆé…ç½®æ­£ç¡®ï¼‰:
  â”œâ”€ å¿«é€Ÿæ£€æŸ¥: 2ms
  â””â”€ æ€»è€—æ—¶: 2ms

é¦–æ¬¡å¯åŠ¨ï¼ˆé…ç½®é”™è¯¯ï¼‰:
  â”œâ”€ å¿«é€Ÿæ£€æŸ¥: 2ms
  â”œâ”€ è¯¦ç»†æ£€æŸ¥: 50ms
  â””â”€ æ€»è€—æ—¶: 52ms

å»ºè®®:
- å¼€å‘æ—¶ç¡®ä¿é…ç½®æ­£ç¡®
- ä½¿ç”¨ TypeScript é…ç½®ï¼ˆç¼–è¾‘å™¨æç¤ºï¼‰
```

### æ³¨æ„äº‹é¡¹2: æ’ä»¶æ³¨å†Œé¡ºåºå¾ˆé‡è¦

```
ç”¨æˆ·æ’ä»¶ â†’ å†…ç½®æ’ä»¶

å¦‚æœåè¿‡æ¥:
- ç”¨æˆ·æ’ä»¶å¯èƒ½è¦†ç›–å†…ç½®æ’ä»¶çš„è¡Œä¸º
- æŸäº›åŠŸèƒ½å¯èƒ½ä¸work

å½“å‰é¡ºåº:
- å†…ç½®æ’ä»¶æä¾›åŸºç¡€åŠŸèƒ½
- ç”¨æˆ·æ’ä»¶å¯ä»¥å¢å¼ºæˆ–ä¿®æ”¹
```

### æ³¨æ„äº‹é¡¹3: å¤šé…ç½®çš„å†…å­˜å ç”¨

```
å•é…ç½®: 1 ä¸ª Compiler
  å†…å­˜: ~50MB

å¤šé…ç½®: n ä¸ª Compiler
  å†…å­˜: ~50MB Ã— n

å»ºè®®:
- é¿å…è¿‡å¤šé…ç½®ï¼ˆ>5ä¸ªï¼‰
- è€ƒè™‘ä½¿ç”¨å•é…ç½® + æ¡ä»¶åˆ¤æ–­
```

---

**è¿™æ˜¯åŸºäºæºç çš„æœ€å‡†ç¡®çš„åˆå§‹åŒ–æµç¨‹ï¼** ğŸ¯

å…³é”®ç‚¹ï¼š
1. âœ… éªŒè¯åœ¨ create() å‡½æ•°æœ€å¼€å§‹
2. âœ… ç„¶ååˆ¤æ–­å•/å¤šé…ç½®
3. âœ… ç”¨æˆ·æ’ä»¶åœ¨å®Œæ•´é»˜è®¤å€¼ä¹‹å‰æ³¨å†Œ
4. âœ… å†…ç½®æ’ä»¶æ ¹æ®é…ç½®æŒ‰éœ€æ³¨å†Œ