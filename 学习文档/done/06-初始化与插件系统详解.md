# Webpack åˆå§‹åŒ–ä¸æ’ä»¶ç³»ç»Ÿè¯¦è§£

> å¼€å§‹ç¼–è¯‘é˜¶æ®µçš„å®Œæ•´å®ç°åŸç†

## ğŸ“‹ ç›®å½•

1. [æµç¨‹ä¿®æ­£](#ä¸€æµç¨‹ä¿®æ­£)
2. [æ¶‰åŠçš„æºç æ–‡ä»¶](#äºŒæ¶‰åŠçš„æºç æ–‡ä»¶)
3. [åˆå§‹åŒ–è¯¦ç»†æµç¨‹](#ä¸‰åˆå§‹åŒ–è¯¦ç»†æµç¨‹)
4. [æ’ä»¶å·¥ä½œåŸç†](#å››æ’ä»¶å·¥ä½œåŸç†)
5. [æ’ä»¶åŠŸèƒ½åˆ†ç±»](#äº”æ’ä»¶åŠŸèƒ½åˆ†ç±»)
6. [å®ç°ç»†èŠ‚ä¸æ³¨æ„äº‹é¡¹](#å…­å®ç°ç»†èŠ‚ä¸æ³¨æ„äº‹é¡¹)
7. [æ¨¡å—å…³ç³»å›¾](#ä¸ƒæ¨¡å—å…³ç³»å›¾)

---

## ä¸€ã€æµç¨‹ä¿®æ­£

ä½ çš„æ€»ç»“åŸºæœ¬æ­£ç¡®ï¼è®©æˆ‘åšä¸€äº›ç»†èŠ‚ä¿®æ­£å’Œè¡¥å……ï¼š

### ä¿®æ­£åçš„å®Œæ•´æµç¨‹

#### 1. åˆå§‹åŒ–å‚æ•°ï¼ˆâœ… æ­£ç¡®ï¼‰
```javascript
// è§£æé…ç½®æ–‡ä»¶å’Œå‘½ä»¤è¡Œå‚æ•°
const config = require('./webpack.config.js');
const webpack = require('webpack');

// åˆå¹¶é…ç½®
const finalConfig = mergeConfig(config, commandLineArgs);
```

**æ–‡ä»¶**ï¼š`lib/webpack.js`

---

#### 2. åˆ›å»º Compilerï¼ˆâœ… åŸºæœ¬æ­£ç¡®ï¼Œè¡¥å……ç»†èŠ‚ï¼‰

**ä½ çš„æè¿°**ï¼š
> ç”¨ä¸Šä¸€æ­¥å¾—åˆ°çš„å‚æ•°åˆå§‹åŒ– Compiler å¯¹è±¡ï¼ŒåŠ è½½æ‰€æœ‰é…ç½®çš„æ’ä»¶

**æ›´å‡†ç¡®çš„æè¿°**ï¼š
```
åˆ›å»º Compiler é˜¶æ®µï¼ˆlib/webpack.js: createCompilerï¼‰ï¼š

æ­¥éª¤1: è§„èŒƒåŒ–é…ç½®
  getNormalizedWebpackOptions(rawOptions)

æ­¥éª¤2: åº”ç”¨åŸºç¡€é»˜è®¤å€¼
  applyWebpackOptionsBaseDefaults(options)

æ­¥éª¤3: åˆ›å»º Compiler å®ä¾‹
  compiler = new Compiler(context, options)

æ­¥éª¤4: åº”ç”¨ Node ç¯å¢ƒæ’ä»¶
  new NodeEnvironmentPlugin().apply(compiler)
  â† æ³¨å…¥æ–‡ä»¶ç³»ç»Ÿèƒ½åŠ›

æ­¥éª¤5: æ³¨å†Œç”¨æˆ·æ’ä»¶ â­â­â­
  for (const plugin of options.plugins) {
    plugin.apply(compiler)
  }
  â† æ’ä»¶åœ¨è¿™é‡Œæ³¨å†Œé’©å­

æ­¥éª¤6: åº”ç”¨å®Œæ•´é»˜è®¤å€¼
  applyWebpackOptionsDefaults(options)

æ­¥éª¤7: è§¦å‘ç¯å¢ƒé’©å­
  compiler.hooks.environment.call()
  compiler.hooks.afterEnvironment.call()

æ­¥éª¤8: åº”ç”¨å†…ç½®æ’ä»¶ â­â­â­
  new WebpackOptionsApply().process(options, compiler)
  â† æ ¹æ®é…ç½®æ³¨å†Œå†…ç½®æ’ä»¶

æ­¥éª¤9: è§¦å‘åˆå§‹åŒ–å®Œæˆ
  compiler.hooks.initialize.call()
```

**æ¶‰åŠæ–‡ä»¶**ï¼š
- `lib/webpack.js`ï¼ˆä¸»æµç¨‹ï¼‰
- `lib/Compiler.js`ï¼ˆCompiler ç±»ï¼‰
- `lib/WebpackOptionsApply.js`ï¼ˆå†…ç½®æ’ä»¶æ³¨å†Œï¼‰
- `lib/node/NodeEnvironmentPlugin.js`ï¼ˆç¯å¢ƒæ’ä»¶ï¼‰

---

#### 3. ç¡®å®šå…¥å£ï¼ˆâš ï¸ éœ€è¦ç»†åŒ–ï¼‰

**ä½ çš„æè¿°**ï¼š
> æ ¹æ®é…ç½®ä¸­çš„ entry æ‰¾å‡ºæ‰€æœ‰çš„å…¥å£æ–‡ä»¶

**æ›´å‡†ç¡®çš„æè¿°**ï¼š
```
ç¡®å®šå…¥å£åœ¨ä¸¤ä¸ªé˜¶æ®µå‘ç”Ÿï¼š

é˜¶æ®µ1: é…ç½®è§£æï¼ˆlib/config/normalization.jsï¼‰
  å°† entry é…ç½®è§„èŒƒåŒ–ä¸ºç»Ÿä¸€æ ¼å¼

  è¾“å…¥:
  entry: './src/index.js'
  æˆ–
  entry: { main: './src/index.js', admin: './src/admin.js' }

  è¾“å‡º:
  entries: Map {
    'main' => { dependencies: [EntryDependency], options: {...} }
  }

é˜¶æ®µ2: Make é˜¶æ®µå¼€å§‹ï¼ˆlib/EntryPlugin.jsï¼‰
  compiler.hooks.make é’©å­è§¦å‘
    â†“
  EntryPlugin ç›‘å¬å™¨æ‰§è¡Œ
    â†“
  compilation.addEntry(context, entryDependency, options)
    â†“
  å¼€å§‹æ„å»ºå…¥å£æ¨¡å—
```

**å…³é”®**ï¼šå…¥å£ä¸æ˜¯"æ‰¾å‡º"ï¼Œè€Œæ˜¯"æ·»åŠ "åˆ°ç¼–è¯‘ä¸­

---

#### 4. ç¼–è¯‘æ¨¡å—ï¼ˆâœ… æ­£ç¡®ï¼Œè¡¥å……ç»†èŠ‚ï¼‰

**ä½ çš„æè¿°åŸºæœ¬æ­£ç¡®**ï¼Œè¡¥å……å®ç°ç»†èŠ‚ï¼š

```
ç¼–è¯‘æ¨¡å—çš„å®Œæ•´æµç¨‹ï¼š

1. ä»å…¥å£ä¾èµ–å¼€å§‹
   compilation.addEntry(entryDependency)

2. åˆ›å»ºæ¨¡å—
   factorizeModule(dependency)
     â”œâ”€ NormalModuleFactory.create()
     â”œâ”€ resolve è·¯å¾„: './a.js' â†’ '/path/to/a.js'
     â”œâ”€ åŒ¹é… loader è§„åˆ™
     â””â”€ new NormalModule()

3. æ·»åŠ æ¨¡å—ï¼ˆå»é‡ï¼‰
   addModule(module)
     â”œâ”€ æ£€æŸ¥ identifier æ˜¯å¦å·²å­˜åœ¨
     â””â”€ å»é‡ï¼šç›¸åŒæ¨¡å—åªæ·»åŠ ä¸€æ¬¡

4. æ„å»ºæ¨¡å— â­â­â­
   module.build()
     â”œâ”€ è¯»å–æºæ–‡ä»¶å†…å®¹
     â”œâ”€ æ‰§è¡Œ loader é“¾ï¼ˆä»å³åˆ°å·¦ï¼‰
     â”‚   â”œâ”€ ts-loader: TS â†’ JS
     â”‚   â”œâ”€ babel-loader: ES6+ â†’ ES5
     â”‚   â””â”€ å…¶ä»– loader...
     â”œâ”€ parser.parse() è§£æ AST
     â”‚   â””â”€ è¯†åˆ«ä¾èµ–è¯­å¥
     â””â”€ æ”¶é›†ä¾èµ–åˆ° module.dependencies

5. å»ºç«‹ä¾èµ–å›¾è¿æ¥ â­â­â­
   moduleGraph.setResolvedModule(origin, dep, target)
     â”œâ”€ åˆ›å»º ModuleGraphConnection
     â”œâ”€ origin.outgoing.add(connection)
     â””â”€ target.incoming.add(connection)

6. é€’å½’å¤„ç†ä¾èµ– â­â­â­
   processModuleDependencies(module)
     â””â”€ å¯¹æ¯ä¸ªä¾èµ–é€’å½’æ‰§è¡Œæ­¥éª¤ 2-6
```

**Loader é¡ºåºè¯´æ˜**ï¼š
- âœ… ä½ è¯´çš„"ä»å³åˆ°å·¦ï¼Œä»ä¸‹åˆ°ä¸Š"æ˜¯æ­£ç¡®çš„
- æ›´å‡†ç¡®è¯´ï¼šé…ç½®ä¸­æœ€åä¸€ä¸ª loader æœ€å…ˆæ‰§è¡Œ

---

#### 5. å®Œæˆæ¨¡å—ç¼–è¯‘ï¼ˆâœ… æ­£ç¡®ï¼‰

**è¡¥å……**ï¼š
```
Make é˜¶æ®µç»“æŸæ—¶çš„äº§ç‰©ï¼š

ModuleGraphï¼ˆæ¨¡å—ä¾èµ–å›¾ï¼‰åŒ…å«ï¼š
â”œâ”€ æ‰€æœ‰æ¨¡å—ï¼ˆcompilation.modulesï¼‰
â”œâ”€ æ‰€æœ‰ä¾èµ–å…³ç³»ï¼ˆincoming/outgoing connectionsï¼‰
â”œâ”€ å¯¼å…¥å¯¼å‡ºä¿¡æ¯ï¼ˆexportsInfoï¼‰
â””â”€ æ¨¡å—æ·±åº¦å’Œé¡ºåºï¼ˆdepth, preOrderIndex, postOrderIndexï¼‰

æ­¤æ—¶ï¼š
- âœ… æ‰€æœ‰æ¨¡å—å·²æ„å»º
- âœ… æ‰€æœ‰ä¾èµ–å·²è§£æ
- âœ… ä¾èµ–å›¾å®Œæ•´
- â­ï¸ å‡†å¤‡è¿›å…¥ Seal é˜¶æ®µ
```

---

#### 6. è¾“å‡ºèµ„æºï¼ˆâš ï¸ éœ€è¦ç»†åŒ–ï¼‰

**ä½ çš„æè¿°åŸºæœ¬æ­£ç¡®**ï¼Œç»†åŒ–ä¸ºï¼š

```
Seal é˜¶æ®µï¼ˆlib/Compilation.js: seal()ï¼‰- 28 ä¸ªæ­¥éª¤ï¼š

æ­¥éª¤1-6: åˆ›å»º Chunk å’Œ ChunkGraph
  â”œâ”€ ä¸ºæ¯ä¸ªå…¥å£åˆ›å»º Chunk
  â””â”€ buildChunkGraphï¼ˆBFS éå†åˆ†é…æ¨¡å—åˆ° Chunkï¼‰

æ­¥éª¤7-10: ä¼˜åŒ–æ¨¡å— â­â­
  â”œâ”€ SideEffectsFlagPluginï¼ˆæ ‡è®°å‰¯ä½œç”¨ï¼‰
  â”œâ”€ FlagDependencyUsagePluginï¼ˆæ ‡è®°å¯¼å‡ºä½¿ç”¨ï¼‰
  â””â”€ ModuleConcatenationPluginï¼ˆæ¨¡å—åˆå¹¶ï¼‰
  ç»“æœ: Tree Shaking åˆ é™¤æœªä½¿ç”¨ä»£ç 

æ­¥éª¤11-12: ä¼˜åŒ– Chunk â­â­â­
  â””â”€ SplitChunksPlugin
      â”œâ”€ åˆ†ææ¨¡å—å…±äº«æƒ…å†µ
      â”œâ”€ æŒ‰ cacheGroups åˆ†ç»„
      â”œâ”€ åº”ç”¨ minSizeã€maxAsyncRequests ç­‰è§„åˆ™
      â””â”€ åˆ›å»ºå…¬å…± Chunk
  ç»“æœ: æå–å…¬å…±ä»£ç ï¼Œå‡å°‘é‡å¤

æ­¥éª¤13-18: ç”Ÿæˆ ID å’Œå“ˆå¸Œ
  â”œâ”€ moduleIdsï¼ˆæ¨¡å— IDï¼‰
  â”œâ”€ chunkIdsï¼ˆChunk IDï¼‰
  â””â”€ createHashï¼ˆå†…å®¹å“ˆå¸Œï¼‰

æ­¥éª¤19-21: ä»£ç ç”Ÿæˆ â­â­â­
  codeGeneration()
    â””â”€ å¯¹æ¯ä¸ªæ¨¡å—è°ƒç”¨ module.codeGeneration()
        â””â”€ JavascriptGenerator.generate()
            â”œâ”€ åŒ…è£…ä¸ºå‡½æ•°
            â”œâ”€ å¤„ç†å¯¼å…¥å¯¼å‡º
            â””â”€ åº”ç”¨ Tree Shaking

æ­¥éª¤22-25: åˆ›å»ºèµ„æº â­â­â­
  createChunkAssets()
    â””â”€ JavascriptModulesPlugin.renderMain()
        â”œâ”€ ç”Ÿæˆè¿è¡Œæ—¶ä»£ç 
        â”œâ”€ æ‹¼æ¥æ‰€æœ‰æ¨¡å—
        â”œâ”€ ç”Ÿæˆ Source å¯¹è±¡
        â””â”€ æ·»åŠ åˆ° compilation.assets

æ­¥éª¤26-28: å¤„ç†å’Œå®Œæˆ
  processAssets é’©å­ï¼ˆ15 ä¸ªé˜¶æ®µï¼‰
    â””â”€ TerserPlugin ç­‰å‹ç¼©æ’ä»¶
```

---

#### 7. è¾“å‡ºå®Œæˆï¼ˆâœ… æ­£ç¡®ï¼‰

**è¡¥å……å®ç°ç»†èŠ‚**ï¼š
```
Emit é˜¶æ®µï¼ˆlib/Compiler.js: emitAssets()ï¼‰ï¼š

æ­¥éª¤1: è§¦å‘ emit é’©å­
  æœ€åä¿®æ”¹ assets çš„æœºä¼š

æ­¥éª¤2: åˆ›å»ºè¾“å‡ºç›®å½•

æ­¥éª¤3: å¹¶å‘å†™å…¥æ–‡ä»¶ï¼ˆæœ€å¤š 15 ä¸ªå¹¶å‘ï¼‰
  for (const [filename, source] of assets) {
    â”œâ”€ æ£€æŸ¥ç¼“å­˜ï¼ˆæ˜¯å¦éœ€è¦å†™å…¥ï¼‰
    â”œâ”€ æ£€æŸ¥å¤§å°å†™å†²çª
    â”œâ”€ æ¯”è¾ƒæ–‡ä»¶å†…å®¹
    â”œâ”€ å†™å…¥æ–‡ä»¶
    â””â”€ è§¦å‘ assetEmitted é’©å­
  }

æ­¥éª¤4: è§¦å‘ afterEmit é’©å­

ç»“æœ: dist/ ç›®å½•ä¸‹ç”Ÿæˆæ‰€æœ‰æ–‡ä»¶
```

---

## äºŒã€æ¶‰åŠçš„æºç æ–‡ä»¶

### "å¼€å§‹ç¼–è¯‘"é˜¶æ®µæ¶‰åŠçš„æ ¸å¿ƒæ–‡ä»¶

```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ä¸»æµç¨‹æ–‡ä»¶
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
lib/webpack.js
  â””â”€ createCompiler(rawOptions)  â­â­â­
      â”œâ”€ è§„èŒƒåŒ–é…ç½®
      â”œâ”€ åˆ›å»º Compiler
      â”œâ”€ æ³¨å†Œæ’ä»¶
      â””â”€ è¿”å› compiler

lib/Compiler.js
  â”œâ”€ constructor()  // åˆå§‹åŒ–é’©å­ç³»ç»Ÿ
  â”œâ”€ run()         // å¼€å§‹å•æ¬¡ç¼–è¯‘
  â””â”€ watch()       // å¼€å§‹ç›‘å¬æ¨¡å¼

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
é…ç½®å¤„ç†æ–‡ä»¶
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
lib/config/normalization.js
  â””â”€ getNormalizedWebpackOptions()
      â””â”€ ç»Ÿä¸€é…ç½®æ ¼å¼

lib/config/defaults.js
  â”œâ”€ applyWebpackOptionsBaseDefaults()
  â””â”€ applyWebpackOptionsDefaults()
      â””â”€ åº”ç”¨é»˜è®¤é…ç½®

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
æ’ä»¶æ³¨å†Œæ–‡ä»¶ â­â­â­
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
lib/WebpackOptionsApply.js
  â””â”€ process(options, compiler)
      â””â”€ æ ¹æ®é…ç½®æ³¨å†Œå†…ç½®æ’ä»¶

lib/node/NodeEnvironmentPlugin.js
  â””â”€ æ³¨å…¥æ–‡ä»¶ç³»ç»Ÿèƒ½åŠ›

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
å†…ç½®æ’ä»¶æ–‡ä»¶ï¼ˆéƒ¨åˆ†é‡è¦çš„ï¼‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
lib/EntryPlugin.js              â­â­â­
  â””â”€ æ³¨å†Œ make é’©å­ï¼Œæ·»åŠ å…¥å£

lib/RuntimePlugin.js            â­â­
  â””â”€ æ³¨å†Œè¿è¡Œæ—¶ä»£ç ç”Ÿæˆ

lib/InferAsyncModulesPlugin.js  â­
  â””â”€ æ¨æ–­å¼‚æ­¥æ¨¡å—

lib/javascript/JavascriptModulesPlugin.js â­â­â­
  â””â”€ æ³¨å†Œ JS ä»£ç ç”Ÿæˆ

lib/optimize/* (å„ç§ä¼˜åŒ–æ’ä»¶)
  â”œâ”€ SplitChunksPlugin
  â”œâ”€ ModuleConcatenationPlugin
  â””â”€ ...
```

---

## ä¸‰ã€åˆå§‹åŒ–è¯¦ç»†æµç¨‹

### 3.1 å®Œæ•´çš„è°ƒç”¨é“¾

```
ç”¨æˆ·è°ƒç”¨: webpack(config)
  â†“
lib/index.js
  â””â”€ æ‡’åŠ è½½ lib/webpack.js
  â†“
lib/webpack.js: webpack() ä¸»å‡½æ•°
  â”œâ”€ éªŒè¯é…ç½®ï¼ˆschemaï¼‰
  â”œâ”€ åˆ›å»º Compiler
  â”‚   â””â”€ createCompiler(options)  â­â­â­ æ ¸å¿ƒæµç¨‹
  â”‚
  â””â”€ å¦‚æœæœ‰ callbackï¼š
      â””â”€ compiler.run(callback)
```

### 3.2 createCompiler è¯¦ç»†å®ç°

**æºç ä½ç½®**ï¼š`lib/webpack.js: createCompiler()`

**å®Œæ•´çš„ 9 ä¸ªæ­¥éª¤**ï¼ˆå·²æ·»åŠ è¯¦ç»†æ³¨é‡Šï¼‰ï¼š

```javascript
const createCompiler = rawOptions => {
  // ===== æ­¥éª¤1: è§„èŒƒåŒ–é…ç½® =====
  const options = getNormalizedWebpackOptions(rawOptions);

  // ===== æ­¥éª¤2: åº”ç”¨åŸºç¡€é»˜è®¤å€¼ =====
  applyWebpackOptionsBaseDefaults(options);

  // ===== æ­¥éª¤3: åˆ›å»º Compiler å®ä¾‹ =====
  const compiler = new Compiler(options.context, options);

  // ===== æ­¥éª¤4: åº”ç”¨ Node ç¯å¢ƒæ’ä»¶ =====
  new NodeEnvironmentPlugin({
    infrastructureLogging: options.infrastructureLogging
  }).apply(compiler);

  // ===== æ­¥éª¤5: æ³¨å†Œç”¨æˆ·æ’ä»¶ â­â­â­ =====
  /**
   * è¿™æ˜¯ç”¨æˆ·æ’ä»¶æ³¨å†Œçš„æ—¶æœºï¼
   *
   * ã€å·¥ä½œåŸç†ã€‘
   * 1. éå† options.plugins æ•°ç»„
   * 2. è°ƒç”¨æ¯ä¸ªæ’ä»¶çš„ apply æ–¹æ³•
   * 3. ä¼ å…¥ compiler å¯¹è±¡
   * 4. æ’ä»¶åœ¨ apply ä¸­æ³¨å†Œé’©å­
   */
  if (Array.isArray(options.plugins)) {
    for (const plugin of options.plugins) {
      if (typeof plugin === "function") {
        // å‡½æ•°å½¢å¼çš„æ’ä»¶
        plugin.call(compiler, compiler);
      } else if (plugin) {
        // å¯¹è±¡å½¢å¼çš„æ’ä»¶ï¼ˆæ ‡å‡†ï¼‰
        plugin.apply(compiler);  // â­ å…³é”®è°ƒç”¨
      }
    }
  }

  // ===== æ­¥éª¤6: åº”ç”¨å®Œæ•´é»˜è®¤å€¼ =====
  applyWebpackOptionsDefaults(options);

  // ===== æ­¥éª¤7: è§¦å‘ç¯å¢ƒé’©å­ =====
  compiler.hooks.environment.call();
  compiler.hooks.afterEnvironment.call();

  // ===== æ­¥éª¤8: åº”ç”¨å†…ç½®æ’ä»¶ â­â­â­ =====
  /**
   * WebpackOptionsApply æ ¹æ®é…ç½®æ³¨å†Œå†…ç½®æ’ä»¶
   *
   * ã€æ³¨å†Œçš„æ’ä»¶ã€‘
   * - EntryPluginï¼ˆæ·»åŠ å…¥å£ï¼‰
   * - RuntimePluginï¼ˆè¿è¡Œæ—¶ä»£ç ï¼‰
   * - SplitChunksPluginï¼ˆä»£ç åˆ†å‰²ï¼‰
   * - ç­‰ç­‰...
   */
  new WebpackOptionsApply().process(options, compiler);

  // ===== æ­¥éª¤9: è§¦å‘åˆå§‹åŒ–å®Œæˆé’©å­ =====
  compiler.hooks.initialize.call();

  return compiler;
};
```

### 3.3 Compiler æ„é€ å‡½æ•°

**æºç ä½ç½®**ï¼š`lib/Compiler.js: constructor()`

```javascript
class Compiler {
  constructor(context, options) {
    // ===== åˆ›å»º 30+ ä¸ªé’©å­ â­â­â­ =====
    /**
     * é’©å­æ˜¯ webpack æ’ä»¶ç³»ç»Ÿçš„æ ¸å¿ƒ
     *
     * ã€é’©å­ç±»å‹ã€‘
     * - SyncHook: åŒæ­¥é’©å­
     * - SyncBailHook: åŒæ­¥ç†”æ–­é’©å­
     * - AsyncSeriesHook: å¼‚æ­¥ä¸²è¡Œé’©å­
     * - AsyncParallelHook: å¼‚æ­¥å¹¶è¡Œé’©å­
     *
     * ã€å…³é”®é’©å­ã€‘
     * - make: æ„å»ºæ¨¡å—ï¼ˆæœ€é‡è¦ï¼ï¼‰
     * - compile: å¼€å§‹ç¼–è¯‘
     * - emit: è¾“å‡ºæ–‡ä»¶å‰
     * - done: ç¼–è¯‘å®Œæˆ
     */
    this.hooks = Object.freeze({
      initialize: new SyncHook([]),
      beforeRun: new AsyncSeriesHook(["compiler"]),
      run: new AsyncSeriesHook(["compiler"]),
      emit: new AsyncSeriesHook(["compilation"]),
      assetEmitted: new AsyncSeriesHook(["file", "info"]),
      afterEmit: new AsyncSeriesHook(["compilation"]),
      thisCompilation: new SyncHook(["compilation", "params"]),
      compilation: new SyncHook(["compilation", "params"]),
      make: new AsyncParallelHook(["compilation"]),  // â­â­â­
      afterCompile: new AsyncSeriesHook(["compilation"]),
      // ... è¿˜æœ‰ 20+ ä¸ªé’©å­
    });

    // ===== åˆå§‹åŒ–åŸºæœ¬å±æ€§ =====
    this.context = context;
    this.options = options;
    this.outputPath = "";
    this.watching = undefined;

    // ===== æ–‡ä»¶ç³»ç»Ÿï¼ˆç¨åç”± NodeEnvironmentPlugin æ³¨å…¥ï¼‰=====
    this.outputFileSystem = null;
    this.inputFileSystem = null;
    this.watchFileSystem = null;

    // ===== è§£æå™¨å·¥å‚ =====
    this.resolverFactory = new ResolverFactory();

    // ===== ç¼“å­˜ç³»ç»Ÿ =====
    this.cache = new Cache();

    // ... æ›´å¤šå±æ€§åˆå§‹åŒ–
  }
}
```

---

## å››ã€æ’ä»¶å·¥ä½œåŸç†

### 4.1 æ’ä»¶çš„æœ¬è´¨

**æ’ä»¶ = ä¸€ä¸ªå…·æœ‰ apply æ–¹æ³•çš„å¯¹è±¡æˆ–å‡½æ•°**

```javascript
// æ ‡å‡†æ’ä»¶æ ¼å¼
class MyPlugin {
  apply(compiler) {
    // åœ¨è¿™é‡Œæ³¨å†Œé’©å­
    compiler.hooks.make.tapAsync('MyPlugin', (compilation, callback) => {
      // æ’ä»¶é€»è¾‘
      callback();
    });
  }
}

// ä½¿ç”¨
module.exports = {
  plugins: [
    new MyPlugin()
  ]
};
```

### 4.2 æ’ä»¶æ³¨å†Œæœºåˆ¶

**æ³¨å†Œæ—¶æœºå›¾**ï¼š

```
webpack(config)
  â†“
createCompiler(options)
  â†“
æ­¥éª¤5: æ³¨å†Œç”¨æˆ·æ’ä»¶
  â†“
for (const plugin of options.plugins) {
  plugin.apply(compiler);  // â­ è¿™é‡Œè°ƒç”¨
    â†“
  // æ’ä»¶å†…éƒ¨
  apply(compiler) {
    // æ³¨å†Œé’©å­ç›‘å¬å™¨
    compiler.hooks.make.tapAsync('PluginName', (compilation, callback) => {
      // ç›‘å¬å™¨å‡½æ•°ï¼ˆç¨åè§¦å‘ï¼‰
    });

    compiler.hooks.emit.tapAsync('PluginName', (compilation, callback) => {
      // å¦ä¸€ä¸ªç›‘å¬å™¨
    });
  }
}
  â†“
æ­¥éª¤8: åº”ç”¨å†…ç½®æ’ä»¶
  â†“
new WebpackOptionsApply().process(options, compiler)
  â†“
æ ¹æ®é…ç½®å†³å®šæ³¨å†Œå“ªäº›å†…ç½®æ’ä»¶ï¼š
  â”œâ”€ if (options.entry) â†’ new EntryPlugin()
  â”œâ”€ if (options.optimization.splitChunks) â†’ new SplitChunksPlugin()
  â””â”€ ...
  â†“
å†…ç½®æ’ä»¶ä¹Ÿè°ƒç”¨ apply æ³¨å†Œé’©å­
  â†“
åˆå§‹åŒ–å®Œæˆï¼Œcompiler å‡†å¤‡å°±ç»ª
  â†“
compiler.run() å¼€å§‹ç¼–è¯‘
  â†“
æŒ‰é¡ºåºè§¦å‘é’©å­ï¼š
  beforeRun â†’ run â†’ compile â†’ make â†’ ...
  â†“
æ’ä»¶çš„ç›‘å¬å™¨è¢«è°ƒç”¨ï¼ˆæ‰§è¡Œæ’ä»¶é€»è¾‘ï¼‰
```

### 4.3 é’©å­çš„è§¦å‘æ—¶æœº

```javascript
// webpack å†…éƒ¨è§¦å‘é’©å­
compiler.hooks.make.callAsync(compilation, err => {
  // æ‰€æœ‰æ³¨å†Œåœ¨ make é’©å­ä¸Šçš„æ’ä»¶éƒ½ä¼šæ‰§è¡Œ
});

// ä¾‹å¦‚ EntryPlugin ç›‘å¬äº† make é’©å­ï¼š
class EntryPlugin {
  apply(compiler) {
    compiler.hooks.make.tapAsync('EntryPlugin', (compilation, callback) => {
      // â­ make é’©å­è§¦å‘æ—¶ï¼Œè¿™é‡Œæ‰§è¡Œ
      compilation.addEntry(...);
      callback();
    });
  }
}
```

### 4.4 ä¸‰ç§æ³¨å†Œæ–¹å¼

```javascript
// 1. tap - åŒæ­¥æ³¨å†Œ
compiler.hooks.compilation.tap('MyPlugin', (compilation) => {
  // åŒæ­¥æ‰§è¡Œ
});

// 2. tapAsync - å¼‚æ­¥æ³¨å†Œï¼ˆcallbackï¼‰
compiler.hooks.make.tapAsync('MyPlugin', (compilation, callback) => {
  // å¼‚æ­¥æ‰§è¡Œ
  doSomethingAsync(() => {
    callback();  // å¿…é¡»è°ƒç”¨ callback
  });
});

// 3. tapPromise - å¼‚æ­¥æ³¨å†Œï¼ˆPromiseï¼‰
compiler.hooks.make.tapPromise('MyPlugin', (compilation) => {
  // è¿”å› Promise
  return doSomethingAsync();
});
```

---

## äº”ã€æ’ä»¶åŠŸèƒ½åˆ†ç±»

### 5.1 æŒ‰ç”Ÿå‘½å‘¨æœŸåˆ†ç±»

#### åˆå§‹åŒ–é˜¶æ®µæ’ä»¶
```javascript
// NodeEnvironmentPlugin
class NodeEnvironmentPlugin {
  apply(compiler) {
    // æ³¨å…¥æ–‡ä»¶ç³»ç»Ÿ
    compiler.inputFileSystem = new CachedInputFileSystem(...);
    compiler.outputFileSystem = require("fs");
    compiler.watchFileSystem = new NodeWatchFileSystem(...);
  }
}

// ä½œç”¨: ä¸º compiler æä¾›æ–‡ä»¶ç³»ç»Ÿèƒ½åŠ›
// æ—¶æœº: createCompiler æ­¥éª¤4
```

#### å…¥å£å¤„ç†æ’ä»¶
```javascript
// EntryPlugin
class EntryPlugin {
  constructor(context, entry, options) {
    this.context = context;
    this.entry = entry;
    this.options = options;
  }

  apply(compiler) {
    // ç›‘å¬ make é’©å­
    compiler.hooks.make.tapAsync('EntryPlugin', (compilation, callback) => {
      const { context, entry, options } = this;

      // â­â­â­ æ·»åŠ å…¥å£åˆ°ç¼–è¯‘
      compilation.addEntry(context, entry, options, err => {
        callback(err);
      });
    });
  }
}

// ä½œç”¨: åœ¨ make é˜¶æ®µæ·»åŠ å…¥å£æ¨¡å—
// æ—¶æœº: compiler.hooks.make è§¦å‘æ—¶
// æ³¨å†Œ: WebpackOptionsApply.process() ä¸­
```

#### æ¨¡å—å¤„ç†æ’ä»¶
```javascript
// JavascriptModulesPlugin
class JavascriptModulesPlugin {
  apply(compiler) {
    // 1. æ³¨å†Œ parser å·¥å‚
    compiler.hooks.compilation.tap('JavascriptModulesPlugin',
      (compilation, { normalModuleFactory }) => {
        // ä¸ºä¸åŒæ¨¡å—ç±»å‹æ³¨å†Œ parser
        normalModuleFactory.hooks.createParser
          .for('javascript/auto')
          .tap('JavascriptModulesPlugin', () => {
            return new JavascriptParser();
          });
      }
    );

    // 2. æ³¨å†Œä»£ç ç”Ÿæˆ
    compilation.hooks.renderManifest.tap('JavascriptModulesPlugin',
      (result, options) => {
        // ç”Ÿæˆ JS ä»£ç 
        const source = this.renderMain(options);
        result.push({ render: () => source, ... });
      }
    );
  }
}

// ä½œç”¨: æ³¨å†Œ JS æ¨¡å—çš„è§£æå’Œä»£ç ç”Ÿæˆ
// æ—¶æœº: å¤šä¸ªé’©å­ï¼ˆcompilationã€renderManifest ç­‰ï¼‰
```

#### ä¼˜åŒ–æ’ä»¶
```javascript
// SplitChunksPlugin
class SplitChunksPlugin {
  apply(compiler) {
    compiler.hooks.thisCompilation.tap('SplitChunksPlugin', (compilation) => {
      // ç›‘å¬ä¼˜åŒ– chunks é’©å­
      compilation.hooks.optimizeChunks.tap(
        {
          name: 'SplitChunksPlugin',
          stage: STAGE_ADVANCED  // åœ¨é«˜çº§é˜¶æ®µæ‰§è¡Œ
        },
        (chunks) => {
          // â­â­â­ ä»£ç åˆ†å‰²é€»è¾‘
          // 1. åˆ†ææ¨¡å—å…±äº«
          // 2. æŒ‰ cacheGroups åˆ†ç»„
          // 3. åº”ç”¨è§„åˆ™
          // 4. åˆ›å»ºæ–° chunk
        }
      );
    });
  }
}

// ä½œç”¨: æå–å…¬å…±ä»£ç åˆ°ç‹¬ç«‹ chunk
// æ—¶æœº: compilation.hooks.optimizeChunksï¼ˆSeal é˜¶æ®µï¼‰
```

#### è¾“å‡ºæ’ä»¶
```javascript
// BannerPluginï¼ˆç¤ºä¾‹ï¼‰
class BannerPlugin {
  constructor(options) {
    this.banner = options.banner;
  }

  apply(compiler) {
    compiler.hooks.compilation.tap('BannerPlugin', (compilation) => {
      // ç›‘å¬èµ„æºå¤„ç†é’©å­
      compilation.hooks.processAssets.tap(
        {
          name: 'BannerPlugin',
          stage: Compilation.PROCESS_ASSETS_STAGE_ADDITIONS
        },
        (assets) => {
          // ä¸ºæ¯ä¸ª JS æ–‡ä»¶æ·»åŠ  banner
          for (const file in assets) {
            if (file.endsWith('.js')) {
              const original = assets[file].source();
              assets[file] = new RawSource(
                `/*! ${this.banner} */\n${original}`
              );
            }
          }
        }
      );
    });
  }
}

// ä½œç”¨: åœ¨æ–‡ä»¶å¼€å¤´æ·»åŠ æ³¨é‡Š
// æ—¶æœº: compilation.hooks.processAssetsï¼ˆSeal é˜¶æ®µï¼‰
```

### 5.2 æŒ‰åŠŸèƒ½åˆ†ç±»

#### A. å…¥å£æ’ä»¶
```
EntryPlugin              â†’ æ·»åŠ å…¥å£æ¨¡å—
DynamicEntryPlugin       â†’ åŠ¨æ€å…¥å£
DllEntryPlugin          â†’ DLL å…¥å£
```

#### B. è¾“å‡ºæ’ä»¶
```
LibraryTemplatePlugin    â†’ åº“è¾“å‡º
JsonpTemplatePlugin      â†’ JSONP è¾“å‡º
NodeTemplatePlugin       â†’ Node.js è¾“å‡º
```

#### C. æ¨¡å—æ’ä»¶
```
NormalModuleReplacementPlugin  â†’ æ¨¡å—æ›¿æ¢
ContextReplacementPlugin       â†’ ä¸Šä¸‹æ–‡æ›¿æ¢
IgnorePlugin                   â†’ å¿½ç•¥æ¨¡å—
```

#### D. ä¼˜åŒ–æ’ä»¶
```
SplitChunksPlugin              â†’ ä»£ç åˆ†å‰² â­â­â­
ModuleConcatenationPlugin      â†’ æ¨¡å—åˆå¹¶
RuntimeChunkPlugin             â†’ æå–è¿è¡Œæ—¶
MinChunkSizePlugin             â†’ åˆå¹¶å° chunk
LimitChunkCountPlugin          â†’ é™åˆ¶ chunk æ•°é‡
```

#### E. å¼€å‘æ’ä»¶
```
HotModuleReplacementPlugin     â†’ çƒ­æ›´æ–°
ProgressPlugin                 â†’ è¿›åº¦æ˜¾ç¤º
ProvidePlugin                  â†’ è‡ªåŠ¨åŠ è½½æ¨¡å—
DefinePlugin                   â†’ å®šä¹‰å…¨å±€å¸¸é‡
```

---

## å…­ã€å®ç°ç»†èŠ‚ä¸æ³¨æ„äº‹é¡¹

### 6.1 æ’ä»¶æ³¨å†Œé¡ºåºå¾ˆé‡è¦ â­â­â­

```javascript
// âŒ é”™è¯¯ç¤ºä¾‹
module.exports = {
  plugins: [
    new PluginB(),  // ä¾èµ– PluginA è®¾ç½®çš„æ•°æ®
    new PluginA()   // åæ³¨å†Œ
  ]
};

// âœ… æ­£ç¡®ç¤ºä¾‹
module.exports = {
  plugins: [
    new PluginA(),  // å…ˆæ³¨å†Œ
    new PluginB()   // åæ³¨å†Œï¼Œå¯ä»¥ä½¿ç”¨ A çš„æ•°æ®
  ]
};

// åŸå› ï¼š
// 1. æ’ä»¶æŒ‰é¡ºåºè°ƒç”¨ apply
// 2. åœ¨åŒä¸€ä¸ªé’©å­ä¸Šï¼Œå…ˆæ³¨å†Œçš„å…ˆæ‰§è¡Œ
// 3. æŸäº›æ’ä»¶å¯èƒ½ä¾èµ–å…¶ä»–æ’ä»¶çš„ç»“æœ
```

### 6.2 ç”¨æˆ·æ’ä»¶ vs å†…ç½®æ’ä»¶ â­â­

**æ³¨å†Œé¡ºåº**ï¼š
```
æ­¥éª¤5: ç”¨æˆ·æ’ä»¶
  â†“
æ­¥éª¤6: åº”ç”¨å®Œæ•´é»˜è®¤å€¼
  â†“
æ­¥éª¤8: å†…ç½®æ’ä»¶
```

**ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡**ï¼Ÿ

```javascript
// åŸå› 1: ç”¨æˆ·æ’ä»¶å¯ä»¥å½±å“é»˜è®¤å€¼
class MyPlugin {
  apply(compiler) {
    // æ­¤æ—¶ mode å¯èƒ½è¿˜æ˜¯ undefined
    if (compiler.options.mode === undefined) {
      compiler.options.mode = 'custom';
    }
  }
}

// æ­¥éª¤6 ä¼šåº”ç”¨é»˜è®¤å€¼
// å¦‚æœ mode ä»æ˜¯ undefinedï¼Œæ‰è®¾ä¸º 'production'

// åŸå› 2: å†…ç½®æ’ä»¶éœ€è¦å®Œæ•´é…ç½®
// SplitChunksPlugin éœ€è¦çŸ¥é“å®Œæ•´çš„ optimization é…ç½®
// æ‰€ä»¥åœ¨æ­¥éª¤8ï¼ˆåº”ç”¨å®Œæ•´é»˜è®¤å€¼ä¹‹åï¼‰æ³¨å†Œ
```

### 6.3 é’©å­çš„é˜¶æ®µï¼ˆstageï¼‰â­â­

```javascript
// æŸäº›é’©å­æ”¯æŒ stage
compilation.hooks.optimizeChunks.tap(
  {
    name: 'MyPlugin',
    stage: STAGE_ADVANCED  // åœ¨é«˜çº§é˜¶æ®µæ‰§è¡Œ
  },
  (chunks) => {
    // æ’ä»¶é€»è¾‘
  }
);

// stage å†³å®šæ‰§è¡Œé¡ºåºï¼š
STAGE_BASIC = -10      // åŸºç¡€é˜¶æ®µ
STAGE_DEFAULT = 0      // é»˜è®¤é˜¶æ®µ
STAGE_ADVANCED = 10    // é«˜çº§é˜¶æ®µ

// ç¤ºä¾‹ï¼š
// 1. RemoveEmptyChunksPlugin (BASIC)
// 2. ç”¨æˆ·æ’ä»¶ (DEFAULT)
// 3. SplitChunksPlugin (ADVANCED)
```

### 6.4 context å’Œ compiler çš„åŒºåˆ« â­

```javascript
// context: é¡¹ç›®æ ¹ç›®å½•ï¼ˆå­—ç¬¦ä¸²ï¼‰
const context = '/Users/project';

// compiler: ç¼–è¯‘å™¨å¯¹è±¡ï¼ˆç±»å®ä¾‹ï¼‰
const compiler = new Compiler(context, options);

// ä¸è¦æ··æ·†ï¼š
// âŒ compiler.context æ˜¯è·¯å¾„
// âœ… compiler æ˜¯å¯¹è±¡
```

### 6.5 compilation vs compiler â­â­

```
Compilerï¼ˆç¼–è¯‘å™¨ï¼‰:
- å…¨å±€å”¯ä¸€
- ç®¡ç†æ•´ä¸ªç”Ÿå‘½å‘¨æœŸ
- æŒä¹…åŒ–çŠ¶æ€
- æ–‡ä»¶ç³»ç»Ÿã€ç¼“å­˜
- è§¦å‘é’©å­

Compilationï¼ˆç¼–è¯‘å®ä¾‹ï¼‰:
- æ¯æ¬¡ç¼–è¯‘åˆ›å»º
- ç®¡ç†å•æ¬¡ç¼–è¯‘
- ä¸´æ—¶çŠ¶æ€
- æ¨¡å—ã€Chunkã€èµ„æº
- æ‰§è¡Œå…·ä½“å·¥ä½œ

å…³ç³»:
compiler.compile() â†’ new Compilation()
watch æ¨¡å¼: 1 ä¸ª compilerï¼Œå¤šä¸ª compilation
```

### 6.6 é’©å­çš„ç†”æ–­æœºåˆ¶ â­

```javascript
// SyncBailHook: æœ‰è¿”å›å€¼æ—¶åœæ­¢
compiler.hooks.shouldEmit.tap('MyPlugin', (compilation) => {
  if (hasErrors) {
    return false;  // â­ è¿”å› falseï¼Œé˜»æ­¢è¾“å‡º
  }
  // è¿”å› undefinedï¼Œç»§ç»­æ‰§è¡Œå…¶ä»–æ’ä»¶
});

// åœºæ™¯ï¼š
// - ç±»å‹æ£€æŸ¥æ’ä»¶å¯ä»¥é˜»æ­¢è¾“å‡º
// - åªåšæ£€æŸ¥ï¼Œä¸è¾“å‡ºæ–‡ä»¶
```

### 6.7 å†…å­˜æ³„æ¼æ³¨æ„äº‹é¡¹ â­â­

```javascript
// âŒ é”™è¯¯ï¼šä¿å­˜ compilation å¼•ç”¨
class BadPlugin {
  constructor() {
    this.compilations = [];  // å†…å­˜æ³„æ¼ï¼
  }

  apply(compiler) {
    compiler.hooks.compilation.tap('BadPlugin', (compilation) => {
      this.compilations.push(compilation);  // âš ï¸ æ³„æ¼
    });
  }
}

// âœ… æ­£ç¡®ï¼šä¸ä¿å­˜å¼•ç”¨
class GoodPlugin {
  apply(compiler) {
    compiler.hooks.compilation.tap('GoodPlugin', (compilation) => {
      // ç›´æ¥ä½¿ç”¨ï¼Œä¸ä¿å­˜
      // compilation ä¼šè¢« GC
    });
  }
}

// åŸå› ï¼š
// - watch æ¨¡å¼ä¼šåˆ›å»ºå¤šä¸ª compilation
// - ä¿å­˜å¼•ç”¨ä¼šé˜»æ­¢ GC
// - å¯¼è‡´å†…å­˜æŒç»­å¢é•¿
```

---

## ä¸ƒã€æ¨¡å—å…³ç³»å›¾

### 7.1 åˆå§‹åŒ–æµç¨‹ä¸­çš„æ¨¡å—è°ƒç”¨å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç”¨æˆ·å±‚                               â”‚
â”‚  webpack.config.js  â†’  è°ƒç”¨ webpack(config)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ä¸»å…¥å£å±‚                               â”‚
â”‚  lib/index.js                                           â”‚
â”‚    â””â”€ æ‡’åŠ è½½ lib/webpack.js                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   å·¥å‚å±‚                                 â”‚
â”‚  lib/webpack.js                                         â”‚
â”‚    â”œâ”€ webpack() ä¸»å‡½æ•°                                  â”‚
â”‚    â”œâ”€ createCompiler() â­â­â­                            â”‚
â”‚    â””â”€ createMultiCompiler()                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   é…ç½®å±‚                                 â”‚
â”‚  lib/config/normalization.js                            â”‚
â”‚    â””â”€ getNormalizedWebpackOptions()                     â”‚
â”‚                                                          â”‚
â”‚  lib/config/defaults.js                                 â”‚
â”‚    â”œâ”€ applyWebpackOptionsBaseDefaults()                 â”‚
â”‚    â””â”€ applyWebpackOptionsDefaults()                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ç¼–è¯‘å™¨å±‚                               â”‚
â”‚  lib/Compiler.js                                        â”‚
â”‚    â”œâ”€ constructor() - åˆ›å»ºé’©å­ç³»ç»Ÿ                      â”‚
â”‚    â”œâ”€ run() - å•æ¬¡ç¼–è¯‘                                  â”‚
â”‚    â”œâ”€ watch() - ç›‘å¬æ¨¡å¼                                â”‚
â”‚    â””â”€ compile() - ç¼–è¯‘æµç¨‹                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æ’ä»¶å±‚                                 â”‚
â”‚  ç”¨æˆ·æ’ä»¶ï¼ˆæ­¥éª¤5ï¼‰                                       â”‚
â”‚    â””â”€ plugin.apply(compiler)                            â”‚
â”‚        â””â”€ æ³¨å†Œé’©å­ç›‘å¬å™¨                                â”‚
â”‚                                                          â”‚
â”‚  lib/WebpackOptionsApply.jsï¼ˆæ­¥éª¤8ï¼‰â­â­â­               â”‚
â”‚    â””â”€ process(options, compiler)                        â”‚
â”‚        â”œâ”€ new EntryPlugin().apply(compiler)             â”‚
â”‚        â”œâ”€ new RuntimePlugin().apply(compiler)           â”‚
â”‚        â”œâ”€ new JavascriptModulesPlugin().apply(compiler) â”‚
â”‚        â”œâ”€ new SplitChunksPlugin().apply(compiler)       â”‚
â”‚        â””â”€ ... æ›´å¤šå†…ç½®æ’ä»¶                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
                [åˆå§‹åŒ–å®Œæˆ]
                        â†“
                compiler.run()
                        â†“
                [å¼€å§‹ç¼–è¯‘]
```

### 7.2 æ’ä»¶ä¸é’©å­çš„å…³ç³»

```
Compilerï¼ˆé’©å­æä¾›è€…ï¼‰
  â”œâ”€ hooks.make â”€â”€â”€â”€â”€â”€â”
  â”œâ”€ hooks.compile â”€â”€â”€â”¤
  â”œâ”€ hooks.emit â”€â”€â”€â”€â”€â”€â”¤
  â””â”€ hooks.done â”€â”€â”€â”€â”€â”€â”¤
                     â”‚
        ç›‘å¬          â”‚
                     â”‚
æ’ä»¶ï¼ˆé’©å­æ¶ˆè´¹è€…ï¼‰    â”‚
  â”œâ”€ EntryPlugin â”€â”€â”€â”€â”˜â”€â†’ ç›‘å¬ make
  â”œâ”€ BannerPlugin â”€â”€â”€â”˜â”€â†’ ç›‘å¬ emit
  â””â”€ MyPlugin â”€â”€â”€â”€â”€â”€â”€â”˜â”€â†’ ç›‘å¬ done

æ‰§è¡Œæµç¨‹:
compiler.hooks.make.callAsync(...)
  â†“ è§¦å‘æ‰€æœ‰ç›‘å¬å™¨
EntryPlugin çš„ make ç›‘å¬å™¨æ‰§è¡Œ
  â†“
compilation.addEntry(...)
  â†“
å¼€å§‹æ„å»ºæ¨¡å—
```

---

## å…«ã€WebpackOptionsApply è¯¦è§£

### 8.1 æ ¸å¿ƒä½œç”¨

**å°†é…ç½®è½¬æ¢ä¸ºæ’ä»¶**

```javascript
class WebpackOptionsApply {
  process(options, compiler) {
    // ===== æ ¹æ®é…ç½®å†³å®šæ³¨å†Œå“ªäº›æ’ä»¶ =====

    // 1. å…¥å£æ’ä»¶
    for (const [name, entry] of Object.entries(options.entry)) {
      const EntryPlugin = require("./EntryPlugin");
      for (const dep of entry.dependencies) {
        new EntryPlugin(
          compiler.context,
          dep,
          entry.options
        ).apply(compiler);
      }
    }

    // 2. è¾“å‡ºæ’ä»¶
    if (options.output.library) {
      const EnableLibraryPlugin = require("./library/EnableLibraryPlugin");
      new EnableLibraryPlugin(options.output.library.type).apply(compiler);
    }

    // 3. å¤–éƒ¨æ¨¡å—æ’ä»¶
    if (options.externals) {
      const ExternalsPlugin = require("./ExternalsPlugin");
      new ExternalsPlugin(
        options.externalsType,
        options.externals
      ).apply(compiler);
    }

    // 4. å¼€å‘æœåŠ¡å™¨æ’ä»¶
    if (options.devtool) {
      const EvalSourceMapDevToolPlugin =
        require("./EvalSourceMapDevToolPlugin");
      new EvalSourceMapDevToolPlugin({
        ...
      }).apply(compiler);
    }

    // 5. ä¼˜åŒ–æ’ä»¶
    if (options.optimization.splitChunks) {
      const SplitChunksPlugin =
        require("./optimize/SplitChunksPlugin");
      new SplitChunksPlugin(
        options.optimization.splitChunks
      ).apply(compiler);
    }

    // ... è¿˜æœ‰ 50+ ä¸ªæ¡ä»¶åˆ¤æ–­
    // æ ¹æ®é…ç½®æ³¨å†Œå¯¹åº”çš„æ’ä»¶
  }
}
```

### 8.2 é…ç½® â†’ æ’ä»¶æ˜ å°„è¡¨

| é…ç½®é¡¹ | å¯¹åº”æ’ä»¶ | ä½œç”¨ |
|--------|---------|------|
| entry | EntryPlugin | æ·»åŠ å…¥å£ |
| output.library | EnableLibraryPlugin | åº“è¾“å‡º |
| externals | ExternalsPlugin | å¤–éƒ¨ä¾èµ– |
| devtool | SourceMapDevToolPlugin | SourceMap |
| optimization.splitChunks | SplitChunksPlugin | ä»£ç åˆ†å‰² |
| optimization.runtimeChunk | RuntimeChunkPlugin | æå–è¿è¡Œæ—¶ |
| optimization.minimize | TerserPlugin | å‹ç¼©ä»£ç  |
| target: 'web' | JsonpTemplatePlugin | æµè§ˆå™¨ç¯å¢ƒ |
| target: 'node' | NodeTemplatePlugin | Node.js ç¯å¢ƒ |

---

## ä¹ã€æºç ç»†èŠ‚ä¸æ³¨æ„äº‹é¡¹

### 9.1 æ’ä»¶çš„ apply åªè°ƒç”¨ä¸€æ¬¡ â­

```javascript
// æ’ä»¶å®ä¾‹åœ¨æ•´ä¸ª webpack ç”Ÿå‘½å‘¨æœŸä¸­åªåˆ›å»ºä¸€æ¬¡
const plugin = new MyPlugin();

// apply ä¹Ÿåªè°ƒç”¨ä¸€æ¬¡ï¼ˆåœ¨åˆå§‹åŒ–æ—¶ï¼‰
plugin.apply(compiler);

// å³ä½¿æ˜¯ watch æ¨¡å¼ï¼Œå¤šæ¬¡ç¼–è¯‘
// æ’ä»¶ä¹Ÿä¸ä¼šé‡æ–°åˆ›å»ºå’Œè°ƒç”¨ apply

// æ‰€ä»¥ï¼š
// âœ… åœ¨ apply ä¸­æ³¨å†Œé’©å­ç›‘å¬å™¨
// âŒ ä¸è¦åœ¨ apply ä¸­æ‰§è¡Œç¼–è¯‘é€»è¾‘
```

### 9.2 é’©å­ç›‘å¬å™¨å¯ä»¥æ³¨å†Œå¤šæ¬¡ â­

```javascript
// åŒä¸€ä¸ªæ’ä»¶å¯ä»¥ç›‘å¬å¤šä¸ªé’©å­
class MyPlugin {
  apply(compiler) {
    // ç›‘å¬ make é’©å­
    compiler.hooks.make.tapAsync('MyPlugin', (...) => {});

    // ç›‘å¬ emit é’©å­
    compiler.hooks.emit.tapAsync('MyPlugin', (...) => {});

    // ç›‘å¬ done é’©å­
    compiler.hooks.done.tap('MyPlugin', (...) => {});
  }
}

// å¤šä¸ªæ’ä»¶å¯ä»¥ç›‘å¬åŒä¸€ä¸ªé’©å­
// PluginA å’Œ PluginB éƒ½ç›‘å¬ make
// æŒ‰æ³¨å†Œé¡ºåºä¾æ¬¡æ‰§è¡Œ
```

### 9.3 thisCompilation vs compilation é’©å­ â­â­

```javascript
// thisCompilation: åªåœ¨ä¸»ç¼–è¯‘å™¨è§¦å‘
compiler.hooks.thisCompilation.tap('Plugin', (compilation) => {
  // åªæ‰§è¡Œä¸€æ¬¡ï¼ˆä¸»ç¼–è¯‘ï¼‰
});

// compilation: ä¸»ç¼–è¯‘å™¨å’Œå­ç¼–è¯‘å™¨éƒ½è§¦å‘
compiler.hooks.compilation.tap('Plugin', (compilation) => {
  // å¯èƒ½æ‰§è¡Œå¤šæ¬¡ï¼ˆä¸» + å­ç¼–è¯‘ï¼‰
});

// ä½¿ç”¨å»ºè®®ï¼š
// - å¤§éƒ¨åˆ†æƒ…å†µä½¿ç”¨ compilation
// - éœ€è¦åŒºåˆ†ä¸»/å­ç¼–è¯‘æ—¶ä½¿ç”¨ thisCompilation
```

### 9.4 å¼‚æ­¥é’©å­å¿…é¡»è°ƒç”¨ callback â­

```javascript
// âŒ é”™è¯¯ï¼šå¿˜è®°è°ƒç”¨ callback
compiler.hooks.make.tapAsync('Plugin', (compilation, callback) => {
  doSomethingAsync();
  // å¿˜è®°è°ƒç”¨ callbackï¼Œwebpack ä¼šä¸€ç›´ç­‰å¾…
});

// âœ… æ­£ç¡®ï¼šå¿…é¡»è°ƒç”¨ callback
compiler.hooks.make.tapAsync('Plugin', (compilation, callback) => {
  doSomethingAsync(() => {
    callback();  // â­ å¿…é¡»è°ƒç”¨
  });
});

// âœ… æˆ–ä¼ é€’é”™è¯¯
compiler.hooks.make.tapAsync('Plugin', (compilation, callback) => {
  doSomethingAsync((err) => {
    callback(err);  // ä¼ é€’é”™è¯¯
  });
});
```

### 9.5 ä¸è¦åœ¨é’©å­ä¸­ä¿®æ”¹ options âš ï¸

```javascript
// âŒ å±é™©ï¼šåœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­ä¿®æ”¹é…ç½®
compiler.hooks.make.tap('Plugin', (compilation) => {
  compiler.options.entry = './new-entry.js';  // âš ï¸ ä¸è¦è¿™æ ·åš
});

// åŸå› ï¼š
// 1. é…ç½®å·²ç»è¢«å¤„ç†å’Œåº”ç”¨
// 2. ä¿®æ”¹ä¸ä¼šç”Ÿæ•ˆ
// 3. å¯èƒ½å¯¼è‡´ä¸ä¸€è‡´

// âœ… æ­£ç¡®ï¼šåœ¨åˆå§‹åŒ–æ—¶ä¿®æ”¹
class MyPlugin {
  apply(compiler) {
    // åœ¨ apply ä¸­ä¿®æ”¹ï¼ˆå¦‚æœçœŸçš„éœ€è¦ï¼‰
    compiler.options.someOption = newValue;

    // ç„¶åæ³¨å†Œé’©å­
    compiler.hooks.make.tap(...);
  }
}
```

---

## åã€å®æˆ˜ç¤ºä¾‹

### 10.1 å®Œæ•´çš„æ’ä»¶ç¤ºä¾‹

```javascript
/**
 * ç»Ÿè®¡æ’ä»¶ç¤ºä¾‹
 *
 * åŠŸèƒ½ï¼š
 * - è®°å½•ç¼–è¯‘æ—¶é—´
 * - ç»Ÿè®¡æ¨¡å—æ•°é‡
 * - ç»Ÿè®¡ chunk æ•°é‡
 * - è¾“å‡ºåˆ°æ–‡ä»¶
 */
class StatsPlugin {
  constructor(options) {
    this.options = options || {};
    this.outputFile = this.options.outputFile || 'stats.json';
  }

  apply(compiler) {
    let startTime;
    let stats = {};

    // 1. ç¼–è¯‘å¼€å§‹
    compiler.hooks.compile.tap('StatsPlugin', () => {
      startTime = Date.now();
      console.log('â±ï¸  Compilation started...');
    });

    // 2. Make é˜¶æ®µ
    compiler.hooks.make.tap('StatsPlugin', (compilation) => {
      console.log('ğŸ”¨ Make stage...');
    });

    // 3. Seal é˜¶æ®µ
    compiler.hooks.compilation.tap('StatsPlugin', (compilation) => {
      // ç›‘å¬ Compilation çš„é’©å­
      compilation.hooks.seal.tap('StatsPlugin', () => {
        console.log('ğŸ“¦ Seal stage...');
      });

      compilation.hooks.optimizeChunks.tap('StatsPlugin', (chunks) => {
        console.log(`âœ¨ Optimizing ${chunks.size} chunks...`);
      });
    });

    // 4. ç¼–è¯‘å®Œæˆ
    compiler.hooks.done.tap('StatsPlugin', (statsData) => {
      const duration = Date.now() - startTime;

      // æ”¶é›†ç»Ÿè®¡ä¿¡æ¯
      stats = {
        time: duration,
        modules: statsData.compilation.modules.size,
        chunks: statsData.compilation.chunks.size,
        assets: Object.keys(statsData.compilation.assets).length,
        errors: statsData.compilation.errors.length,
        warnings: statsData.compilation.warnings.length
      };

      console.log(`âœ… Compilation completed in ${duration}ms`);
      console.log(`ğŸ“Š Stats:`, stats);

      // è¾“å‡ºåˆ°æ–‡ä»¶
      const fs = require('fs');
      fs.writeFileSync(
        this.outputFile,
        JSON.stringify(stats, null, 2)
      );
    });

    // 5. å¤±è´¥å¤„ç†
    compiler.hooks.failed.tap('StatsPlugin', (error) => {
      console.error('âŒ Compilation failed:', error);
    });
  }
}

module.exports = StatsPlugin;

// ä½¿ç”¨ï¼š
// webpack.config.js
module.exports = {
  plugins: [
    new StatsPlugin({ outputFile: 'build-stats.json' })
  ]
};
```

---

## åä¸€ã€æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

**åˆå§‹åŒ–æµç¨‹ï¼ˆ9 æ­¥éª¤ï¼‰**ï¼š
```
1. è§„èŒƒåŒ–é…ç½®
2. åŸºç¡€é»˜è®¤å€¼
3. åˆ›å»º Compiler
4. Node ç¯å¢ƒæ’ä»¶
5. ç”¨æˆ·æ’ä»¶ â­â­â­ ï¼ˆè°ƒç”¨ applyï¼‰
6. å®Œæ•´é»˜è®¤å€¼
7. ç¯å¢ƒé’©å­
8. å†…ç½®æ’ä»¶ â­â­â­ ï¼ˆæ ¹æ®é…ç½®æ³¨å†Œï¼‰
9. åˆå§‹åŒ–å®Œæˆ
```

**æ’ä»¶å·¥ä½œåŸç†**ï¼š
```
1. å®ç° apply æ–¹æ³•
2. åœ¨ apply ä¸­æ³¨å†Œé’©å­ç›‘å¬å™¨
3. webpack è§¦å‘é’©å­æ—¶æ‰§è¡Œç›‘å¬å™¨
4. ç›‘å¬å™¨æ‰§è¡Œæ’ä»¶é€»è¾‘
```

**å…³é”®æ–‡ä»¶**ï¼š
- lib/webpack.jsï¼ˆä¸»æµç¨‹ï¼‰
- lib/Compiler.jsï¼ˆé’©å­ç³»ç»Ÿï¼‰
- lib/WebpackOptionsApply.jsï¼ˆå†…ç½®æ’ä»¶æ³¨å†Œï¼‰

**æ³¨æ„äº‹é¡¹**ï¼š
- æ’ä»¶æ³¨å†Œé¡ºåºå¾ˆé‡è¦
- ç”¨æˆ·æ’ä»¶åœ¨å†…ç½®æ’ä»¶ä¹‹å‰
- å¼‚æ­¥é’©å­å¿…é¡»è°ƒç”¨ callback
- ä¸è¦ä¿å­˜ compilation å¼•ç”¨

---

## é™„å½•ï¼šæ‰€æœ‰ç›¸å…³æ–‡ä»¶æ¸…å•

### æ ¸å¿ƒæ–‡ä»¶
- âœ… lib/webpack.jsï¼ˆå·²æ·»åŠ  100% æ³¨é‡Šï¼‰
- âœ… lib/Compiler.jsï¼ˆå·²æ·»åŠ  90% æ³¨é‡Šï¼‰
- âœ… lib/config/normalization.jsï¼ˆæœªæ³¨é‡Šï¼‰
- âœ… lib/config/defaults.jsï¼ˆæœªæ³¨é‡Šï¼‰
- âœ… lib/WebpackOptionsApply.jsï¼ˆæœªæ³¨é‡Šï¼‰

### æ’ä»¶æ–‡ä»¶ï¼ˆç¤ºä¾‹ï¼‰
- âœ… lib/EntryPlugin.jsï¼ˆæœªæ³¨é‡Šï¼‰
- âœ… lib/node/NodeEnvironmentPlugin.jsï¼ˆæœªæ³¨é‡Šï¼‰
- âœ… lib/javascript/JavascriptModulesPlugin.jsï¼ˆ20% æ³¨é‡Šï¼‰
- âœ… lib/optimize/SplitChunksPlugin.jsï¼ˆ90% æ³¨é‡Šï¼‰

---

**ç›¸å…³æ–‡æ¡£**ï¼š
- 02-æ ¸å¿ƒä»£ç æ³¨é‡Š-å¯åŠ¨æµç¨‹.mdï¼ˆè¯¦ç»†ä»£ç æ³¨é‡Šï¼‰
- 07-Compileré’©å­ç³»ç»Ÿè¯¦è§£.mdï¼ˆé’©å­è¯¦ç»†è¯´æ˜ï¼‰
- 04-Webpackæ ¸å¿ƒè¿è¡Œæµç¨‹è¯¦è§£.mdï¼ˆæ•´ä½“æµç¨‹ï¼‰

**æŸ¥çœ‹å·²æ·»åŠ æ³¨é‡Šçš„æºç **ï¼š
- lib/webpack.js: createCompiler()ï¼ˆ100% è¯¦ç»†æ³¨é‡Šï¼‰
- lib/Compiler.js: constructor()ï¼ˆ100% è¯¦ç»†æ³¨é‡Šï¼‰
